<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Generador de Documentos - Estatus de Solicitud</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>

    <style>
        /* Estilos Base Existentes */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 850px;
            margin: 0 auto;
            padding: 25px;
            background-color: #f4f4f9;
            position: relative;
            padding-bottom: 100px;
        }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 25px; }
        .input-group, .form-section { background-color: #ffffff; padding: 20px; margin-bottom: 25px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h2 { color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 5px; margin-bottom: 15px; }
        label { display: block; margin-top: 10px; font-weight: bold; color: #555; }
        input[type="text"], input[type="date"], textarea, input[type="file"], input[type="password"], input[type="email"] {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .date-container { display:flex; justify-content:space-between; gap:10px; }
        .date-container input { width:100%; }
        textarea { height:120px; resize:vertical; }
        .btn-action {
            background-color: #e67e22;
            color: white;
            padding: 15px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        .btn-action:hover { background-color: #d35400; }
        .back-button { background-color: #95a5a6; width:auto; padding:10px 15px; font-size:1em; }
        
        /* Estilos de Control de Vistas */
        .form-section, #main-menu { display:none; }
        #app-container { min-height: 500px; } /* Asegura espacio para la vista inicial */
        
        .status-page { text-align:center; padding:50px; background-color:#fff; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.1); min-height:250px; display:flex; flex-direction:column; justify-content:center; }
        .status-page .spinner { border:5px solid #f3f3f3; border-top:5px solid #3498db; border-radius:50%; width:50px; height:50px; animation: spin 2s linear infinite; margin:20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-download-now { background-color:#27ae60; margin-top:20px; width:50%; margin:20px auto; }
        .payment-notice { background-color:#eaf7ff; color:#2980b9; padding:10px; border:1px solid #3498db; border-radius:4px; margin-bottom:15px; text-align:center; font-weight:bold; font-size:0.95em; }
        .disclaimer-notice { background-color:#fcebeb; color:#c0392b; padding:10px; border:1px solid #c0392b; border-radius:4px; margin-bottom:20px; text-align:center; font-weight:bold; font-size:0.85em; }
        .whatsapp-float { position:fixed; width:60px; height:60px; bottom:40px; left:20px; background-color:#25d366; color:#fff; border-radius:50px; text-align:center; font-size:30px; box-shadow:2px 2px 3px #999; z-index:100; display:flex; align-items:center; justify-content:center; text-decoration:none;}
        .whatsapp-float:hover { background-color:#128c7e; }
        .fixed-payment-info { position:fixed; bottom:0; right:0; background-color:#34495e; color:white; padding:10px 15px; border-top-left-radius:8px; font-size:0.85em; z-index:99; text-align:right; max-width:350px; }
        .fixed-payment-info strong { color:#f1c40f; }
        .fixed-payment-info p { margin:2px 0; }
        .request-item, .client-item { border:1px solid #ccc; padding:10px; margin-bottom:10px; background-color:#fff; display:flex; justify-content:space-between; align-items:center; }
        .request-actions button { width:auto; padding:8px 12px; font-size:0.9em; margin-left:10px; }
        .btn-authorize { background-color:#3498db; color:#fff; border:none; padding:8px 10px; border-radius:4px; cursor:pointer; }
        .btn-reject { background-color:#c0392b; color:#fff; border:none; padding:8px 10px; border-radius:4px; cursor:pointer; }
        .download-link-box { background-color:#f0f0f0; border:1px dashed #3498db; padding:10px; margin-top:10px; word-break:break-all; font-size:0.9em; }
        input[type="file"] { padding:6px 10px; }

        /* Estilos de Grid y Men√∫ */
        .icon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 10px;
            margin-bottom: 25px;
        }
        .menu-card {
            background-color: #ffffff;
            color: #34495e;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 120px; 
            border: 1px solid #eee;
        }
        .menu-card:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 15px rgba(0,0,0,0.25);
        }
        .menu-card i {
            font-size: 2.5em;
            margin-bottom: 8px;
            transition: color 0.3s ease;
        }
        .menu-card strong {
            font-size: 0.9em;
            font-weight: bold;
            display: block;
            line-height: 1.3;
        }

        /* Colores espec√≠ficos para las categor√≠as */
        .category-social i { color: #25d366; }
        .category-carta i { color: #e67e22; }
        .category-receta i { color: #27ae60; }
        .category-certificado i { color: #3498db; }
        .category-especializado i { color: #9b59b6; }
        
        .category-social:hover i { color: #128c7e; }
        .category-carta:hover i { color: #d35400; }
        .category-receta:hover i { color: #1e8449; }
        .category-certificado:hover i { color: #2980b9; }
        .category-especializado:hover i { color: #8e44ad; }
        
        /* Estilos para el log de actividad */
        #activity-log-display {
            max-height: 300px;
            overflow-y: scroll;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f9f9f9;
        }
        .log-entry {
            border-bottom: 1px dashed #eee;
            padding: 5px 0;
            font-size: 0.85em;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>

    <h1>üìù Generador de Documentos y Solicitudes</h1>

    <div class="disclaimer-notice">
        *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
    </div>

    <div id="app-container">

        <div id="auth-splash" class="form-section" style="display:block;">
            <h2>üë§ Acceso Requerido</h2>
            <p>Inicie sesi√≥n para acceder al men√∫ de servicios, o reg√≠strese si es un usuario nuevo.</p>

            <div id="login-form" class="input-group">
                <h3>Iniciar Sesi√≥n</h3>
                <label for="loginUser">Correo Electr√≥nico:</label>
                <input type="email" id="loginUser" placeholder="Correo electr√≥nico">
                <label for="loginPass">Contrase√±a:</label>
                <input type="password" id="loginPass" placeholder="Ingrese su contrase√±a">
                <button class="btn-action" style="background-color:#2c3e50;" onclick="authenticateUser()">Iniciar Sesi√≥n</button>
            </div>
            
            <div class="input-group">
                <h3>¬øNo tiene cuenta?</h3>
                <p>Reg√≠strese y espere la autorizaci√≥n del administrador.</p>
                <button class="btn-action back-button" style="background-color: #3498db;" onclick="showForm('register')">Reg√≠strarme Ahora</button>
            </div>
        </div>
        <div id="form-register" class="form-section">
            <button class="back-button" onclick="showForm('auth_splash')">‚Üê Volver al Acceso</button>
            <h2>üìù Registro de Nuevo Usuario</h2>
            <p>Complete los datos. Su cuenta quedar√° en estado <strong>PENDIENTE</strong> hasta que el administrador la apruebe.</p>
            <div class="input-group">
                <label for="regName">Nombre Completo:</label>
                <input type="text" id="regName" placeholder="Su nombre completo" required>
                <label for="regUser">Correo Electr√≥nico (Ser√° su Usuario):</label>
                <input type="email" id="regUser" placeholder="Ingrese su email" required>
                <label for="regPass">Contrase√±a:</label>
                <input type="password" id="regPass" placeholder="Cree una contrase√±a" required>
                <button class="btn-action" style="background-color:#27ae60;" onclick="registerUser()">Registrar Solicitud de Cuenta</button>
            </div>
        </div>
        <div id="main-menu">
            
            <h2>üåê Acceso a Grupo y Soporte</h2>
            <div class="icon-grid">
                <div class="menu-card category-social" onclick="showForm('whatsapp_group')">
                    <i class="fab fa-whatsapp"></i>
                    <strong>Unirse a nuestro Grupo de WhatsApp</strong>
                </div>
            </div>
            
            <hr/>
            <h2>‚úâÔ∏è Cartas de Recomendaci√≥n</h2>
            <div class="icon-grid">
                <div class="menu-card category-carta" onclick="showForm('laboral')">
                    <i class="fas fa-briefcase"></i>
                    <strong>Carta LABORAL</strong>
                </div>
                <div class="menu-card category-carta" onclick="showForm('personal')">
                    <i class="fas fa-user-friends"></i>
                    <strong>Carta PERSONAL</strong>
                </div>
            </div>

            <hr/>
            
            <h2>üíä Documentos M√©dicos y Recetas</h2>
            <div class="icon-grid">
                <div class="menu-card category-receta" onclick="showForm('incapacidad_imss')">
                    <i class="fas fa-user-minus"></i>
                    <strong>Incapacidad IMSS</strong>
                </div>
                <div class="menu-card category-receta" onclick="showForm('receta_similares')">
                    <i class="fas fa-prescription-bottle-alt"></i>
                    <strong>Receta SIMILARES</strong>
                </div>
                <div class="menu-card category-receta" onclick="showForm('receta_ahorro')">
                    <i class="fas fa-pills"></i>
                    <strong>Receta DEL AHORRO</strong>
                </div>
                <div class="menu-card category-receta" onclick="showForm('certificado_medico_imss')">
                    <i class="fas fa-notes-medical"></i>
                    <strong>Certificado M√©dico IMSS</strong>
                </div>
            </div>

            <hr/>
            
            <h2>üéì Certificados de Estudios</h2>
            <div class="icon-grid">
                <div class="menu-card category-certificado" onclick="showForm('cert_primaria')">
                    <i class="fas fa-child"></i>
                    <strong>Certificado PRIMARIA</strong>
                </div>
                <div class="menu-card category-certificado" onclick="showForm('cert_secundaria')">
                    <i class="fas fa-graduation-cap"></i>
                    <strong>Certificado SECUNDARIA</strong>
                </div>
                <div class="menu-card category-certificado" onclick="showForm('cert_prepa')">
                    <i class="fas fa-university"></i>
                    <strong>Certificado PREPARATORIA</strong>
                </div>
            </div>

            <hr/>
            
            <h2>‚≠ê Servicios Especializados</h2>
            <div class="icon-grid">
                <div class="menu-card category-especializado" onclick="showForm('metodo_shein')">
                    <i class="fas fa-shopping-bag"></i>
                    <strong>Metodo Shein</strong>
                </div>
                <div class="menu-card category-especializado" onclick="showForm('metodo_cinepolis')">
                    <i class="fas fa-film"></i>
                    <strong>Metodo Cin√©polis</strong>
                </div>
                <div class="menu-card category-especializado" onclick="showForm('metodo_temu')">
                    <i class="fas fa-gift"></i>
                    <strong>Metodo TEMU</strong>
                </div>
                <div class="menu-card category-especializado" onclick="showForm('cv_desde_cero')">
                    <i class="fas fa-file-alt"></i>
                    <strong>CV DESDE CERO</strong>
                </div>
                <div class="menu-card category-especializado" onclick="showForm('sellos_personales')">
                    <i class="fas fa-stamp"></i>
                    <strong>SELLOS PERSONALES</strong>
                </div>
                <div class="menu-card category-especializado" onclick="showForm('formato_solicitud_pdf')">
                    <i class="fas fa-file-pdf"></i>
                    <strong>FORMATO DE SOLICITUD</strong>
                </div>
            </div>
            
            <hr/>

            <button class="btn-action back-button" style="margin-top:10px;" onclick="logOut()">Cerrar Sesi√≥n</button>

        </div>
        <div id="admin-dashboard" class="form-section">
            <button class="back-button" onclick="logOut()">‚Üê Cerrar Sesi√≥n</button>
            <h2>‚öôÔ∏è Panel de Administrador</h2>

            <h3>Clientes Registrados (Autorizaci√≥n)</h3>
            <div id="client-authorization-list" class="input-group">
                <p id="no-clients-msg">Cargando lista de clientes...</p>
            </div>
            
            <h3>Registro de Actividad del √öltimo Cliente Seleccionado</h3>
            <div id="activity-log-display" class="input-group">
                <p>Seleccione un cliente para ver su actividad detallada.</p>
            </div>

            <h3>Solicitudes de Documentos Pendientes</h3>
            <p>Al autorizar, el cliente ver√° autom√°ticamente el bot√≥n de descarga en su p√°gina de espera.</p>
            <div id="pending-requests-list" class="input-group">
                <p id="no-requests-msg">No hay solicitudes pendientes.</p>
            </div>
        </div>
        <div id="form-receta_similares" class="form-section">
            <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>

            <div class="disclaimer-notice">
                *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
            </div>
            <div class="payment-notice">
                *PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*
            </div>

            <h2>üíä Formulario de Receta M√©dica SIMILARES</h2>
            <div class="input-group">
                <h2>üë®‚Äç‚öïÔ∏è Datos del M√©dico y Emisi√≥n</h2>
                <label for="doctorNombreSimilares">Nombre del M√©dico (Ej: Dr. DUARTE ABDALA MARIO RAFAEL):</label>
                <input type="text" id="doctorNombreSimilares" value="DR. ROGER GUITIERREZ SALAZAR">

                <label for="cedulaSimilares">C√©dula Profesional / Prof. / Especialidad:</label>
                <input type="text" id="cedulaSimilares" value="MEDICO CIRUJANO  CED. PROF. 98569946">

                <label for="direccionSimilares">Direcci√≥n del Consultorio (Ej: AV. PDTE...):</label>
                <input type="text" id="direccionSimilares" value="#30 av. Luis Donaldo Colosio">

                <label for="ciudadSimilares">Ciudad (Ej: CIUDAD DE M√âXICO):</label>
                <input type="text" id="ciudadSimilares" value="CIUDAD DE M√âXICO">

                <label for="fechaEmisionSimilares">Fecha de Emisi√≥n de la Receta:</label>
                <input type="date" id="fechaEmisionSimilares" value="">

                <label for="logoInputSimilares">Insertar Logo de la Instituci√≥n/Receta (Opcional):</label>
                <input type="file" id="logoInputSimilares" accept="image/*">
            </div>

            <div class="input-group">
                <h2>üë§ Datos del Paciente</h2>
                <label for="nombrePacienteSimilares">Nombre(s) del Paciente:</label>
                <input type="text" id="nombrePacienteSimilares" value="CRISTOPHER ORLANDO RAMIREZ">

                <div class="date-container">
                    <div>
                        <label for="apellidoPSimilares">Apellido Paterno:</label>
                        <input type="text" id="apellidoPSimilares" value="RAMIREZ">
                    </div>
                    <div>
                        <label for="apellidoMSimilares">Apellido Materno:</label>
                        <input type="text" id="apellidoMSimilares" value="">
                    </div>
                </div>

                <div class="date-container">
                    <div>
                        <label for="sexoSimilares">Sexo (Ej: MASCULINO):</label>
                        <input type="text" id="sexoSimilares" value="MASCULINO">
                    </div>
                    <div>
                        <label for="edadSimilares">Edad:</label>
                        <input type="text" id="edadSimilares" value="6 A√ëOS">
                    </div>
                </div>

                <div class="date-container">
                    <div>
                        <label for="fechaNacSimilares">Fecha de Nacimiento (Para la receta):</label>
                        <input type="date" id="fechaNacSimilares" value="2019-07-18">
                    </div>
                    <div>
                        <label for="alergiasSimilares">Alergias (Ej: NEGADAS):</label>
                        <input type="text" id="alergiasSimilares" value="NEGADAS">
                    </div>
                </div>
            </div>

            <div class="input-group">
                <h2>üìà Signos Vitales y Medidas</h2>
                <div class="date-container">
                    <div>
                        <label for="spo2Similares">T.A. (Ej: 100/72MM/Hg):</label>
                        <input type="text" id="spo2Similares" value="100/72MM/Hg">
                    </div>
                    <div>
                        <label for="fcSimilares">TEMP (Ej: 36.5¬∞):</label>
                        <input type="text" id="fcSimilares" value="36.5¬∞">
                    </div>
                </div>
                <div class="date-container">
                    <div>
                        <label for="frSimilares">F.C X MIN:</label>
                        <input type="text" id="frSimilares" value="MIN">
                    </div>
                    <div>
                        <label for="tempSimilares">PESO (Ej: 25KG):</label>
                        <input type="text" id="tempSimilares" value="25KG">
                    </div>
                </div>
                <div class="date-container">
                    <div>
                        <label for="pesoSimilares">F.R X MIN:</label>
                        <input type="text" id="pesoSimilares" value="MIN">
                    </div>
                    <div>
                        <label for="tallaSimilares">TALLA:</label>
                        <input type="text" id="tallaSimilares" value="6">
                    </div>
                </div>
                <label for="dxSimilares">Diagn√≥stico/Motivo de Consulta:</label>
                <input type="text" id="dxSimilares" value="INSOLACI√ìN Y DOLOR ESTOMACAL">
            </div>

            <div class="input-group">
                <h2>üìù Contenido de la Receta</h2>
                <label for="contenidoConsultaSimilares">Contenido de la Consulta (Texto):</label>
                <textarea id="contenidoConsultaSimilares">Paciente acude a consulta m√©dica con dolor abdominal, diarrea con episodios agudos y malestar general. Sin presentar fiebre.</textarea>

                <label for="tratamientoSimilares">TRATAMIENTO (Una l√≠nea por medicamento):</label>
                <textarea id="tratamientoSimilares">1.- AMBROXOL 3.2GR/100ML JARABE 120 ML
1 CD 12 HRS DURANTE 7D ORAL
2.- PARACETAMOL 40MG/1ML SUSPENSION 15 ML
1 CD 12 HRS DURANTE 5D ORAL</textarea>

                <label for="indicacionesGeneralesSimilares">Indicaciones Generales:</label>
                <textarea id="indicacionesGeneralesSimilares">Reposo m√≠nimo de 2-3 d√≠as</textarea>

                <label for="proximaCitaSimilares">Pr√≥xima Cita (Fecha):</label>
                <input type="text" id="proximaCitaSimilares" value="27/03/2021">

                <label for="firmaInputSimilares">Firma del M√©dico (Opcional, NO colocada autom√°ticamente si la sube):</label>
                <input type="file" id="firmaInputSimilares" accept="image/*">
            </div>

            <button class="btn-action" onclick="saveSolicitud('receta_similares')">üíæ Guardar Solicitud (Esperar Aprobaci√≥n)</button>
        </div>

        <div id="form-incapacidad_imss" class="form-section">
            <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>
            <div class="disclaimer-notice">*NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO*</div>
            <div class="payment-notice">*PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*</div>
            <h2>üíä Formulario de Incapacidad IMSS</h2>
            <div class="input-group">
                <p>‚ö†Ô∏è **FORMULARIO PENDIENTE:** Agregue los campos espec√≠ficos para la Incapacidad IMSS aqu√≠.</p>
                <label for="placeholder1_incapacidad">Ejemplo de Campo (a borrar):</label>
                <input type="text" id="placeholder1_incapacidad" value="">
            </div>
            <button class="btn-action" onclick="saveSolicitud('incapacidad_imss')">üíæ Guardar Solicitud</button>
        </div>

        <div id="form-certificado_medico_imss" class="form-section">
            <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>

            <div class="disclaimer-notice">
                *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
            </div>
            <div class="payment-notice">
                *PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*
            </div>

            <h2>ü©∫ Certificado M√©dico IMSS</h2>

            <div class="input-group">
                <h3>üë®‚Äç‚öïÔ∏è Datos del M√©dico</h3>
                <label for="medicoCert">Nombre del M√©dico:</label>
                <input type="text" id="medicoCert" value="DRA. YESSICA MEJ√çA CARRANZA">
                <label for="cedulaCert">C√©dula Profesional:</label>
                <input type="text" id="cedulaCert" value="C.P. 5866652">
                <label for="unidadCert">Unidad M√©dica (encabezado):</label>
                <input type="text" id="unidadCert" value="UNIDAD M√âDICA FAMILIAR NO. UMF 67, SANTA CLARA ECATEPEC, ESTADO DE M√âXICO">
                <label for="consultorioCert">Consultorio:</label>
                <input type="text" id="consultorioCert" value="5">
                <label for="turnoCert">Turno:</label>
                <input type="text" id="turnoCert" value="VESPERTINO">
            </div>

            <div class="input-group">
                <h3>üë§ Datos del Paciente</h3>
                <label for="pacienteCert">Nombre Completo:</label>
                <input type="text" id="pacienteCert" value="CARMEN MORELOS HERN√ÅNDEZ">
                <label for="nssCert">N√∫mero de Seguro Social:</label>
                <input type="text" id="nssCert" value="1715950626-4">
                <label for="edadCert">Edad:</label>
                <input type="text" id="edadCert" value="30">
                <label for="sexoCert">Sexo:</label>
                <input type="text" id="sexoCert" value="FEMENINO">
            </div>

            <div class="input-group">
                <h3>üìã Antecedentes M√©dicos</h3>
                <label for="alergiasCert">Alergias:</label>
                <textarea id="alergiasCert">No presenta alergias de ning√∫n tipo.</textarea>
                <label for="cirugiasCert">Cirug√≠as:</label>
                <textarea id="cirugiasCert">No ha sido sometida a intervenciones quir√∫rgicas.</textarea>
                <label for="cronicasCert">Enfermedades Cr√≥nicas:</label>
                <textarea id="cronicasCert">Ninguna.</textarea>
                <label for="vacunasCert">Vacunas:</label>
                <textarea id="vacunasCert">Esquema de vacunaci√≥n al d√≠a conforme a las normativas vigentes.</textarea>
            </div>

            <div class="input-group">
                <h3>ü©∫ Examen F√≠sico General</h3>
                <textarea id="fisicoCert">Peso: 90.00kg
Talla: 1.40 mts
Frecuencia Cardiaca: 78 lpm
Presi√≥n Arterial: 110/76 mmHg
Frecuencia Respiratoria: 16 rpm
Temperatura Corporal: 36.7¬∞C
Tipo de sangre: O+</textarea>
            </div>

            <div class="input-group">
                <h3>ü´Å Sistemas</h3>
                <label for="respiratorioCert">Sistema Respiratorio:</label>
                <textarea id="respiratorioCert">Pulmones: Sin murmullo vesicular presente, sin ruidos agregados.</textarea>
                <label for="cardioCert">Sistema Cardiovascular:</label>
                <textarea id="cardioCert">Coraz√≥n: R√≠tmico, sin soplos ni ruidos patol√≥gicos.</textarea>
                <label for="digestivoCert">Sistema Digestivo:</label>
                <textarea id="digestivoCert">Abdomen: Blando, depresible, sin dolor a la palpaci√≥n.</textarea>
                <label for="neuroCert">Sistema Neurol√≥gico:</label>
                <textarea id="neuroCert">Reflejos: Conservados. Conciencia: Orientada en tiempo, espacio y persona.</textarea>
                <label for="osteoCert">Sistema Osteomuscular:</label>
                <textarea id="osteoCert">Columna: Sin desviaciones, postura adecuada. Extremidades: Con mucha fuerza y movilidad.</textarea>
                <label for="vistaCert">Examen de la Vista:</label>
                <textarea id="vistaCert">Agudeza Visual: 20/20 en ambos ojos sin correcci√≥n.
Visi√≥n de Colores: Normal, sin evidencia de daltonismo.
Campo Visual: Completo en ambos ojos.
Reflejo Pupilar: Reactivo a la luz, sin anormalidades.</textarea>
            </div>

            <div class="input-group">
                <h3>üßæ Conclusi√≥n</h3>
                <textarea id="conclusionCert">El paciente se encuentra en buenas condiciones de salud general, sin signos de enfermedades infecciosas, cr√≥nicas o agudas que comprometen su bienestar en la actualidad. Es apta para realizar actividades f√≠sicas sin restricciones.</textarea>

                <label for="firmaCert">Firma del M√©dico (opcional):</label>
                <input type="file" id="firmaCert" accept="image/*">

                <label for="fechaCert">Fecha de Expedici√≥n:</label>
                <input type="date" id="fechaCert">

            </div>

            <button class="btn-action" onclick="generateAndDownloadCertificadoIMSS()">üìÑ Generar Certificado M√©dico IMSS (PDF)</button>
        </div>
        </div>

    <div id="status-page" class="status-page" style="display:none;">
        <div class="disclaimer-notice">*NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*</div>
    </div>

    <a href="https://wa.me/message/AZLK65CETSPQL1" class="whatsapp-float" target="_blank" title="Soporte WhatsApp">
        <i class="fab fa-whatsapp"></i>
    </a>

    <div class="fixed-payment-info">
        <p>‚ö†Ô∏è **PAGO**</p>
        <p>*PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*</p>
    </div>

    <script>
        const { jsPDF } = window.jspdf;
        const STORAGE_KEY = 'pending_requests_list';
        const APPROVED_KEY = 'approved_requests_list';
        // üîë Nuevas claves para usuarios y actividad
        const REGISTERED_USERS_KEY = 'registered_app_users';
        const USER_ACTIVITY_KEY = 'user_activity_log';
        // üîë Credenciales de administrador fijas (Solo para el Admin)
        const ADMIN_USER = 'trollgaga999@gmail.com';
        const ADMIN_PASS = 'Johan207';
        // üîë Estado de la sesi√≥n
        let statusCheckInterval = null;
        let currentUser = null; // Variable global para el usuario logueado
        const CURRENT_USER_SESSION_KEY = 'current_user_session'; // CLAVE DE SESI√ìN A√ëADIDA

        // --- FUNCIONES DE GENERACI√ìN DE PDF (NUEVAS MODIFICACIONES) ---

        // Placeholder de Logo IMSS en Base64.
        // **DEBES REEMPLAZAR** esta cadena por el c√≥digo Base64 REAL de tu imagen del logo del IMSS.
        const IMSS_LOGO_BASE64 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAgCAYAAABgEny/AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAVUlEQVR42mP4//8/AyUYQjADZlA2QMBf/vV/GP6HwfgMABlZGBgYGDYgG+jPIGT4HwoqDMBYQyADiC4gV5NMAgqIDiB/xN/d5D4I5iF0A0iKAYcDAJ0eRz0I0oO1AAAAAElFTXgSCAACAEC'; 
        // Si usas tu imagen (Imagen de WhatsApp...), debes convertirla a Base64 y pegarla aqu√≠.

        /**
         * Funci√≥n auxiliar para obtener los datos del formulario del Certificado.
         * @returns {object|null} Los datos recolectados o null si falla la validaci√≥n.
         */
        function getMedicalCertificateIMSSData() {
            const data = {
                // Datos del M√©dico
                medico: document.getElementById('medicoCert').value || '',
                cedula: document.getElementById('cedulaCert').value || '',
                unidad: document.getElementById('unidadCert').value || '',
                consultorio: document.getElementById('consultorioCert').value || '',
                turno: document.getElementById('turnoCert').value || '',
                // Datos del Paciente
                paciente: document.getElementById('pacienteCert').value || '',
                nss: document.getElementById('nssCert').value || '',
                edad: document.getElementById('edadCert').value || '',
                sexo: document.getElementById('sexoCert').value || '',
                // Antecedentes M√©dicos
                alergias: document.getElementById('alergiasCert').value || '',
                cirugias: document.getElementById('cirugiasCert').value || '',
                cronicas: document.getElementById('cronicasCert').value || '',
                vacunas: document.getElementById('vacunasCert').value || '',
                // Examen F√≠sico General
                fisico: document.getElementById('fisicoCert').value || '',
                // Sistemas
                respiratorio: document.getElementById('respiratorioCert').value || '',
                cardio: document.getElementById('cardioCert').value || '',
                digestivo: document.getElementById('digestivoCert').value || '',
                neuro: document.getElementById('neuroCert').value || '',
                osteo: document.getElementById('osteoCert').value || '',
                vista: document.getElementById('vistaCert').value || '',
                // Conclusi√≥n y Firma
                conclusion: document.getElementById('conclusionCert').value || '',
                fecha: document.getElementById('fechaCert').value || new Date().toISOString().slice(0, 10),
                // Manejo de la Firma (Opcional)
                firmaFile: document.getElementById('firmaCert').files[0]
            };
            
            // Validaci√≥n m√≠nima
            if (!data.paciente || !data.medico || !data.unidad || !data.conclusion) {
                alert('Por favor, complete al menos el nombre del paciente, m√©dico, unidad y la conclusi√≥n para generar el certificado.');
                return null;
            }
            
            return data;
        }

        /**
         * Genera el Certificado M√©dico IMSS en formato PDF con las modificaciones solicitadas.
         * - Tama√±o de hoja: Carta
         * - Logo: Esquina superior izquierda
         * - T√≠tulo: Color verde
         * @returns {void}
         */
        async function generateAndDownloadCertificadoIMSS() {
            const data = getMedicalCertificateIMSSData();
            if (!data) return;
            
            // 1. Inicializar jsPDF con tama√±o 'letter' (carta) [MODIFICACI√ìN]
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'letter');
            
            const marginX = 15;
            let currentY = 15;
            const lineHeight = 6;
            const maxWidth = doc.internal.pageSize.width - (2 * marginX);

            // --- 2. LOGO IMSS (Esquina superior izquierda) [MODIFICACI√ìN] ---
            const logoX = marginX;
            const logoY = 10;
            const logoWidth = 40; // Ajuste el ancho seg√∫n su imagen
            const logoHeight = 20; // Ajuste el alto seg√∫n su imagen
            
            try {
                // Dibuja el logo en la esquina superior izquierda
                doc.addImage(IMSS_LOGO_BASE64, 'PNG', logoX, logoY, logoWidth, logoHeight);
            } catch (e) {
                console.error("Error al a√±adir el logo. Revise la constante IMSS_LOGO_BASE64.", e);
                // Marcador de posici√≥n en caso de error
                doc.rect(logoX, logoY, logoWidth, logoHeight);
                doc.setFontSize(8);
                doc.setTextColor(255, 0, 0);
                doc.text("Logo Missing", logoX + 2, logoY + 10);
                doc.setTextColor(0);
                doc.setFontSize(10);
            }
            
            // Mover el cursor inicial para que el texto principal comience debajo o a la derecha
            currentY = logoY + logoHeight + 5; 

            // --- Encabezado del M√©dico y Unidad (A la derecha del logo) ---
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text(`Unidad: ${data.unidad}`, logoX + logoWidth + 5, logoY + 5);
            doc.text(`Consultorio: ${data.consultorio}`, logoX + logoWidth + 5, logoY + 10);
            doc.text(`Turno: ${data.turno}`, logoX + logoWidth + 5, logoY + 15);
            
            // --- 3. T√≠tulo del Documento (Color Verde) [MODIFICACI√ìN] ---
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(18);
            doc.setTextColor('#28A745'); // Color verde (similar al IMSS)
            doc.text('CERTIFICADO M√âDICO', doc.internal.pageSize.width / 2, currentY, { align: 'center' });
            currentY += lineHeight;
            
            doc.setFontSize(12);
            doc.setTextColor(0); // Restablecer color a negro
            doc.setFont('helvetica', 'normal');
            doc.text('PARA FINES ESPEC√çFICOS', doc.internal.pageSize.width / 2, currentY, { align: 'center' });
            currentY += lineHeight * 2;
            
            // --- Separador ---
            doc.setLineWidth(0.5);
            doc.line(marginX, currentY - 3, doc.internal.pageSize.width - marginX, currentY - 3);

            // --- Datos del Paciente ---
            const tabX = marginX + 35; // Alineaci√≥n de valores
            doc.setFontSize(10);
            doc.setFont('helvetica', 'bold');
            doc.text('Nombre del Paciente:', marginX, currentY);
            doc.setFont('helvetica', 'normal');
            doc.text(data.paciente, tabX, currentY);

            doc.setFont('helvetica', 'bold');
            doc.text('NSS:', marginX + 80, currentY);
            doc.setFont('helvetica', 'normal');
            doc.text(data.nss, marginX + 100, currentY);

            currentY += lineHeight;

            doc.setFont('helvetica', 'bold');
            doc.text('Edad:', marginX, currentY);
            doc.setFont('helvetica', 'normal');
            doc.text(data.edad + ' a√±os', tabX, currentY);
            
            doc.setFont('helvetica', 'bold');
            doc.text('Sexo:', marginX + 80, currentY);
            doc.setFont('helvetica', 'normal');
            doc.text(data.sexo, marginX + 100, currentY);
            currentY += lineHeight * 2;

            // --- Secciones de Examen M√©dico y Contenido ---
            const sections = [
                { title: 'I. ANTECEDENTES M√âDICOS', content: [
                    { label: 'Alergias:', value: data.alergias },
                    { label: 'Cirug√≠as:', value: data.cirugias },
                    { label: 'Enf. Cr√≥nicas:', value: data.cronicas },
                    { label: 'Vacunas:', value: data.vacunas }
                ]},
                { title: 'II. EXAMEN F√çSICO Y SIGNOS VITALES', content: [{ label: 'General:', value: data.fisico }]},
                { title: 'III. VALORACI√ìN POR SISTEMAS', content: [
                    { label: 'Respiratorio:', value: data.respiratorio },
                    { label: 'Cardiovascular:', value: data.cardio },
                    { label: 'Digestivo:', value: data.digestivo },
                    { label: 'Neurol√≥gico:', value: data.neuro },
                    { label: 'Osteomuscular:', value: data.osteo },
                    { label: 'Visi√≥n:', value: data.vista }
                ]},
            ];

            doc.setFontSize(10);

            sections.forEach(section => {
                if (currentY > doc.internal.pageSize.height - 50) { // Salto de p√°gina preventivo
                    doc.addPage();
                    currentY = 15;
                }
                
                doc.setFont('helvetica', 'bold');
                doc.text(section.title, marginX, currentY);
                currentY += lineHeight;

                section.content.forEach(item => {
                    doc.setFont('helvetica', 'bold');
                    doc.text(item.label, marginX + 5, currentY);
                    doc.setFont('helvetica', 'normal');
                    
                    // Calculo para el inicio del texto de contenido
                    const labelWidth = doc.getStringUnitWidth(item.label) * doc.internal.getFontSize() / doc.internal.scaleFactor;
                    const textStartX = marginX + 5 + labelWidth + 3;
                    
                    // Dividir y envolver el texto de contenido
                    const contentLines = doc.splitTextToSize(item.value, maxWidth - (textStartX - marginX));
                    
                    // Imprimir la primera l√≠nea en la posici√≥n actual, el resto debajo
                    doc.text(contentLines, textStartX, currentY);
                    
                    currentY += (contentLines.length * lineHeight); // Mover Y por el n√∫mero de l√≠neas
                });
                currentY += lineHeight; // Espacio entre secciones
            });
            
            // --- IV. CONCLUSI√ìN M√âDICA ---
            if (currentY > doc.internal.pageSize.height - 50) { 
                doc.addPage();
                currentY = 15;
            }
            
            doc.setFont('helvetica', 'bold');
            doc.text('IV. CONCLUSI√ìN M√âDICA', marginX, currentY);
            currentY += lineHeight;

            doc.setFont('helvetica', 'normal');
            const conclusionLines = doc.splitTextToSize(data.conclusion, maxWidth);
            doc.text(conclusionLines, marginX, currentY);
            currentY += (conclusionLines.length * lineHeight) + lineHeight;
            
            // --- Pie de P√°gina (Lugar y Fecha) ---
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            
            // Formatear la fecha y texto
            const dateObj = new Date(data.fecha + 'T12:00:00');
            doc.text(`Se expide el presente certificado a solicitud del interesado en ${data.unidad.split(',')[0].trim()} a los ${dateObj.getDate()} d√≠as del mes de ${dateObj.toLocaleDateString('es-MX', { month: 'long' })} de ${dateObj.getFullYear()}.`, marginX, currentY);
            currentY += lineHeight * 2;

            // --- Firma del M√©dico ---
            const signatureY = currentY + 30; // Posici√≥n de la l√≠nea de firma
            doc.setFont('helvetica', 'bold');

            // Manejo as√≠ncrono de la firma (si se subi√≥ un archivo)
            if (data.firmaFile) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    const firmaBase64 = event.target.result;
                    const firmaWidth = 50;
                    const firmaHeight = 25;
                    const firmaX = doc.internal.pageSize.width / 2 - firmaWidth / 2;
                    try {
                        // Dibuja la firma
                        doc.addImage(firmaBase64, 'JPEG', firmaX, currentY + 5, firmaWidth, firmaHeight);
                    } catch (err) {
                        console.error("Error al a√±adir la firma: ", err);
                    }
                    
                    // Dibuja la l√≠nea y datos del m√©dico
                    doc.text('_____________________________________', doc.internal.pageSize.width / 2, signatureY, { align: 'center' });
                    doc.text(`${data.medico}`, doc.internal.pageSize.width / 2, signatureY + lineHeight, { align: 'center' });
                    doc.text(`C√©dula Prof. ${data.cedula}`, doc.internal.pageSize.width / 2, signatureY + lineHeight * 2, { align: 'center' });

                    // Guardar PDF
                    doc.save(`Certificado_Medico_IMSS_${data.paciente.replace(/\s/g, '_')}.pdf`);
                };
                reader.readAsDataURL(data.firmaFile);
            } else {
                // Dibuja la l√≠nea y datos del m√©dico (sin imagen de firma)
                doc.text('_____________________________________', doc.internal.pageSize.width / 2, signatureY, { align: 'center' });
                doc.text(`${data.medico}`, doc.internal.pageSize.width / 2, signatureY + lineHeight, { align: 'center' });
                doc.text(`C√©dula Prof. ${data.cedula}`, doc.internal.pageSize.width / 2, signatureY + lineHeight * 2, { align: 'center' });

                // Guardar PDF
                doc.save(`Certificado_Medico_IMSS_${data.paciente.replace(/\s/g, '_')}.pdf`);
            }
        }


        function getBaseUrl() {
            return window.location.href.split('#')[0];
        }

        const viewIdMap = {
            'auth_splash': 'auth-splash', // Nueva pantalla de inicio
            'register': 'form-register', // Nuevo formulario de registro
            'menu': 'main-menu',
            'laboral': 'form-laboral',
            'personal': 'form-personal',
            'admin_dashboard': 'admin-dashboard',
            'incapacidad_imss': 'form-incapacidad_imss',
            'receta_similares': 'form-receta_similares',
            'receta_ahorro': 'form-receta_ahorro',
            'receta_imss': 'form-receta_imss',
            'cert_primaria': 'form-cert_primaria',
            'cert_secundaria': 'form-cert_secundaria',
            'cert_prepa': 'form-cert_prepa',
            'metodo_shein': 'form-metodo_shein',
            'metodo_cinepolis': 'form-metodo_cinepolis',
            'metodo_temu': 'form-metodo_temu',
            'cv_desde_cero': 'form-cv_desde_cero',
            'sellos_personales': 'form-sellos_personales',
            'formato_solicitud_pdf': 'formato_solicitud_pdf',
            'certificado_medico_imss': 'form-certificado_medico_imss'
        };

        function showForm(viewId, pushHistory = true) {
            // Verifica el estado de autenticaci√≥n para todas las vistas que no son de auth/register
            const requiresAuth = !['auth_splash', 'register', 'status', 'whatsapp_group'].includes(viewId);
            const isMenuOrService = viewId === 'menu' || viewIdMap[viewId]?.startsWith('form-');
            const isDashboard = viewId === 'admin_dashboard';
            
            if (requiresAuth && !currentUser) {
                alert("Debe iniciar sesi√≥n para acceder a este contenido.");
                viewId = 'auth_splash';
            } else if (isDashboard && (!currentUser || currentUser.user !== ADMIN_USER)) {
                alert("Acceso denegado. Solo el administrador puede ver el panel.");
                viewId = 'menu';
            }

            const sections = Object.values(viewIdMap);
            sections.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.style.display = 'none';
            });

            const targetId = viewIdMap[viewId] || viewId;
            const viewElement = document.getElementById(targetId);

            if (viewId === 'whatsapp_group') {
                window.open('https://chat.whatsapp.com/GbkvIbPwCRX1JacpJJOS9D', '_blank');
                logActivity(currentUser?.user || 'anon', 'VIEW_WHATSAPP_GROUP');
                return;
            }

            if (viewElement) {
                viewElement.style.display = 'block';
                window.scrollTo(0, 0);
                if (pushHistory) {
                    let url = getBaseUrl();
                    let state = { viewId: viewId };
                    if (viewId !== 'menu') { url += `#${viewId}`; } else { url = getBaseUrl(); }
                    history.pushState(state, '', url);
                }
                
                // Registro de actividad (solo si no es auth/register/status)
                if (isMenuOrService) {
                    logActivity(currentUser.user, viewId === 'menu' ? 'ACCESS_MENU' : `VIEW_FORM:${viewId}`);
                }
                if (isDashboard) {
                    logActivity(currentUser.user, 'ACCESS_ADMIN_DASHBOARD');
                    loadAdminDashboard();
                }
            }
        }

        // --- MANEJO DE SESI√ìN PERSISTENTE (NUEVAS FUNCIONES) ---

        function saveSession(userObj) {
            try {
                localStorage.setItem(CURRENT_USER_SESSION_KEY, JSON.stringify(userObj));
            } catch (e) {
                console.error("Error saving session to localStorage", e);
            }
        }

        function loadSession() {
            try {
                const storedUser = localStorage.getItem(CURRENT_USER_SESSION_KEY);
                if (storedUser) {
                    currentUser = JSON.parse(storedUser);
                    return true;
                }
            } catch (e) {
                console.error("Error loading session from localStorage", e);
            }
            return false;
        }

        // --- CONFIRMACI√ìN AL SALIR O VOLVER ATR√ÅS ---
        window.addEventListener('popstate', (e) => {
            const state = history.state;
            // Solo preguntar si hay sesi√≥n activa y se intenta salir del men√∫ o formularios
            if (currentUser && (!state || !state.viewId || state.viewId === 'auth_splash')) {
                const salir = confirm("‚ö†Ô∏è ¬øEst√° seguro de que desea cerrar sesi√≥n y salir de los servicios?");
                if (salir) {
                    logOut();
                } else {
                    // Mantener la vista actual si cancela
                    history.pushState({ viewId: 'menu' }, '', '#menu');
                    showForm('menu', false);
                }
                return;
            }

            // Si no hay sesi√≥n activa, ir al acceso normal
            if (!state) { 
                showForm('auth_splash', false); 
                return; 
            }

            // Si hay estado previo, mostrar esa vista
            showForm(state.viewId || 'auth_splash', false);
        });

        // --- FUNCIONES DE ALMACENAMIENTO (USERS & ACTIVITY) ---

        function getRegisteredUsers() {
            const data = localStorage.getItem(REGISTERED_USERS_KEY);
            return data ? JSON.parse(data) : [];
        }
        function saveRegisteredUsers(users) {
            localStorage.setItem(REGISTERED_USERS_KEY, JSON.stringify(users));
        }
        
        function getActivityLog() {
            const data = localStorage.getItem(USER_ACTIVITY_KEY);
            return data ? JSON.parse(data) : [];
        }
        function saveActivityLog(log) {
            localStorage.setItem(USER_ACTIVITY_KEY, JSON.stringify(log));
        }

        function logActivity(userIdentifier, action) {
            if (!userIdentifier) userIdentifier = 'ANONIMO';
            
            const log = getActivityLog();
            const newEntry = {
                user: userIdentifier,
                action: action,
                timestamp: new Date().toLocaleString()
            };
            log.push(newEntry);
            saveActivityLog(log);
        }

        // --- FUNCIONES DE AUTENTICACI√ìN Y REGISTRO ---

        function registerUser() {
            const name = document.getElementById('regName').value.trim();
            const user = document.getElementById('regUser').value.trim();
            const pass = document.getElementById('regPass').value;

            if (!name || !user || !pass) {
                alert("Por favor, complete todos los campos.");
                return;
            }
            if (!user.includes('@') || user.length < 5) {
                alert("Ingrese un correo electr√≥nico v√°lido.");
                return;
            }

            const users = getRegisteredUsers();
            if (users.some(u => u.user === user)) {
                alert("Error: El correo electr√≥nico ya est√° registrado o en proceso de autorizaci√≥n.");
                return;
            }

            const newUser = {
                name: name,
                user: user,
                pass: pass,
                status: 'pending', // Clave: debe ser autorizado
                timestamp: new Date().toLocaleDateString()
            };

            users.push(newUser);
            saveRegisteredUsers(users);

            // Limpiar campos
            document.getElementById('regName').value = '';
            document.getElementById('regUser').value = '';
            document.getElementById('regPass').value = '';

            logActivity(user, 'REGISTER_REQUESTED');
            alert("¬°Solicitud de registro exitosa! Su cuenta est√° PENDIENTE de autorizaci√≥n por el administrador. Le avisaremos cuando pueda iniciar sesi√≥n.");
            showForm('auth_splash');
        }

        function authenticateUser() {
            const user = document.getElementById('loginUser').value;
            const pass = document.getElementById('loginPass').value;

            // 1. Check against hardcoded ADMIN
            if (user === ADMIN_USER && pass === ADMIN_PASS) {
                currentUser = {
                    user: user,
                    name: 'ADMIN',
                    status: 'authorized',
                    isAdmin: true
                };
                saveSession(currentUser); // <--- SESI√ìN GUARDADA
                logActivity(user, 'ADMIN_LOGIN_SUCCESS');
                alert("¬°Bienvenido, Administrador! Accediendo al Panel de Control.");
                showForm('admin_dashboard');
                return;
            }

            // 2. Check against registered standard users
            const registeredUsers = getRegisteredUsers();
            const foundUser = registeredUsers.find(u => u.user === user && u.pass === pass);

            if (foundUser) {
                if (foundUser.status === 'pending') {
                    alert(`Acceso denegado: Su cuenta est√° pendiente de autorizaci√≥n por el administrador.`);
                    logActivity(user, 'LOGIN_FAIL:PENDING');
                    return;
                }
                
                // Usuario autorizado
                currentUser = foundUser;
                saveSession(currentUser); // <--- SESI√ìN GUARDADA
                logActivity(user, 'USER_LOGIN_SUCCESS');
                alert(`¬°Bienvenido, ${foundUser.name}! Acceso completado.`);
                showForm('menu');
                return;
            }

            // If neither is found
            logActivity(user, 'LOGIN_FAIL:INVALID_CREDENTIALS');
            alert("Usuario o Contrase√±a incorrectos. Si no tiene cuenta, por favor reg√≠strese.");
        }

        function logOut() {
            if(currentUser) {
                logActivity(currentUser.user, 'LOGOUT');
            }
            currentUser = null;
            localStorage.removeItem(CURRENT_USER_SESSION_KEY); // <--- SESI√ìN ELIMINADA
            document.getElementById('loginUser').value = '';
            document.getElementById('loginPass').value = '';
            showForm('auth_splash');
        }

        // --- FUNCIONES DEL ADMINISTRADOR ---

        function loadAdminDashboard() {
            // Cargar solicitudes pendientes (l√≥gica existente)
            loadPendingRequests();
            // Cargar clientes registrados (nueva l√≥gica)
            loadRegisteredClients();
            // Limpiar log de actividad al cargar
            document.getElementById('activity-log-display').innerHTML = '<p>Seleccione un cliente para ver su actividad detallada.</p>';
        }

        function loadRegisteredClients() {
            const users = getRegisteredUsers();
            const listElement = document.getElementById('client-authorization-list');
            listElement.innerHTML = '';

            if (users.length === 0) {
                listElement.innerHTML = '<p>No hay clientes registrados.</p>';
                return;
            }

            users.forEach(user => {
                const statusColor = user.status === 'authorized' ? '#27ae60' : '#e67e22';
                const item = document.createElement('div');
                item.id = `client-${user.user.replace(/[^a-zA-Z0-9]/g, '-')}`;
                item.className = 'client-item';
                item.innerHTML = `
                    <div class="client-info">
                        <strong>${user.name}</strong>
                        <p>Email: ${user.user}</p>
                        <p style="font-size:0.9em;">Estado: <strong style="color:${statusColor};">${user.status.toUpperCase()}</strong></p>
                    </div>
                    <div class="client-actions request-actions">
                        <button class="btn-authorize" ${user.status === 'authorized' ? 'disabled' : ''} onclick="authorizeUser('${user.user}')">Autorizar</button>
                        <button class="back-button" onclick="viewUserActivity('${user.user}')">Ver Actividad</button>
                        <button class="btn-reject" onclick="deleteUser('${user.user}')">Eliminar</button>
                    </div>
                `;
                listElement.appendChild(item);
            });
        }

        function authorizeUser(userEmail) {
            if (!confirm(`¬øEst√° seguro de AUTORIZAR al usuario ${userEmail}?`)) return;

            const users = getRegisteredUsers();
            const index = users.findIndex(u => u.user === userEmail);

            if (index > -1) {
                users[index].status = 'authorized';
                saveRegisteredUsers(users);
                logActivity(ADMIN_USER, `AUTHORIZE_USER:${userEmail}`);
                alert(`Usuario ${userEmail} autorizado. Ya puede iniciar sesi√≥n.`);
                loadRegisteredClients();
            } else {
                alert("Error: Usuario no encontrado.");
            }
        }

        function deleteUser(userEmail) {
            if (!confirm(`¬øEst√° seguro de ELIMINAR al usuario ${userEmail}? Esta acci√≥n es permanente.`)) return;

            let users = getRegisteredUsers();
            const initialLength = users.length;
            users = users.filter(u => u.user !== userEmail);

            if (users.length < initialLength) {
                saveRegisteredUsers(users);
                logActivity(ADMIN_USER, `DELETE_USER:${userEmail}`);
                alert(`Usuario ${userEmail} eliminado correctamente.`);
                loadRegisteredClients();
            } else {
                alert("Error: Usuario no encontrado.");
            }
        }
        
        function viewUserActivity(userEmail) {
            const logElement = document.getElementById('activity-log-display');
            const activity = getActivityLog().filter(entry => entry.user === userEmail).reverse(); // Mostrar lo m√°s reciente primero
            logElement.innerHTML = `<h3>Actividad de ${userEmail}</h3>`;
            
            if (activity.length === 0) {
                logElement.innerHTML += '<p>No se encontr√≥ actividad para este usuario.</p>';
                return;
            }

            activity.forEach(entry => {
                const item = document.createElement('div');
                item.className = 'log-entry';
                item.textContent = `${entry.timestamp} - Acci√≥n: ${entry.action}`;
                logElement.appendChild(item);
            });
        }
        
        // --- FUNCIONES DE SOLICITUDES (EXISTENTES) ---

        function getPendingRequests() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : [];
        }

        function savePendingRequests(requests) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(requests));
        }

        function getApprovedRequests() {
            const data = localStorage.getItem(APPROVED_KEY);
            return data ? JSON.parse(data) : [];
        }

        function saveApprovedRequests(requests) {
            localStorage.setItem(APPROVED_KEY, JSON.stringify(requests));
        }

        function saveSolicitud(type) {
            const requests = getPendingRequests();
            const data = getFormData(type);

            if (!data) return; // Validaci√≥n fall√≥ en getFormData

            const requestId = Date.now().toString();
            const newRequest = {
                id: requestId,
                user: currentUser.user,
                name: currentUser.name,
                type: type,
                data: data,
                timestamp: new Date().toLocaleString(),
                status: 'pending'
            };

            requests.push(newRequest);
            savePendingRequests(requests);
            logActivity(currentUser.user, `REQUEST_SUBMITTED:${type}`);

            alert(`Solicitud de ${type} enviada. Su ID de seguimiento es: ${requestId}. Ser√° redirigido a la p√°gina de estatus.`);
            showStatusPage(newRequest);
        }

        function getFormData(type) {
            const data = {};
            const formId = `form-${type}`;
            const form = document.getElementById(formId);

            if (!form) {
                console.error(`Formulario ${formId} no encontrado.`);
                return null;
            }

            // Simple data collection (can be expanded per form type if needed)
            const inputs = form.querySelectorAll('input, textarea');
            inputs.forEach(input => {
                if (input.type !== 'file') {
                    data[input.id] = input.value;
                } else if (input.files.length > 0) {
                    // Placeholder for file handling logic (files are not stored easily in localStorage)
                    data[input.id] = `File: ${input.files[0].name}`;
                }
            });
            
            // Minimal validation example
            if (Object.keys(data).length === 0) {
                alert("El formulario est√° vac√≠o.");
                return null;
            }

            return data;
        }

        function loadPendingRequests() {
            const requests = getPendingRequests();
            const listElement = document.getElementById('pending-requests-list');
            listElement.innerHTML = '';
            
            const pending = requests.filter(r => r.status === 'pending');

            if (pending.length === 0) {
                listElement.innerHTML = '<p id="no-requests-msg">No hay solicitudes pendientes.</p>';
                return;
            }

            pending.forEach(request => {
                const item = document.createElement('div');
                item.className = 'request-item';
                item.innerHTML = `
                    <div class="request-info">
                        <strong>${request.type.toUpperCase()}</strong> - Solicitante: ${request.name}
                        <p style="font-size:0.85em; margin:2px 0;">ID: ${request.id} (${request.timestamp})</p>
                    </div>
                    <div class="request-actions">
                        <button class="back-button" onclick="viewRequestData('${request.id}')">Ver Datos</button>
                        <button class="btn-authorize" onclick="approveRequest('${request.id}')">Autorizar (Link)</button>
                        <button class="btn-reject" onclick="rejectRequest('${request.id}')">Rechazar</button>
                    </div>
                `;
                listElement.appendChild(item);
            });
        }
        
        function viewRequestData(requestId) {
            const requests = getPendingRequests();
            const request = requests.find(r => r.id === requestId);

            if (request) {
                let dataHtml = `<h3>Datos de la Solicitud #${requestId} (${request.type.toUpperCase()})</h3>`;
                dataHtml += '<ul>';
                for (const key in request.data) {
                    dataHtml += `<li><strong>${key}:</strong> ${request.data[key]}</li>`;
                }
                dataHtml += '</ul>';
                alert(dataHtml.replace(/<[^>]*>/g, '\n').trim()); // Simple alert with data
                logActivity(ADMIN_USER, `VIEW_REQUEST_DATA:${requestId}`);
            } else {
                alert('Solicitud no encontrada.');
            }
        }

        function approveRequest(requestId) {
            const link = prompt("Ingrese el link de descarga (Ej: Google Drive, Mediafire):");
            if (!link) return;

            let pendingRequests = getPendingRequests();
            let approvedRequests = getApprovedRequests();

            const index = pendingRequests.findIndex(r => r.id === requestId);

            if (index > -1) {
                const approvedRequest = {
                    ...pendingRequests[index],
                    status: 'approved',
                    downloadLink: link,
                    approvalTime: new Date().toLocaleString()
                };

                // Mover de pendiente a aprobado
                pendingRequests.splice(index, 1);
                approvedRequests.push(approvedRequest);

                savePendingRequests(pendingRequests);
                saveApprovedRequests(approvedRequests);
                logActivity(ADMIN_USER, `REQUEST_APPROVED:${requestId}`);
                alert(`Solicitud #${requestId} aprobada. El link de descarga ha sido guardado.`);
                loadPendingRequests(); // Recargar el dashboard
            } else {
                alert("Error: Solicitud pendiente no encontrada.");
            }
        }

        function rejectRequest(requestId) {
            if (!confirm(`¬øEst√° seguro de RECHAZAR la solicitud #${requestId}? Esta acci√≥n la eliminar√°.`)) return;
            
            let pendingRequests = getPendingRequests();
            const initialLength = pendingRequests.length;
            pendingRequests = pendingRequests.filter(r => r.id !== requestId);

            if (pendingRequests.length < initialLength) {
                savePendingRequests(pendingRequests);
                logActivity(ADMIN_USER, `REQUEST_REJECTED:${requestId}`);
                alert(`Solicitud #${requestId} rechazada y eliminada.`);
                loadPendingRequests();
            } else {
                alert("Error: Solicitud pendiente no encontrada.");
            }
        }


        // --- FUNCIONES DE ESTATUS DEL USUARIO (EXISTENTES) ---

        function checkUserStatus() {
            if (!currentUser) {
                showForm('auth_splash');
                return;
            }

            // Buscar solicitudes pendientes
            const pendingRequests = getPendingRequests().filter(r => r.user === currentUser.user);
            // Buscar solicitudes aprobadas
            const approvedRequests = getApprovedRequests().filter(r => r.user === currentUser.user);
            
            if (pendingRequests.length > 0) {
                showStatusPage(pendingRequests[0]); // Mostrar la m√°s antigua o la primera
                return;
            }

            if (approvedRequests.length > 0) {
                showStatusPage(approvedRequests[approvedRequests.length - 1]); // Mostrar la m√°s reciente
                return;
            }

            // Si no hay ninguna solicitud, volver al men√∫
            showForm('menu');
        }


        function showStatusPage(request) {
            // Ocultar la aplicaci√≥n principal y mostrar la p√°gina de estatus
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('status-page').style.display = 'block';

            const statusPage = document.getElementById('status-page');
            const disclaimer = document.querySelector('.disclaimer-notice') ? document.querySelector('.disclaimer-notice').outerHTML : '';
            const paymentNotice = document.querySelector('.payment-notice') ? document.querySelector('.payment-notice').outerHTML : '';
            const typeName = request.type.toUpperCase().replace(/_/g, ' ');

            if (request.status === 'pending') {
                statusPage.innerHTML = disclaimer + paymentNotice + `
                    <div>
                        <h1>‚è≥ Solicitud Pendiente de Aprobaci√≥n</h1>
                        <p>Documento solicitado: <strong>${typeName}</strong></p>
                        <p>ID de seguimiento: <strong>${request.id}</strong></p>
                        <p style="margin-top:20px;">Su solicitud fue recibida. El administrador la est√° revisando. Este proceso puede tardar unos minutos.</p>
                        <div class="spinner"></div>
                        <p><strong>Por favor, NO cierre esta p√°gina.</strong> Ser√° notificado aqu√≠ cuando est√© lista.</p>
                        <p style="margin-top:30px; font-size:0.9em;">√öltimo chequeo: ${new Date().toLocaleTimeString()}</p>
                    </div>
                `;
                // Iniciar chequeo autom√°tico si no est√° corriendo
                if (!statusCheckInterval) {
                    statusCheckInterval = setInterval(refreshStatus, 15000); // Chequear cada 15 segundos
                }
            } else if (request.status === 'approved') {
                // Limpiar intervalo si existe
                if (statusCheckInterval) {
                    clearInterval(statusCheckInterval);
                    statusCheckInterval = null;
                }
                
                statusPage.innerHTML = disclaimer + `
                    <div>
                        <h1>‚úÖ ¬°Solicitud Aprobada!</h1>
                        <p>Su documento para <strong>${typeName}</strong> est√° listo.</p>
                        <p>ID de seguimiento: <strong>${request.id}</strong></p>
                        <p style="margin-top:30px;">
                            Presione el bot√≥n para descargar su documento.
                        </p>
                        <button class="btn-action btn-download-now" onclick="downloadDocument('${request.id}')">
                            <i class="fas fa-download"></i> Descargar Ahora
                        </button>
                        <div class="download-link-box">
                            Link directo: ${request.downloadLink}
                        </div>
                        <p style="margin-top:30px;"><button class="back-button" onclick="showForm('menu')">Volver al Men√∫</button></p>
                    </div>
                `;
                // Eliminar la solicitud aprobada del almacenamiento despu√©s de un tiempo para no seguir mostr√°ndola
                setTimeout(() => {
                    removeApprovedRequest(request.id);
                }, 5 * 60 * 1000); // 5 minutos para eliminar
            }
        }

        function refreshStatus() {
            if (!currentUser) {
                // Si la sesi√≥n caduc√≥ mientras checaba, limpiar el intervalo y redirigir
                clearInterval(statusCheckInterval);
                statusCheckInterval = null;
                showForm('auth_splash');
                return;
            }

            const pendingRequests = getPendingRequests().filter(r => r.user === currentUser.user);
            const approvedRequests = getApprovedRequests().filter(r => r.user === currentUser.user);

            if (approvedRequests.length > 0) {
                // Si encuentra una aprobada, detener el chequeo y mostrar la p√°gina de aprobado
                const lastApproved = approvedRequests[approvedRequests.length - 1];
                showStatusPage(lastApproved);
                return;
            }

            if (pendingRequests.length === 0) {
                 // Si no hay pendientes ni aprobadas (fueron rechazadas o eliminadas), volver al men√∫
                if (statusCheckInterval) {
                    clearInterval(statusCheckInterval);
                    statusCheckInterval = null;
                }
                showForm('menu');
                return;
            }
            
            // Actualizar la hora de chequeo en la p√°gina pendiente
            const statusPage = document.getElementById('status-page');
            const timeElement = statusPage.querySelector('p:last-child');
            if (timeElement) {
                timeElement.innerHTML = `√öltimo chequeo: ${new Date().toLocaleTimeString()}`;
            }
        }

        function removeApprovedRequest(requestId) {
            let approvedRequests = getApprovedRequests();
            const initialLength = approvedRequests.length;
            approvedRequests = approvedRequests.filter(r => r.id !== requestId);

            if (approvedRequests.length < initialLength) {
                saveApprovedRequests(approvedRequests);
                logActivity(currentUser.user, `REQUEST_CLEANED:${requestId}`);
            }
        }

        function downloadDocument(requestId) {
            const approvedRequests = getApprovedRequests();
            const request = approvedRequests.find(r => r.id === requestId);

            if (!request || !request.downloadLink) {
                alert("Error: El link de descarga no est√° disponible o la solicitud no existe.");
                return;
            }

            // Simular la descarga
            const link = document.createElement('a');
            link.href = request.downloadLink;
            link.download = `${request.type}_${request.id}.pdf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            if(currentUser) logActivity(currentUser.user, `DOWNLOAD_DOCUMENT:${request.type}:${requestId}`);

            const statusPage = document.getElementById('status-page');
            const disclaimer = statusPage.querySelector('.disclaimer-notice') ? statusPage.querySelector('.disclaimer-notice').outerHTML : '';
            statusPage.innerHTML = disclaimer + `
                <div>
                    <h1>‚úÖ Descarga Exitosa</h1>
                    <p>Su documento para <strong>${request.name}</strong> ha sido descargado. Por favor, revise su carpeta de descargas.</p>
                    <p style="margin-top:30px;">Redirigiendo al men√∫ principal...</p>
                </div>
            `;

            // L√≥gica de redirecci√≥n agregada
            setTimeout(() => {
                // Ocultar la p√°gina de estatus
                document.getElementById('status-page').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                
                // Regresar al men√∫ si el usuario est√° logueado, o al acceso si no
                if (currentUser) {
                    showForm('menu');
                } else {
                    showForm('auth_splash');
                }
                
            }, 2000); // 2 segundos de espera para ver el mensaje
        }
        
        window.addEventListener('load', () => {
            checkURL();
        });

    </script>
</body>
</html>
