<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Generador de Documentos - Estatus de Solicitud</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>

    <style>
        /* Estilos Base Existentes */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 850px;
            margin: 0 auto;
            padding: 25px;
            background-color: #f4f4f9;
            position: relative;
            padding-bottom: 100px;
        }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 25px; }
        .input-group, .form-section { background-color: #ffffff; padding: 20px; margin-bottom: 25px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h2 { color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 5px; margin-bottom: 15px; }
        label { display: block; margin-top: 10px; font-weight: 600; color: #555; }
        input[type="text"], input[type="date"], input[type="password"], input[type="file"], textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }
        textarea { resize: vertical; }
        .btn-action {
            background-color: #2ecc71;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .btn-action:hover { background-color: #27ae60; }
        .hidden { display: none; }
        .back-button {
            background: none;
            border: none;
            color: #3498db;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 15px;
            padding: 0;
            display: block;
        }

        /* Estilos del Dashboard/Men√∫ */
        #main-menu .icon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .menu-card {
            background-color: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .menu-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .menu-card i {
            font-size: 30px;
            margin-bottom: 10px;
            color: #3498db; /* Color base */
        }
        .menu-card strong {
            display: block;
            font-size: 14px;
            color: #34495e;
        }
        /* Colores espec√≠ficos para categor√≠as */
        .category-receta i { color: #e74c3c; }
        .category-admin i { color: #f39c12; }
        .category-legal i { color: #9b59b6; }

        /* Estilos de Solicitudes */
        #solicitudes-list { list-style: none; padding: 0; }
        #solicitudes-list li {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #solicitudes-list li:last-child { border-bottom: none; }
        .solicitud-status {
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
        }
        .status-pendiente { background-color: #f1c40f; color: #34495e; }
        .status-aprobada { background-color: #2ecc71; color: white; }
        .status-rechazada { background-color: #e74c3c; color: white; }
        .date-container { display: flex; gap: 20px; }
        .date-container > div { flex: 1; }
        
        /* Estilos del Footer */
        footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: #2c3e50;
            color: white;
            text-align: center;
            padding: 15px 0;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        }
        footer .wa-link {
            color: #2ecc71;
            text-decoration: none;
            font-weight: bold;
        }
        .disclaimer-notice, .payment-notice {
            background-color: #f9e1e1;
            color: #e74c3c;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #e74c3c;
        }
        .payment-notice {
            background-color: #e6f7ff;
            color: #3498db;
            border: 1px solid #3498db;
        }
    </style>
</head>
<body>

    <div class="app-container">
        <h1>Generador de Documentos y Solicitudes</h1>

        <div id="auth-section" class="input-group">
            <h2>üîë Acceso de Usuario</h2>
            <label for="username">Usuario:</label>
            <input type="text" id="username" value="usuario_prueba">
            <label for="password">Contrase√±a:</label>
            <input type="password" id="password" value="123456">
            <button class="btn-action" onclick="login()">Iniciar Sesi√≥n</button>
        </div>

        <div id="main-view" class="hidden">
            <div id="user-info" class="input-group">
                <span id="welcome-message"></span> 
                <button class="back-button" onclick="logout()">Cerrar Sesi√≥n</button>
            </div>

            <div id="main-menu" class="form-section">
                <h2>üìë Documentos Legales</h2>
                <div class="icon-grid">
                    <div class="menu-card category-legal" onclick="showForm('carta_laboral')">
                        <i class="fas fa-file-alt"></i>
                        <strong>Carta Laboral</strong>
                    </div>
                    <div class="menu-card category-legal" onclick="showForm('carta_invitacion')">
                        <i class="fas fa-envelope-open-text"></i>
                        <strong>Carta Invitaci√≥n</strong>
                    </div>
                    <div class="menu-card category-legal" onclick="showForm('carta_poder')">
                        <i class="fas fa-balance-scale"></i>
                        <strong>Carta Poder</strong>
                    </div>
                    <div class="menu-card category-legal" onclick="showForm('carta_despido')">
                        <i class="fas fa-user-times"></i>
                        <strong>Carta Despido</strong>
                    </div>
                </div>

                <h2>üíä Documentos M√©dicos y Recetas</h2>
                <div class="icon-grid">
                    <div class="menu-card category-receta" onclick="showForm('incapacidad_imss')">
                        <i class="fas fa-user-minus"></i>
                        <strong>Incapacidad IMSS</strong>
                    </div>
                    <div class="menu-card category-receta" onclick="showForm('receta_similares')">
                        <i class="fas fa-prescription-bottle-alt"></i>
                        <strong>Receta SIMILARES</strong>
                    </div>
                    <div class="menu-card category-receta" onclick="showForm('receta_ahorro')">
                        <i class="fas fa-pills"></i>
                        <strong>Receta DEL AHORRO</strong>
                    </div>
                    <div class="menu-card category-receta" onclick="showForm('certificado_medico_imss')">
                        <i class="fas fa-notes-medical"></i>
                        <strong>Certificado M√©dico IMSS</strong>
                    </div>
                </div>

                <h2>üèõ Certificados y Otros</h2>
                <div class="icon-grid">
                    <div class="menu-card category-legal" onclick="showForm('certificado_estudios')">
                        <i class="fas fa-graduation-cap"></i>
                        <strong>Certificado de Estudios</strong>
                    </div>
                    <div class="menu-card category-legal" onclick="showForm('sellos_personales')">
                        <i class="fas fa-stamp"></i>
                        <strong>Sellos Personales</strong>
                    </div>
                </div>

                <h2>üìù Mis Solicitudes Pendientes</h2>
                <ul id="solicitudes-list">
                    </ul>
            </div>

            <div id="admin-dashboard" class="form-section hidden">
                <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>
                <h2>üëë Panel de Administrador</h2>
                <ul id="admin-solicitudes-list">
                    </ul>
            </div>
            
            <div id="form-carta_laboral" class="form-section hidden">
                <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>
                <div class="disclaimer-notice">*NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO*</div>
                <div class="payment-notice">*PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*</div>
                <h2>üìÑ Formulario de Carta Laboral</h2>
                <div class="input-group">
                    <label for="nombreEmpresa">Nombre de la Empresa:</label>
                    <input type="text" id="nombreEmpresa" value="Tech Solutions S.A. de C.V.">
                    <label for="puesto">Puesto:</label>
                    <input type="text" id="puesto" value="Desarrollador Web Senior">
                </div>
                <button class="btn-action" onclick="saveSolicitud('carta_laboral')">üíæ Guardar Solicitud (Esperar Aprobaci√≥n)</button>
            </div>
            
            <div id="form-receta_similares" class="form-section hidden">
                <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>
                <div class="disclaimer-notice">*NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO*</div>
                <div class="payment-notice">*PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*</div>
                <h2>üíä Formulario de Receta SIMILARES</h2>
                <div class="input-group">
                    <h2>Datos del Paciente</h2>
                    <label for="nombrePacienteSimilares">Nombre Completo del Paciente:</label>
                    <input type="text" id="nombrePacienteSimilares" value="Ana Mar√≠a L√≥pez">
                    <label for="edadPacienteSimilares">Edad:</label>
                    <input type="text" id="edadPacienteSimilares" value="45 a√±os">
                    <label for="sexoPacienteSimilares">Sexo (M/F):</label>
                    <input type="text" id="sexoPacienteSimilares" value="F">
                </div>
                <div class="input-group">
                    <h2>Medicamentos y Dosis</h2>
                    <label for="medicamento1">Medicamento 1:</label>
                    <input type="text" id="medicamento1" value="Paracetamol 500 mg">
                    <label for="dosis1">Dosis 1 (Ej: Tomar 1 cada 8 hrs):</label>
                    <input type="text" id="dosis1" value="Tomar una tableta cada 8 horas por 5 d√≠as.">
                    
                    <label for="medicamento2">Medicamento 2 (Opcional):</label>
                    <input type="text" id="medicamento2" value="Amoxicilina 250 mg">
                    <label for="dosis2">Dosis 2 (Opcional):</label>
                    <input type="text" id="dosis2" value="Tomar una c√°psula cada 12 horas por 7 d√≠as.">

                    <label for="diagnosticoSimilares">Diagn√≥stico (Opcional):</label>
                    <input type="text" id="diagnosticoSimilares" value="Gripe Com√∫n">
                    <label for="proximaCitaSimilares">Pr√≥xima Cita (Opcional):</label>
                    <input type="text" id="proximaCitaSimilares" value="No necesaria.">
                </div>
                <button class="btn-action" onclick="saveSolicitud('receta_similares')">üíæ Guardar Solicitud (Esperar Aprobaci√≥n)</button>
            </div>

            <div id="form-certificado_medico_imss" class="form-section hidden">
                <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>
                <div class="disclaimer-notice">*NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO*</div>
                <div class="payment-notice">*PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*</div>
                <h2>üè• Formulario de Certificado M√©dico IMSS</h2>

                <div class="input-group">
                    <h2>üè∑Ô∏è Datos de la Unidad y el Documento</h2>
                    <label for="umfIMSS">Unidad M√©dica Familiar (Ej: UMF 67):</label>
                    <input type="text" id="umfIMSS" value="UNIDAD M√âDICA FAMILIAR NO. UMF 67">
                    
                    <label for="direccionUMFIMSS">Direcci√≥n de la Unidad (Ej: SANTA CLARA...):</label>
                    <input type="text" id="direccionUMFIMSS" value="SANTA CLARA ECATEPEC ESTADO DE M√âXICO">
                    
                    <label for="asuntoIMSS">Asunto (Ej: CERTIFICADO M√âDICO):</label>
                    <input type="text" id="asuntoIMSS" value="CERTIFICADO M√âDICO">
                    
                    <label for="numFolioIMSS">N√∫mero de Folio (Ej: Num.09 55...):</label>
                    <input type="text" id="numFolioIMSS" value="l. Num.09 55 29/3409/171/F-009">

                    <label for="logoInputIMSS">Insertar Logo de la Esquina Superior (IMSS):</label>
                    <input type="file" id="logoInputIMSS" accept="image/*">

                </div>

                <div class="input-group">
                    <h2>üßë‚Äç‚öïÔ∏è Datos del M√©dico</h2>
                    <label for="doctorNombreIMSS">Nombre Completo del M√©dico:</label>
                    <input type="text" id="doctorNombreIMSS" value="YESSICA MEJ√çA CARRANZA">
                    
                    <label for="cedulaDoctorIMSS">C√©dula Profesional (CP) del M√©dico:</label>
                    <input type="text" id="cedulaDoctorIMSS" value="5866652">
                    
                    <label for="especialidadIMSS">Especialidad/Consultorio/Turno (Ej: Medicina Familiar...):</label>
                    <input type="text" id="especialidadIMSS" value="Medicina Familiar. Consultorio: 5 Turno: Vespertino">

                    <label for="fechaEmisionIMSS">Fecha de Emisi√≥n del Certificado:</label>
                    <input type="date" id="fechaEmisionIMSS" value="2025-10-06">
                </div>

                <div class="input-group">
                    <h2>üë§ Datos del Paciente</h2>
                    <label for="nombrePacienteIMSS">Nombre Completo del Paciente:</label>
                    <input type="text" id="nombrePacienteIMSS" value="CARMEN MORELOS HERN√ÅNDEZ">

                    <label for="nssIMSS">N√∫mero de Seguro Social (NSS):</label>
                    <input type="text" id="nssIMSS" value="1715950626-4">
                    
                    <div class="date-container">
                        <div>
                            <label for="sexoPacienteIMSS">Sexo (Ej: Femenino):</label>
                            <input type="text" id="sexoPacienteIMSS" value="Femenino">
                        </div>
                        <div>
                            <label for="edadPacienteIMSS">Edad (Ej: 30 a√±os):</label>
                            <input type="text" id="edadPacienteIMSS" value="30 a√±os de edad">
                        </div>
                    </div>
                </div>

                <div class="input-group">
                    <h2>ü©∫ Examen F√≠sico y Antecedentes</h2>
                    <label for="antecedentesIMSS">Antecedentes M√©dicos (Ej: Alergias, Cirug√≠as, Cr√≥nicas):</label>
                    <textarea id="antecedentesIMSS" rows="5">Alergias: No presenta alergias de ning√∫n tipo.
Cirug√≠as: No ha sido sometida a intervenciones quir√∫rgicas.
Enfermedades Cr√≥nicas: Ninguna.
Vacunas: Esquema de vacunaci√≥n al d√≠a conforme a las normativas vigentes.</textarea>

                    <div class="date-container">
                        <div>
                            <label for="pesoIMSS">Peso (Ej: 90.00kg):</label>
                            <input type="text" id="pesoIMSS" value="90.00kg">
                        </div>
                        <div>
                            <label for="tallaIMSS">Talla (Ej: 1.40 mts):</label>
                            <input type="text" id="tallaIMSS" value="1.40 mts">
                        </div>
                    </div>

                    <div class="date-container">
                        <div>
                            <label for="fcIMSS">Frecuencia Cardiaca (Ej: 78 lpm):</label>
                            <input type="text" id="fcIMSS" value="78 lpm">
                        </div>
                        <div>
                            <label for="taIMSS">Presi√≥n Arterial (Ej: 110/76 mmHg):</label>
                            <input type="text" id="taIMSS" value="110/76 mmHg">
                        </div>
                    </div>
                    
                    <div class="date-container">
                        <div>
                            <label for="frIMSS">Frecuencia Respiratoria (Ej: 16 rpm):</label>
                            <input type="text" id="frIMSS" value="16 rpm">
                        </div>
                        <div>
                            <label for="tempIMSS">Temperatura Corporal (Ej: 36.7¬∞C):</label>
                            <input type="text" id="tempIMSS" value="36.7¬∞C">
                        </div>
                    </div>

                    <label for="tipoSangreIMSS">Tipo de Sangre:</label>
                    <input type="text" id="tipoSangreIMSS" value="O+">
                    
                    <label for="sistemasIMSS">Sistemas (Respiratorio, Cardiovascular, etc.):</label>
                    <textarea id="sistemasIMSS" rows="10">Sistema Respiratorio: Pulmones: Sin murmullo vesicular presente, sin ruidos agregados.
Sistema Cardiovascular: Coraz√≥n: R√≠tmico, sin soplos ni ruidos patol√≥gicos.
Sistema Digestivo: Abdomen: Blando, depresible, sin dolor a la palpaci√≥n.
Sistema Neurol√≥gico: Reflejos: Conservados. Conciencia: Orientada en tiempo, espacio y persona.
Sistema Osteomuscular: Columna: Sin desviaciones, postura adecuada. Extremidades: Con Mucha Fuerza y movilidad.
Examen de la Vista: Agudeza Visual: 20/20 en ambos ojos sin correcci√≥n. Visi√≥n de Colores: Normal, sin evidencia de daltonismo. Campo Visual: Completo en ambos ojos. Reflejo Pupilar: Reactivo a la luz, sin anormalidades.</textarea>

                    <label for="conclusionIMSS">Conclusi√≥n (Apto/No Apto y Restricciones):</label>
                    <textarea id="conclusionIMSS" rows="4">El paciente se encuentra en buenas condiciones de salud general, sin signos de enfermedades infecciosas, cr√≥nicas o agudas que comprometen su bienestar en la actualidad. Es apta para realizar actividades f√≠sicas sin restricciones.</textarea>
                </div>

                <button class="btn-action" onclick="saveSolicitud('certificado_medico_imss')">üíæ Guardar Solicitud (Esperar Aprobaci√≥n)</button>
            </div>
            <div id="form-incapacidad_imss" class="form-section hidden">
                <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>
                <div class="disclaimer-notice">*NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO*</div>
                <div class="payment-notice">*PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*</div>
                <h2>ü§í Formulario de Incapacidad IMSS</h2>
                <p>Aqu√≠ ir√≠a el formulario para Incapacidad IMSS.</p>
                <button class="btn-action" onclick="saveSolicitud('incapacidad_imss')">üíæ Guardar Solicitud (Esperar Aprobaci√≥n)</button>
            </div>
            <div id="form-receta_ahorro" class="form-section hidden">
                <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>
                <div class="disclaimer-notice">*NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO*</div>
                <div class="payment-notice">*PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*</div>
                <h2>üíä Formulario de Receta DEL AHORRO</h2>
                <p>Aqu√≠ ir√≠a el formulario para Receta DEL AHORRO.</p>
                <button class="btn-action" onclick="saveSolicitud('receta_ahorro')">üíæ Guardar Solicitud (Esperar Aprobaci√≥n)</button>
            </div>
            <div id="form-carta_invitacion" class="form-section hidden">
                <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>
                <div class="disclaimer-notice">*NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO*</div>
                <div class="payment-notice">*PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*</div>
                <h2>‚úâÔ∏è Formulario de Carta Invitaci√≥n</h2>
                <p>Aqu√≠ ir√≠a el formulario para Carta Invitaci√≥n.</p>
                <button class="btn-action" onclick="saveSolicitud('carta_invitacion')">üíæ Guardar Solicitud (Esperar Aprobaci√≥n)</button>
            </div>

        </div> </div> <footer>
        Contacto: <a href="https://wa.me/XXXXXXXXXX" class="wa-link" target="_blank">WhatsApp XXXXXXXXXX</a>
    </footer>

    <script>
        // Inicializaci√≥n y datos de prueba
        window.jsPDF = window.jspdf.jsPDF;
        let currentUser = null;
        let solicitudes = [
            // { id: 1, userId: 'usuario_prueba', tipo: 'carta_laboral', asunto: 'Carta para Empleo', status: 'pendiente', fecha: '2025-10-25', pdf: 'Base64 String...' }
        ];
        const users = {
            'usuario_prueba': { password: '123456', name: 'Usuario de Prueba', isAdmin: false },
            'admin': { password: 'admin', name: 'Administrador Principal', isAdmin: true }
        };

        // --- FUNCIONES CORE ---

        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (users[username] && users[username].password === password) {
                currentUser = { 
                    username: username, 
                    name: users[username].name, 
                    isAdmin: users[username].isAdmin 
                };
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('main-view').classList.remove('hidden');
                document.getElementById('welcome-message').textContent = `Bienvenido, ${currentUser.name}.`;
                
                showForm('menu');
                loadSolicitudes();
            } else {
                alert('Usuario o contrase√±a incorrectos.');
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('auth-section').classList.remove('hidden');
            document.getElementById('main-view').classList.add('hidden');
            document.getElementById('admin-dashboard').classList.add('hidden');
        }

        const viewIdMap = {
            'menu': 'main-menu',
            'carta_laboral': 'form-carta_laboral',
            'incapacidad_imss': 'form-incapacidad_imss',
            'receta_similares': 'form-receta_similares',
            'receta_ahorro': 'form-receta_ahorro',
            'certificado_estudios': 'form-certificado_estudios', // Asumiendo ID
            'carta_invitacion': 'form-carta_invitacion', // Asumiendo ID
            'admin_dashboard': 'admin-dashboard',
            'certificado_medico_imss': 'form-certificado_medico_imss', // << A√ëADIDO
            'sellos_personales': 'form-sellos_personales', // Asumiendo ID
            'formato_solicitud_pdf': 'formato_solicitud_pdf' // Asumiendo ID
        };

        function showForm(formId) {
            const allViews = document.querySelectorAll('.form-section, #main-menu');
            allViews.forEach(view => view.classList.add('hidden'));
            
            const targetId = viewIdMap[formId];
            if (targetId) {
                document.getElementById(targetId).classList.remove('hidden');
            } else {
                // Fallback to menu if formId is invalid
                document.getElementById('main-menu').classList.remove('hidden');
            }

            // L√≥gica para mostrar/ocultar el dashboard de administrador
            if (formId === 'menu' && currentUser && currentUser.isAdmin) {
                document.getElementById('admin-dashboard').classList.remove('hidden');
            } else {
                document.getElementById('admin-dashboard').classList.add('hidden');
            }
        }

        // --- L√ìGICA DE SOLICITUDES Y ADMINISTRACI√ìN ---

        async function saveSolicitud(tipoCarta) {
            if (!currentUser) {
                 alert("Error: Debe iniciar sesi√≥n para guardar una solicitud.");
                 return;
            }
            let nombreSolicitante = currentUser.name, 
                nombreAsunto = tipoCarta.toUpperCase(), 
                pdfBase64 = null;

            // 1. GENERACI√ìN DE PDF Y ASUNTO ESPEC√çFICO (Base64 solo para el Admin)
            if (tipoCarta === 'receta_similares') {
                nombreSolicitante = document.getElementById('nombrePacienteSimilares').value || 'Paciente';
                nombreAsunto = `RECETA - ${nombreSolicitante}`;
                pdfBase64 = await generarPDFRecetaSimilares(false); // false = no descargar, obtener base64
            } else if (tipoCarta === 'certificado_medico_imss') { // << A√ëADIDO PARA EL NUEVO FORMULARIO
                nombreSolicitante = document.getElementById('nombrePacienteIMSS').value || 'Paciente';
                nombreAsunto = `CERTIFICADO - ${nombreSolicitante}`;
                pdfBase64 = await generarPDFCertificadoIMSS(false); // false = no descargar, obtener base64
            } else {
                // Para cartas gen√©ricas sin PDF especial (solo un placeholder para el admin)
                pdfBase64 = "BASE64_PLACEHOLDER_FOR_NEW_TYPE";
                nombreAsunto = tipoCarta.replace('_', ' ').toUpperCase();
            }

            // 2. GUARDAR LA SOLICITUD
            const nuevaSolicitud = {
                id: solicitudes.length + 1,
                userId: currentUser.username,
                tipo: tipoCarta,
                asunto: nombreAsunto,
                status: 'pendiente',
                fecha: new Date().toLocaleDateString('es-MX'),
                pdf: pdfBase64 // El administrador lo necesita para aprobar
            };

            solicitudes.push(nuevaSolicitud);
            alert(`Solicitud de ${nombreAsunto} guardada. Pendiente de aprobaci√≥n del administrador.`);
            
            // Recargar listas y volver al men√∫
            loadSolicitudes();
            showForm('menu');
        }

        function loadSolicitudes() {
            // Carga para Usuarios (solicitudes propias)
            const userList = document.getElementById('solicitudes-list');
            userList.innerHTML = '';
            
            const userSolicitudes = solicitudes.filter(s => s.userId === currentUser.username);
            
            if (userSolicitudes.length === 0) {
                userList.innerHTML = '<li>No tienes solicitudes a√∫n.</li>';
            }

            userSolicitudes.forEach(sol => {
                const li = document.createElement('li');
                const statusClass = `status-${sol.status}`;
                
                li.innerHTML = `
                    <span>[#${sol.id}] ${sol.asunto} (${sol.fecha})</span>
                    <div>
                        <span class="solicitud-status ${statusClass}">${sol.status.toUpperCase()}</span>
                        ${sol.status === 'aprobada' ? 
                            `<button onclick="downloadPDF(${sol.id})">Descargar PDF</button>` : 
                            ''
                        }
                    </div>
                `;
                userList.appendChild(li);
            });

            // Carga para Administrador (todas las solicitudes)
            if (currentUser.isAdmin) {
                const adminList = document.getElementById('admin-solicitudes-list');
                adminList.innerHTML = '';
                
                solicitudes.forEach(sol => {
                    const li = document.createElement('li');
                    const statusClass = `status-${sol.status}`;
                    
                    li.innerHTML = `
                        <span>[#${sol.id}] ${sol.asunto} por ${sol.userId}</span>
                        <div>
                            <span class="solicitud-status ${statusClass}">${sol.status.toUpperCase()}</span>
                            ${sol.status === 'pendiente' ? 
                                `<button onclick="updateStatus(${sol.id}, 'aprobada')">Aprobar</button>
                                 <button onclick="updateStatus(${sol.id}, 'rechazada')">Rechazar</button>` : 
                                sol.status === 'aprobada' ?
                                `<button onclick="downloadPDF(${sol.id})">Ver PDF (Admin)</button>` :
                                ''
                            }
                        </div>
                    `;
                    adminList.appendChild(li);
                });
            }
        }

        function updateStatus(id, newStatus) {
            const solicitud = solicitudes.find(s => s.id === id);
            if (solicitud) {
                solicitud.status = newStatus;
                alert(`Solicitud #${id} marcada como ${newStatus.toUpperCase()}`);
                loadSolicitudes();
            }
        }

        function downloadPDF(id) {
            const solicitud = solicitudes.find(s => s.id === id);
            if (!solicitud || solicitud.status !== 'aprobada') {
                if (!currentUser.isAdmin) {
                    alert('Solo puede descargar PDFs aprobados.');
                    return;
                }
            }
            
            // El usuario que la gener√≥ tiene la funci√≥n de generaci√≥n en JS, la ejecuta
            if (solicitud.tipo === 'receta_similares') {
                generarPDFRecetaSimilares(true); // true = descargar
            } else if (solicitud.tipo === 'certificado_medico_imss') {
                generarPDFCertificadoIMSS(true); // true = descargar
            } else if (solicitud.pdf && solicitud.pdf !== "BASE64_PLACEHOLDER_FOR_NEW_TYPE") {
                // Para el admin, si el PDF existe como base64, lo descarga directamente
                const link = document.createElement('a');
                link.href = 'data:application/pdf;base64,' + solicitud.pdf;
                link.download = `${solicitud.asunto}_${solicitud.fecha}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                // En este caso, si no es una receta, se podr√≠a llamar a una funci√≥n gen√©rica de PDF
                alert(`Descarga no implementada a√∫n para el tipo: ${solicitud.tipo}`);
            }
        }

        // --- FUNCIONES AUXILIARES DE PDF ---
        
        // Helper: Convierte un archivo File a Base64 Data URL (necesario para las im√°genes del PDF)
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
            });
        }

        // Helper: Dibuja texto justificado con salto de l√≠nea (necesario para campos largos como antecedentes)
        function drawJustifiedText(doc, text, x, y, maxWidth, lineHeight) {
            const splitText = doc.splitTextToSize(text, maxWidth);
            doc.text(splitText, x, y, { align: 'justify' });
            return y + splitText.length * lineHeight;
        }

        // --- GENERACI√ìN DE PDF: RECETA SIMILARES (Ejemplo Existente) ---
        async function generarPDFRecetaSimilares(descargar = true) {
            const doc = new jsPDF('p', 'mm', 'a6');
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 10;
            let y = 10;
            const lineHeight = 4;

            const nombreP = document.getElementById('nombrePacienteSimilares').value.toUpperCase();
            const edadP = document.getElementById('edadPacienteSimilares').value;
            const sexoP = document.getElementById('sexoPacienteSimilares').value;
            const med1 = document.getElementById('medicamento1').value;
            const dosis1 = document.getElementById('dosis1').value;
            const med2 = document.getElementById('medicamento2').value;
            const dosis2 = document.getElementById('dosis2').value;
            const diagnostico = document.getElementById('diagnosticoSimilares').value;
            const proxima = document.getElementById('proximaCitaSimilares').value;

            // ... L√≥gica de PDF Receta Similares ...
            // (Mantenida simple para el ejemplo)

            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('SIMILARES', pageWidth / 2, y, { align: 'center' });
            y += 5;

            doc.setFont(undefined, 'normal');
            doc.text(`PACIENTE: ${nombreP}`, margin, y);
            y += lineHeight;
            doc.text(`EDAD: ${edadP}`, margin, y);
            doc.text(`SEXO: ${sexoP}`, pageWidth - margin, y, { align: 'right' });
            y += lineHeight + 5;

            doc.setFont(undefined, 'bold');
            doc.text('RX:', margin, y);
            y += lineHeight;
            
            doc.setFont(undefined, 'normal');
            doc.text(`1. ${med1}`, margin + 5, y);
            y += lineHeight;
            doc.text(dosis1, margin + 5, y);
            y += lineHeight * 2;
            
            if (med2) {
                doc.text(`2. ${med2}`, margin + 5, y);
                y += lineHeight;
                doc.text(dosis2, margin + 5, y);
                y += lineHeight * 2;
            }

            doc.setFont(undefined, 'bold');
            doc.text('DIAGN√ìSTICO:', margin, y);
            doc.setFont(undefined, 'normal');
            doc.text(diagnostico, margin + 30, y);
            y += lineHeight + 5;

            doc.setFont(undefined, 'bold');
            doc.text('PR√ìXIMA CITA:', margin, y);
            doc.setFont(undefined, 'normal');
            doc.text(proxima, margin + 30, y);
            y += 12;

            // L√≠nea para firma (Ejemplo)
            const firmaX = pageWidth - margin - 50;
            doc.setLineWidth(0.4);
            doc.line(firmaX, y, firmaX + 40, y);
            doc.setFont(undefined, 'bold');
            doc.text('FIRMA DEL M√âDICO', firmaX + 20, y + 4, { align: 'center' });
            y += 10;

            if (descargar) {
                const safeName = (nombreP || 'PACIENTE').replace(/\s+/g, '_');
                doc.save(`Receta_Similares_${safeName}.pdf`);
                return true;
            } else {
                return doc.output('datauristring').split(',')[1];
            }
        }

        // --- NUEVA FUNCI√ìN DE GENERACI√ìN DE PDF: CERTIFICADO IMSS ---
        const DEFAULT_IMSS_LOGO_DATAURL = 'data:image/svg+xml;base64,' + btoa(
            `<svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" viewBox="0 0 512 512" fill="#006655">
              <path d="M256 0C114.6 0 0 114.6 0 256s114.6 256 256 256s256-114.6 256-256S397.4 0 256 0zM357 152.1c0 6.1-5 11.1-11.1 11.1-6.1 0-11.1-5-11.1-11.1s5-11.1 11.1-11.1c6.1 0 11.1 5 11.1 11.1zm-151.4 151.4c-6.1 0-11.1-5-11.1-11.1s5-11.1 11.1-11.1 11.1 5 11.1 11.1-5 11.1-11.1 11.1zM256 462.8c-114 0-206.8-92.8-206.8-206.8S142 49.2 256 49.2s206.8 92.8 206.8 206.8-92.8 206.8-206.8 206.8zM245.5 137.6c-48 0-87.1 39.1-87.1 87.1 0 22.4 8.5 43.1 22.4 58.8L126.3 335.7l13.6 13.6 54.5-54.5c16.3 12.3 35.5 19.5 55.4 19.5 48 0 87.1-39.1 87.1-87.1 0-48-39.1-87.1-87.1-87.1zM256 325.2c-35 0-63.6-28.6-63.6-63.6 0-35 28.6-63.6 63.6-63.6 35 0 63.6 28.6 63.6 63.6 0 35-28.6 63.6-63.6 63.6z"/>
            </svg>`
        );

        async function generarPDFCertificadoIMSS(descargar = true) {
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 15;
            let y = 15;
            const lineHeight = 5;
            
            // --- Cargar datos del formulario
            const umf = document.getElementById('umfIMSS').value.toUpperCase();
            const direccionUMF = document.getElementById('direccionUMFIMSS').value.toUpperCase();
            const asunto = document.getElementById('asuntoIMSS').value.toUpperCase();
            const numFolio = document.getElementById('numFolioIMSS').value;
            const nombreDoc = document.getElementById('doctorNombreIMSS').value.toUpperCase();
            const cedulaDoc = document.getElementById('cedulaDoctorIMSS').value;
            const especialidad = document.getElementById('especialidadIMSS').value;
            const fechaVal = document.getElementById('fechaEmisionIMSS').value;
            const fechaEmision = new Date(fechaVal + 'T12:00:00').toLocaleDateString('es-MX', { day: 'numeric', month: 'long', year: 'numeric' });
            const nombreP = document.getElementById('nombrePacienteIMSS').value.toUpperCase();
            const nss = document.getElementById('nssIMSS').value;
            const sexoP = document.getElementById('sexoPacienteIMSS').value;
            const edadP = document.getElementById('edadPacienteIMSS').value;
            const antecedentes = document.getElementById('antecedentesIMSS').value;
            const peso = document.getElementById('pesoIMSS').value;
            const talla = document.getElementById('tallaIMSS').value;
            const fc = document.getElementById('fcIMSS').value;
            const ta = document.getElementById('taIMSS').value;
            const fr = document.getElementById('frIMSS').value;
            const temp = document.getElementById('tempIMSS').value;
            const tipoSangre = document.getElementById('tipoSangreIMSS').value;
            const sistemas = document.getElementById('sistemasIMSS').value;
            const conclusion = document.getElementById('conclusionIMSS').value;

            // Cargar logo (IMSS) - Usa el archivo subido o el default si no hay archivo
            const logoFile = document.getElementById('logoInputIMSS').files[0];
            const logoBase64 = logoFile ? await fileToBase64(logoFile) : DEFAULT_IMSS_LOGO_DATAURL;

            // --- ENCABEZADO Y LOGO ---
            // Intenta detectar el tipo de imagen. Asumiendo PNG/JPEG para archivos subidos.
            const logoFormat = logoFile ? (logoFile.type.includes('png') ? 'PNG' : 'JPEG') : 'SVG'; 
            doc.addImage(logoBase64, logoFormat, margin, y, 30, 30);
            
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('INSTITUTO MEXICANO DEL SEGURO SOCIAL', pageWidth / 2, y + 5, { align: 'center' });
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('DIRECCION DE PRESTACIONES M√âDICAS', pageWidth / 2, y + 10, { align: 'center' });
            doc.text(umf, pageWidth / 2, y + 15, { align: 'center' });
            doc.text(direccionUMF, pageWidth / 2, y + 20, { align: 'center' });
            
            y += 35; // Espacio despu√©s del encabezado

            doc.setDrawColor(0);
            doc.setLineWidth(0.3);
            doc.line(margin, y, pageWidth - margin, y);
            y += 5;

            // --- ASUNTO Y FOLIO ---
            doc.setFontSize(11);
            doc.setFont(undefined, 'bold');
            doc.text('CERTIFICADO M√âDICO', margin, y);
            doc.text(`ASUNTO: ${asunto}`, margin, y + lineHeight);
            doc.setFont(undefined, 'normal');
            doc.text(numFolio, margin, y + lineHeight * 2);
            y += lineHeight * 3 + 5;

            // --- INTRODUCCI√ìN ---
            const intro = `Por medio del presente el que Medico ${nombreDoc} C.P. ${cedulaDoc} hago constar que el paciente ${nombreP} con n√∫mero de seguro social: ${nss}.`;
            doc.setFontSize(10);
            y = drawJustifiedText(doc, intro, margin, y, pageWidth - margin*2, lineHeight) + 2;

            doc.setFont(undefined, 'bold');
            doc.text(`Paciente ${sexoP} de ${edadP}:`, margin, y);
            y += lineHeight * 2;

            // --- ANTECEDENTES ---
            doc.setFont(undefined, 'bold');
            doc.text('Antecedentes M√©dicos:', margin, y);
            y += lineHeight;
            doc.setFont(undefined, 'normal');
            y = drawJustifiedText(doc, antecedentes, margin + 5, y, pageWidth - margin*2 - 5, lineHeight) + 2;

            // --- EXAMEN F√çSICO GENERAL ---
            doc.setFont(undefined, 'bold');
            doc.text('Examen F√≠sico General:', margin, y);
            y += lineHeight;
            
            doc.setFont(undefined, 'normal');
            const examenData = [
                `Peso: ${peso}`, `Talla: ${talla}`, `Frecuencia Cardiaca: ${fc}`, 
                `Presi√≥n Arterial: ${ta}`, `Frecuencia Respiratoria: ${fr}`, 
                `Temperatura Corporal: ${temp}`, `Tipo de sangre: ${tipoSangre}`
            ];
            
            let col1X = margin + 5;
            let col2X = margin + 70;
            let col3X = margin + 135;
            
            examenData.forEach((item, index) => {
                let currentX = col1X;
                if (index % 3 === 1) currentX = col2X;
                if (index % 3 === 2) currentX = col3X;
                
                // Asegura el salto de l√≠nea si y excede la p√°gina (aunque con 3 columnas es menos probable)
                if (y > doc.internal.pageSize.getHeight() - 40) {
                    doc.addPage();
                    y = margin;
                }
                
                doc.text(`- ${item}`, currentX, y);
                if (index % 3 === 2 || index === examenData.length - 1) {
                    y += lineHeight;
                }
            });
            y += 2;
            
            // --- DETALLES DE SISTEMAS ---
            doc.setFont(undefined, 'bold');
            doc.text('Detalle de Sistemas:', margin, y);
            y += lineHeight;
            doc.setFont(undefined, 'normal');
            y = drawJustifiedText(doc, sistemas, margin + 5, y, pageWidth - margin*2 - 5, lineHeight) + 2;

            // --- CONCLUSI√ìN ---
            doc.setFont(undefined, 'bold');
            doc.text('Conclusi√≥n:', margin, y);
            y += lineHeight;
            doc.setFont(undefined, 'normal');
            y = drawJustifiedText(doc, conclusion, margin + 5, y, pageWidth - margin*2 - 5, lineHeight) + 15;

            // --- FIRMA Y FECHA ---
            const signatureLineY = y;
            doc.setLineWidth(0.4);
            doc.line(pageWidth/2 - 30, signatureLineY, pageWidth/2 + 30, signatureLineY);

            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text(`DR. (A) ${nombreDoc} CP. ${cedulaDoc}`, pageWidth / 2, y + 4, { align: 'center' });
            doc.setFont(undefined, 'normal');
            doc.text(especialidad, pageWidth / 2, y + 8, { align: 'center' });
            
            doc.text(`A ${fechaEmision.split('del')[0]} del Mes de ${fechaEmision.split('de')[1]} del ${fechaEmision.split('del')[2].trim()}`, pageWidth - margin, y + 18, { align: 'right' });
            
            if (descargar) {
                const safeName = (nombreP || 'PACIENTE').replace(/\s+/g, '_');
                doc.save(`Certificado_IMSS_${safeName}.pdf`);
                return true;
            } else {
                return doc.output('datauristring').split(',')[1];
            }
        }

        // Aseg√∫rate de llamar a loadSolicitudes al cargar la p√°gina si el usuario ya est√° logeado (en un entorno real)
        // Por ahora, solo lo llamamos despu√©s de un login exitoso.
    </script>
</body>
</html>
