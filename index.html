<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Generador de Documentos - Estatus de Solicitud</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>

    <style>
        /* Estilos Base Existentes */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 850px;
            margin: 0 auto;
            padding: 25px;
            background-color: #f4f4f9;
            position: relative;
            padding-bottom: 100px;
        }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 25px; }
        .input-group, .form-section { background-color: #ffffff; padding: 20px; margin-bottom: 25px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h2 { color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-top: 0; }
        label { display: block; margin-top: 15px; margin-bottom: 5px; font-weight: 600; color: #34495e; }
        input[type="text"], input[type="date"], input[type="number"], select {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }
        input[type="text"]:focus, input[type="date"]:focus, input[type="number"]:focus, select:focus {
            border-color: #3498db;
            outline: none;
        }
        .btn-action, .btn-doc {
            background-color: #3498db;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
            width: 100%;
            transition: background-color 0.3s;
        }
        .btn-action:hover, .btn-doc:hover {
            background-color: #2980b9;
        }
        .btn-doc { margin-bottom: 10px; }
        .menu-container { display: flex; flex-direction: column; gap: 10px; }
        .hidden { display: none; }
        .status-container {
            background-color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin-top: 25px;
        }
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #bdc3c7;
        }
        .status-item:last-child { border-bottom: none; }
        .status-pending { color: #f39c12; }
        .status-approved { color: #2ecc71; }
        .status-rejected { color: #e74c3c; }
        .preview-button {
            background-color: #95a5a6;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 10px;
        }
        .preview-button:hover { background-color: #7f8c8d; }
        .pdf-preview-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 700px;
            border-radius: 10px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        #pdf-viewer {
            width: 100%;
            height: 600px;
            border: none;
        }
        .date-container {
            display: flex;
            gap: 20px;
        }
        .date-container > div {
            flex: 1;
        }
        /* Estilos espec√≠ficos para avisos */
        .disclaimer-notice, .payment-notice {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            font-weight: bold;
            text-align: center;
        }
        .disclaimer-notice {
            background-color: #f9e1e1; /* Rojo claro */
            color: #c0392b;
        }
        .payment-notice {
            background-color: #e8f8f5; /* Verde azulado claro */
            color: #1abc9c;
        }
        .back-button {
            background-color: #95a5a6;
            width: auto !important;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <h1>Generador de Documentos M√©dicos </h1>

    <div id="menu" class="menu-container">
        <h2>Selecciona el Tipo de Documento</h2>
        <button class="btn-doc" onclick="showForm('receta_similares')">üíä Receta (Similares)</button>
        <button class="btn-doc" onclick="showForm('certificado_medico_imss')">üè• Certificado M√©dico IMSS</button>
    </div>

    <div id="form-receta_similares" class="form-section hidden">
        <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>

        <div class="disclaimer-notice">
            *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
        </div>
        <div class="payment-notice">
            *PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*
        </div>

        <h2>üíä Formulario de Receta M√©dica (Similares)</h2>
        <div class="input-group">
            <h2>üë§ Datos del Paciente</h2>
            <label for="nombreP">Nombre Completo del Paciente:</label>
            <input type="text" id="nombreP" value="JUAN PEREZ LOPEZ" required>
            <label for="edadP">Edad:</label>
            <input type="number" id="edadP" value="35" required>
            <label for="fechaConsulta">Fecha de Consulta:</label>
            <input type="date" id="fechaConsulta" required>
        </div>

        <div class="input-group">
            <h2>üíä Prescripci√≥n</h2>
            <label for="diagnostico">Diagn√≥stico:</label>
            <input type="text" id="diagnostico" value="Faringoamigdalitis Aguda" required>

            <label for="medicamento1">Medicamento 1:</label>
            <input type="text" id="medicamento1" value="Amoxicilina 500mg" required>
            <label for="indicaciones1">Indicaciones 1:</label>
            <input type="text" id="indicaciones1" value="Tomar 1 tableta cada 8 horas por 7 d√≠as." required>

            <label for="medicamento2">Medicamento 2 (Opcional):</label>
            <input type="text" id="medicamento2" value="Paracetamol 500mg">
            <label for="indicaciones2">Indicaciones 2 (Opcional):</label>
            <input type="text" id="indicaciones2" value="Tomar 1 tableta cada 8 horas solo si hay fiebre o dolor.">
        </div>

        <div class="input-group">
            <h2>üë®‚Äç‚öïÔ∏è Datos del M√©dico</h2>
            <label for="medicoNombre">Nombre del M√©dico:</label>
            <input type="text" id="medicoNombre" value="DR. JULIO G√ìMEZ" required>
            <label for="medicoCedula">C√©dula Profesional:</label>
            <input type="text" id="medicoCedula" value="8765432" required>
            <label for="proximaCita">Pr√≥xima Cita:</label>
            <input type="date" id="proximaCita" required>
        </div>

        <button class="btn-action" onclick="saveSolicitud('receta_similares')">üíæ Guardar Solicitud (Esperar Aprobaci√≥n)</button>
    </div>
    
    <div id="form-certificado_medico_imss" class="form-section hidden">
        <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>

        <div class="disclaimer-notice">
            *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
        </div>
        <div class="payment-notice">
            *PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*
        </div>

        <h2>üè• Formulario de Certificado M√©dico IMSS</h2>
        <div class="input-group">
            <h2>üë§ Datos del Paciente</h2>
            <label for="nombreCert">Nombre Completo del Paciente:</label>
            <input type="text" id="nombreCert" value="JUAN CARLOS PER√âZ L√ìPEZ" required>

            <div class="date-container">
                <div>
                    <label for="edadCert">Edad:</label>
                    <input type="text" id="edadCert" value="25" required>
                </div>
                <div>
                    <label for="sexoCert">Sexo:</label>
                    <input type="text" id="sexoCert" value="MASCULINO" required>
                </div>
            </div>

            <div class="date-container">
                <div>
                    <label for="tipoCert">Tipo (Ej: PRE-ESCOLAR, LICENCIA, ESTUDIOS):</label>
                    <input type="text" id="tipoCert" value="ESTUDIOS" required>
                </div>
                <div>
                    <label for="fechaEmisionCert">Fecha de Emisi√≥n del Certificado:</label>
                    <input type="date" id="fechaEmisionCert" value="" required>
                </div>
            </div>
        </div>

        <div class="input-group">
            <h2>üîé Diagn√≥stico y Examen</h2>
            <label for="diagnosticoCert">Motivo o Diagn√≥stico (Ej: Sin anormalidad evidente):</label>
            <input type="text" id="diagnosticoCert" value="EL EXAMEN F√çSICO NO REVEL√ì ANORMALIDADES APARENTES" required>

            <label for="condicionCert">Condici√≥n (Ej: APTO, NO APTO):</label>
            <input type="text" id="condicionCert" value="APTO PARA" required>
            
            <label for="condicionDestinoCert">Destino de la Condici√≥n (Ej: Realizar estudios, Tr√°mite de licencia):</label>
            <input type="text" id="condicionDestinoCert" value="REALIZAR TR√ÅMITE DE ESTUDIOS" required>

            <label for="pesoCert">Peso (Kg):</label>
            <input type="text" id="pesoCert" value="70" required>
            
            <label for="tallaCert">Talla (m):</label>
            <input type="text" id="tallaCert" value="1.75" required>
        </div>
        
        <div class="input-group">
            <h2>üë®‚Äç‚öïÔ∏è Datos del M√©dico y Firmas</h2>
            <label for="medicoNombreCert">Nombre Completo del M√©dico (Ej: DR. C√âSAR A. M√âNDEZ):</label>
            <input type="text" id="medicoNombreCert" value="DRA. MAR√çA GUADALUPE RAM√çREZ S." required>

            <label for="medicoCedulaCert">C√©dula Profesional (Ej: CED. PROF. 98569946):</label>
            <input type="text" id="medicoCedulaCert" value="CED. PROF. 654321" required>

            <label for="logoCertInput">Insertar LOGO del M√©dico/Instituci√≥n (Esquina superior derecha del PDF):</label>
            <input type="file" id="logoCertInput" accept="image/*">
            
            <label for="firmaCertInput">Firma del M√©dico (Opcional, se coloca sobre la l√≠nea de firma):</label>
            <input type="file" id="firmaCertInput" accept="image/*">
        </div>


        <button class="btn-action" onclick="saveSolicitud('certificado_medico_imss')">üíæ Guardar Solicitud (Esperar Aprobaci√≥n)</button>
    </div>
    
    <div id="status-view" class="status-container">
        <h2>Estatus de Solicitudes Pendientes</h2>
        <div id="solicitudes-list">
            <div class="status-item">
                <span><i class="fas fa-file-medical"></i> Receta Similares (Reciente)</span>
                <div>
                    <span class="status-pending"><i class="fas fa-hourglass-half"></i> Pendiente</span>
                    <button class="preview-button" onclick="previewPDF('receta_similares', { nombreP: 'JUAN PEREZ LOPEZ', edadP: '35', fechaConsulta: '2025-10-28', diagnostico: 'Faringoamigdalitis Aguda', medicamento1: 'Amoxicilina 500mg', indicaciones1: 'Tomar 1 tableta cada 8 horas por 7 d√≠as.', medicamento2: 'Paracetamol 500mg', indicaciones2: 'Tomar 1 tableta cada 8 horas solo si hay fiebre o dolor.', medicoNombre: 'DR. JULIO G√ìMEZ', medicoCedula: '8765432', proximaCita: '2025-11-04' })">Ver Borrador</button>
                </div>
            </div>
            <div class="status-item">
                <span><i class="fas fa-certificate"></i> Certificado M√©dico IMSS (Reciente)</span>
                <div>
                    <span class="status-pending"><i class="fas fa-hourglass-half"></i> Pendiente</span>
                    <button class="preview-button" onclick="previewPDF('certificado_medico_imss', { nombreCert: 'JUAN CARLOS PER√âZ L√ìPEZ', edadCert: '25', sexoCert: 'MASCULINO', tipoCert: 'ESTUDIOS', fechaEmisionCert: '2025-10-28', diagnosticoCert: 'EL EXAMEN F√çSICO NO REVEL√ì ANORMALIDADES APARENTES', condicionCert: 'APTO PARA', condicionDestinoCert: 'REALIZAR TR√ÅMITE DE ESTUDIOS', pesoCert: '70', tallaCert: '1.75', medicoNombreCert: 'DRA. MAR√çA GUADALUPE RAM√çREZ S.', medicoCedulaCert: 'CED. PROF. 654321' })">Ver Borrador</button>
                    <button class="preview-button" style="background-color: #2ecc71;" onclick="downloadPDF('certificado_medico_imss', { nombreCert: 'JUAN CARLOS PER√âZ L√ìPEZ', edadCert: '25', sexoCert: 'MASCULINO', tipoCert: 'ESTUDIOS', fechaEmisionCert: '2025-10-28', diagnosticoCert: 'EL EXAMEN F√çSICO NO REVEL√ì ANORMALIDADES APARENTES', condicionCert: 'APTO PARA', condicionDestinoCert: 'REALIZAR TR√ÅMITE DE ESTUDIOS', pesoCert: '70', tallaCert: '1.75', medicoNombreCert: 'DRA. MAR√çA GUADALUPE RAM√çREZ S.', medicoCedulaCert: 'CED. PROF. 654321' })"><i class="fas fa-download"></i> Descargar (Aprobado)</button>
                </div>
            </div>
        </div>
    </div>

    <div id="pdf-modal" class="pdf-preview-modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <h3>Vista Previa del Documento</h3>
            <iframe id="pdf-viewer"></iframe>
            <button class="btn-action" onclick="downloadPDFFromModal()">Descargar PDF</button>
        </div>
    </div>

    <script>
        // Mantener una referencia global a la solicitud actual para la descarga desde el modal
        let currentDownloadData = null;
        let currentDownloadType = null;
        
        // Funci√≥n para cambiar la vista (Men√∫, Formularios)
        function showForm(formId) {
            document.getElementById('menu').classList.add('hidden');
            document.getElementById('form-receta_similares').classList.add('hidden');
            document.getElementById('form-certificado_medico_imss').classList.add('hidden'); // Oculta el nuevo formulario

            if (formId !== 'menu') {
                document.getElementById(formId).classList.remove('hidden');
            } else {
                document.getElementById('menu').classList.remove('hidden');
            }
        }

        // Funci√≥n para leer archivos (logo/firma) como Data URL
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }


        // Funci√≥n que guarda los datos del formulario (Simulaci√≥n)
        function saveSolicitud(tipo) {
            let data = {};
            let formValid = true;

            if (tipo === 'receta_similares') {
                // L√≥gica de recolecci√≥n de datos para Receta
                data.nombreP = document.getElementById('nombreP').value;
                data.edadP = document.getElementById('edadP').value;
                data.fechaConsulta = document.getElementById('fechaConsulta').value;
                data.diagnostico = document.getElementById('diagnostico').value;
                data.medicamento1 = document.getElementById('medicamento1').value;
                data.indicaciones1 = document.getElementById('indicaciones1').value;
                data.medicamento2 = document.getElementById('medicamento2').value;
                data.indicaciones2 = document.getElementById('indicaciones2').value;
                data.medicoNombre = document.getElementById('medicoNombre').value;
                data.medicoCedula = document.getElementById('medicoCedula').value;
                data.proximaCita = document.getElementById('proximaCita').value;

                if (!data.nombreP || !data.fechaConsulta || !data.medicamento1) formValid = false;
            } else if (tipo === 'certificado_medico_imss') {
                // L√≥gica de recolecci√≥n de datos para Certificado M√©dico IMSS
                data.nombreCert = document.getElementById('nombreCert').value;
                data.edadCert = document.getElementById('edadCert').value;
                data.sexoCert = document.getElementById('sexoCert').value;
                data.tipoCert = document.getElementById('tipoCert').value;
                data.fechaEmisionCert = document.getElementById('fechaEmisionCert').value;
                data.diagnosticoCert = document.getElementById('diagnosticoCert').value;
                data.condicionCert = document.getElementById('condicionCert').value;
                data.condicionDestinoCert = document.getElementById('condicionDestinoCert').value;
                data.pesoCert = document.getElementById('pesoCert').value;
                data.tallaCert = document.getElementById('tallaCert').value;
                data.medicoNombreCert = document.getElementById('medicoNombreCert').value;
                data.medicoCedulaCert = document.getElementById('medicoCedulaCert').value;

                if (!data.nombreCert || !data.fechaEmisionCert || !data.diagnosticoCert) formValid = false;
            }

            if (!formValid) {
                alert("Por favor, rellena todos los campos requeridos.");
                return;
            }

            alert(`Solicitud de ${tipo.replace('_', ' ').toUpperCase()} guardada con √©xito. Esperando aprobaci√≥n.`);
            
            // Simulaci√≥n: Volver al men√∫ despu√©s de guardar
            showForm('menu');
        }

        // Muestra el modal con la previsualizaci√≥n del PDF
        async function previewPDF(tipo, data) {
            const dataUri = await generatePDF(tipo, data, false);
            if (dataUri) {
                document.getElementById('pdf-viewer').src = `data:application/pdf;base64,${dataUri}`;
                document.getElementById('pdf-modal').style.display = 'block';
                // Establecer datos para posible descarga desde el modal
                currentDownloadData = data;
                currentDownloadType = tipo;
            } else {
                alert('Error al generar la vista previa del PDF.');
            }
        }

        // Cierra el modal de previsualizaci√≥n
        function closeModal() {
            document.getElementById('pdf-modal').style.display = 'none';
            document.getElementById('pdf-viewer').src = '';
            currentDownloadData = null;
            currentDownloadType = null;
        }

        // Inicia la descarga
        async function downloadPDF(tipo, data) {
            await generatePDF(tipo, data, true);
        }

        // Descarga el PDF si la descarga es iniciada desde el modal
        function downloadPDFFromModal() {
            if (currentDownloadData && currentDownloadType) {
                generatePDF(currentDownloadType, currentDownloadData, true);
            }
        }

        // Funci√≥n principal para determinar qu√© PDF generar
        async function generatePDF(tipo, data, descargar = false) {
            switch (tipo) {
                case 'receta_similares':
                    return generatePDFRecetaSimilares(data, descargar);
                
                // CASO AGREGADO: CERTIFICADO M√âDICO IMSS
                case 'certificado_medico_imss':
                    return generatePDFCertificadoMedicoIMSS(data, descargar);

                default:
                    console.error(`Tipo de documento desconocido: ${tipo}`);
                    return false;
            }
        }

        // =========================================================================================
        // L√ìGICA DE GENERACI√ìN DE PDF - RECETA SIMILARES (Existente)
        // =========================================================================================
        function generatePDFRecetaSimilares(data, descargar = false) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'letter');
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 20;
            let y = 15;

            // Datos de la receta
            const nombreP = data.nombreP;
            const edadP = data.edadP;
            const fechaConsulta = new Date(data.fechaConsulta).toLocaleDateString('es-ES');
            const diagnostico = data.diagnostico;
            const proxima = new Date(data.proximaCita).toLocaleDateString('es-ES');

            // Encabezado
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('RECETA M√âDICA', pageWidth / 2, y, { align: 'center' });
            y += 8;

            // Separador (L√≠nea)
            doc.setLineWidth(0.5);
            doc.line(margin, y, pageWidth - margin, y);
            y += 5;

            // Datos del Paciente
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('NOMBRE:', margin, y);
            doc.setFont(undefined, 'normal');
            doc.text(nombreP, margin + 20, y);

            doc.setFont(undefined, 'bold');
            doc.text('EDAD:', pageWidth / 2, y);
            doc.setFont(undefined, 'normal');
            doc.text(edadP, pageWidth / 2 + 15, y);

            doc.setFont(undefined, 'bold');
            doc.text('FECHA:', pageWidth - margin - 30, y);
            doc.setFont(undefined, 'normal');
            doc.text(fechaConsulta, pageWidth - margin - 15, y);
            y += 8;

            // Diagn√≥stico
            doc.setFont(undefined, 'bold');
            doc.text('DIAGN√ìSTICO:', margin, y);
            doc.setFont(undefined, 'normal');
            doc.text(diagnostico, margin + 30, y);
            y += 10;

            // Prescripci√≥n
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('P R E S C R I P C I √ì N:', margin, y);
            y += 6;

            // Medicamento 1
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('1.', margin, y);
            doc.text(data.medicamento1, margin + 10, y);
            y += 6;
            doc.setFont(undefined, 'normal');
            doc.text('INDICACIONES:', margin + 10, y);
            doc.text(data.indicaciones1, margin + 35, y);
            y += 8;

            // Medicamento 2 (si existe)
            if (data.medicamento2) {
                doc.setFont(undefined, 'bold');
                doc.text('2.', margin, y);
                doc.text(data.medicamento2, margin + 10, y);
                y += 6;
                doc.setFont(undefined, 'normal');
                doc.text('INDICACIONES:', margin + 10, y);
                doc.text(data.indicaciones2, margin + 35, y);
                y += 8;
            }

            // Datos del M√©dico y Cita
            y += 10;
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('DR./DRA.:', margin, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.medicoNombre, margin + 20, y);
            y += 5;

            doc.setFont(undefined, 'bold');
            doc.text('C√âDULA PROFESIONAL:', margin, y);
            doc.setFont(undefined, 'normal');
            doc.text(data.medicoCedula, margin + 45, y);
            y += 12;

            doc.setFont(undefined, 'bold');
            doc.text('PR√ìXIMA CITA:', margin, y);
            doc.setFont(undefined, 'normal');
            doc.text(proxima, margin + 30, y);
            y += 12;

            // L√≠nea para firma
            const firmaX = pageWidth - margin - 60;
            doc.setLineWidth(0.4);
            doc.line(firmaX, y, firmaX + 50, y);
            doc.setFont(undefined, 'normal');
            doc.text('COPIA', firmaX - 30, y);
            doc.setFont(undefined, 'bold');
            doc.text('FIRMA:', firmaX, y + 4);

            y += 18;

            // L√≠nea punteada inferior
            const dashY = doc.internal.pageSize.getHeight() - 28;
            const dashStartX = margin;
            const dashEndX = pageWidth - margin;
            const dashLen = 3;
            const gapLen = 3;
            let cursor = dashStartX;
            doc.setDrawColor(0);
            doc.setLineWidth(0.4);
            while (cursor < dashEndX) {
                doc.line(cursor, dashY, Math.min(cursor + dashLen, dashEndX), dashY);
                cursor += dashLen + gapLen;
            }

            if (descargar) {
                const safeName = (nombreP || 'PACIENTE').replace(/\s+/g, '_');
                doc.save(`Receta_Similares_${safeName}.pdf`);
                return true;
            } else {
                return doc.output('datauristring').split(',')[1];
            }
        }
        
        // =========================================================================================
        // NUEVO: L√ìGICA DE GENERACI√ìN DE PDF - CERTIFICADO M√âDICO IMSS
        // =========================================================================================
        /**
         * Genera el PDF para el Certificado M√©dico IMSS con el formato de la imagen proporcionada.
         * @param {Object} data - Datos de la solicitud.
         * @param {boolean} descargar - Indica si se debe guardar el PDF.
         * @returns {string|boolean} Retorna el data URI si no se descarga, o true si se descarga.
         */
        async function generatePDFCertificadoMedicoIMSS(data, descargar = false) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'letter'); // Carta (8.5 x 11 in)
            const pageWidth = doc.internal.pageSize.getWidth();
            const marginX = 20; // Margen en X
            let y = 30; // Posici√≥n Y inicial

            // ----------------------------------------------------
            // 1. Logo (Esquina superior derecha) - CONFIGURACI√ìN SOLICITADA
            // ----------------------------------------------------
            const logoFile = document.getElementById('logoCertInput').files[0];
            if (logoFile) {
                try {
                    const logoDataUrl = await readFileAsDataURL(logoFile);
                    const logoWidth = 30;
                    const logoHeight = 30; 
                    const logoX = pageWidth - marginX - logoWidth; 
                    doc.addImage(logoDataUrl, logoFile.type.split('/')[1].toUpperCase(), logoX, 15, logoWidth, logoHeight);
                } catch (error) {
                    console.error("Error al cargar la imagen del logo:", error);
                }
            }


            // ----------------------------------------------------
            // 2. T√≠tulo y Encabezado IMSS (Izquierda)
            // ----------------------------------------------------
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            // Texto IMSS arriba
            doc.text('INSTITUTO MEXICANO DEL SEGURO SOCIAL', marginX, 15);
            doc.text('SECRETAR√çA DE SALUD', marginX, 20);

            // T√≠tulo Central
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('CERTIFICADO M√âDICO', pageWidth / 2, y, { align: 'center' });
            y += 10;
            
            // Subt√≠tulo
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`TIPO DE EXAMEN: ${data.tipoCert.toUpperCase()}`, marginX, y);
            y += 10;


            // ----------------------------------------------------
            // 3. Contenido Principal del Certificado
            // ----------------------------------------------------

            // Primera L√≠nea: Yo, M√©dico...
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const nombreMedico = data.medicoNombreCert.toUpperCase();
            const cedulaMedico = data.medicoCedulaCert.toUpperCase();
            const nombrePaciente = data.nombreCert.toUpperCase();
            
            let text = `EL (LA) SUSCRITO (A), M√âDICO CON C√âDULA PROFESIONAL NO. ${cedulaMedico}, ADSCRITO AL SERVICIO DE MEDICINA FAMILIAR DEL INSTITUTO MEXICANO DEL SEGURO SOCIAL, CERTIFICA HABER EFECTUADO LA EXPLORACI√ìN F√çSICA AL (A LA) C. ${nombrePaciente}, `;
            // Calcula la altura necesaria para el texto con salto de l√≠nea
            const textDimensions = doc.getTextDimensions(text, { maxWidth: pageWidth - (2 * marginX) });
            doc.text(text, marginX, y, { maxWidth: pageWidth - (2 * marginX) });
            y += textDimensions.h + 2; 

            // Segunda L√≠nea: ...Edad, Sexo, Diagn√≥stico
            doc.setFont(undefined, 'bold');
            const edadSexo = `DE ${data.edadCert.toUpperCase()} A√ëOS DE EDAD, ${data.sexoCert.toUpperCase()}, QUIEN A LA EXPLORACI√ìN CL√çNICA SE ENCONTR√ì:`;
            doc.text(edadSexo, marginX, y);
            y += 7;

            // L√≠nea de Diagn√≥stico
            doc.setFont(undefined, 'normal');
            const diagnostico = data.diagnosticoCert.toUpperCase();
            const diagDimensions = doc.getTextDimensions(diagnostico, { maxWidth: pageWidth - (2 * marginX) });
            doc.text(diagnostico, marginX, y, { maxWidth: pageWidth - (2 * marginX) });
            y += diagDimensions.h + 5;

            // Signos Vitales y Medidas
            const infoFisica = [
                `PESO: ${data.pesoCert} KG`,
                `TALLA: ${data.tallaCert} M`,
            ];
            let xPos = marginX;
            infoFisica.forEach((item) => {
                doc.text(item, xPos, y);
                xPos += 50; 
            });
            y += 10;

            // L√≠nea de Apto/No Apto
            doc.setFont(undefined, 'bold');
            const aptoText = `SE CERTIFICA QUE EL (LA) C. ${nombrePaciente} ES DECLARADO(A) ${data.condicionCert.toUpperCase()} PARA ${data.condicionDestinoCert.toUpperCase()}.`;
            doc.text(aptoText, marginX, y, { maxWidth: pageWidth - (2 * marginX) });
            y += 10;

            // L√≠nea de Ciudad y Fecha
            doc.setFont(undefined, 'normal');
            const fecha = new Date(data.fechaEmisionCert).toLocaleDateString('es-ES', { day: '2-digit', month: 'long', year: 'numeric' }).toUpperCase();
            const ciudadFecha = `SE EXTIENDE EL PRESENTE CERTIFICADO A LOS ${fecha.replace('DE', 'D√çAS DE')}.`;
            doc.text(ciudadFecha, marginX, y);
            y += 20;


            // ----------------------------------------------------
            // 4. Firmas
            // ----------------------------------------------------
            
            // Firma y C√©dula del M√©dico
            const firmaY = y;
            const lineaX = pageWidth / 2;
            const lineaW = 70;

            // Espacio para la Firma
            doc.setLineWidth(0.5);
            doc.line(lineaX - lineaW / 2, firmaY, lineaX + lineaW / 2, firmaY); // L√≠nea
            
            // Colocar Firma si se subi√≥
            const firmaFile = document.getElementById('firmaCertInput').files[0];
            if (firmaFile) {
                try {
                    const firmaDataUrl = await readFileAsDataURL(firmaFile);
                    const firmaWidth = 60;
                    const firmaHeight = 15; 
                    const firmaX = lineaX - firmaWidth / 2; 
                    doc.addImage(firmaDataUrl, firmaFile.type.split('/')[1].toUpperCase(), firmaX, firmaY - 15, firmaWidth, firmaHeight);
                } catch (error) {
                    console.error("Error al cargar la imagen de la firma:", error);
                }
            }

            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('M√âDICO QUE EXTIENDE EL CERTIFICADO', lineaX, firmaY + 5, { align: 'center' });
            
            doc.setFont(undefined, 'normal');
            doc.text(`${nombreMedico}`, lineaX, firmaY + 10, { align: 'center' });
            doc.text(`${cedulaMedico}`, lineaX, firmaY + 15, { align: 'center' });
            
            // ----------------------------------------------------
            // 5. Nota legal (Parte inferior)
            // ----------------------------------------------------
            doc.setFontSize(8);
            doc.setFont(undefined, 'normal');
            const notaLegalY = doc.internal.pageSize.getHeight() - 20;
            const notaLegal = 'ESTE DOCUMENTO SOLO TIENE VALIDEZ PARA EL TR√ÅMITE QUE FUE SOLICITADO Y NO IMPLICA COMPROMISO DE ATENCI√ìN M√âDICA EN OTRA INSTITUCI√ìN.';
            doc.text(notaLegal, pageWidth / 2, notaLegalY, { align: 'center' });


            if (descargar) {
                const safeName = (data.nombreCert || 'PACIENTE').replace(/[\s\W]+/g, '_');
                doc.save(`Certificado_Medico_IMSS_${safeName}.pdf`);
                return true;
            } else {
                return doc.output('datauristring').split(',')[1];
            }
        }

        // Simulaci√≥n: Inicializar la vista en el men√∫
        document.addEventListener('DOMContentLoaded', () => {
            showForm('menu');
        });
    </script>
</body>
</html>
