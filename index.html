<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Generador de Documentos - Estatus de Solicitud</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>

    <style>
        /* Estilos Base Existentes */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 850px;
            margin: 0 auto;
            padding: 25px;
            background-color: #f4f4f9;
            position: relative;
            padding-bottom: 100px;
        }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 25px; }
        .input-group, .form-section { background-color: #ffffff; padding: 20px; margin-bottom: 25px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h2 { color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 5px; margin-bottom: 15px; }
        label { display: block; margin-top: 10px; font-weight: bold; color: #555; }
        input[type="text"], input[type="date"], textarea, input[type="file"], input[type="password"], input[type="email"], select {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .date-container { display:flex; justify-content:space-between; gap:10px; }
        .date-container input, .date-container select { width:100%; }
        textarea { height:120px; resize:vertical; }
        .btn-action {
            background-color: #e67e22;
            color: white;
            padding: 15px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            width: 100%;
            margin-top: 10px;
            transition: background-color 0.3s;
        }
        .btn-action:hover { background-color: #d35400; }
        .back-button { background-color: #95a5a6; width:auto; padding:10px 15px; font-size:1em; }
        
        /* Estilos para Transiciones Fluidas */
        .form-section, #main-menu {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
            display: none; 
        }
        .form-section.active, #main-menu.active {
            opacity: 1;
            pointer-events: auto;
            display: block !important;
        }

        .status-page { text-align:center; padding:50px; background-color:#fff; border-radius:8px; box-shadow:0 4px 8px rgba(0,0,0,0.1); min-height:250px; display:flex; flex-direction:column; justify-content:center; }
        .status-page .spinner { border:5px solid #f3f3f3; border-top:5px solid #3498db; border-radius:50%; width:50px; height:50px; animation: spin 2s linear infinite; margin:20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-download-now { background-color:#27ae60; margin-top:20px; width:50%; margin:20px auto; }
        .payment-notice { background-color:#eaf7ff; color:#2980b9; padding:10px; border:1px solid #3498db; border-radius:4px; margin-bottom:15px; text-align:center; font-weight:bold; font-size:0.95em; }
        .disclaimer-notice { background-color:#fcebeb; color:#c0392b; padding:10px; border:1px solid #c0392b; border-radius:4px; margin-bottom:20px; text-align:center; font-weight:bold; font-size:0.85em; }
        .whatsapp-float { position:fixed; width:60px; height:60px; bottom:40px; left:20px; background-color:#25d366; color:#fff; border-radius:50px; text-align:center; font-size:30px; box-shadow:2px 2px 3px #999; z-index:100; display:flex; align-items:center; justify-content:center; text-decoration:none;}
        .whatsapp-float:hover { background-color:#128c7e; }
        .fixed-payment-info { position:fixed; bottom:0; right:0; background-color:#34495e; color:white; padding:10px 15px; border-top-left-radius:8px; font-size:0.85em; z-index:99; text-align:right; max-width:350px; }
        .fixed-payment-info strong { color:#f1c40f; }
        .fixed-payment-info p { margin:2px 0; }
        .request-item, .client-item { border:1px solid #ccc; padding:10px; margin-bottom:10px; background-color:#fff; display:flex; justify-content:space-between; align-items:center; }
        .request-actions button { width:auto; padding:8px 12px; font-size:0.9em; margin-left:10px; }
        .btn-authorize { background-color:#3498db; color:#fff; border:none; padding:8px 10px; border-radius:4px; cursor:pointer; }
        .btn-reject { background-color:#c0392b; color:#fff; border:none; padding:8px 10px; border-radius:4px; cursor:pointer; }
        .download-link-box { background-color:#f0f0f0; border:1px dashed #3498db; padding:10px; margin-top:10px; word-break:break-all; font-size:0.9em; }
        input[type="file"] { padding:6px 10px; }

        /* Estilos de Grid y Men√∫ */
        .icon-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 10px;
            margin-bottom: 25px;
        }
        .menu-card {
            background-color: #ffffff;
            color: #34495e;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 120px; 
            border: 1px solid #eee;
        }
        .menu-card:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 15px rgba(0,0,0,0.25);
        }
        .menu-card i {
            font-size: 2.5em;
            margin-bottom: 8px;
            transition: color 0.3s ease;
        }
        .menu-card strong {
            font-size: 0.9em;
            font-weight: bold;
            display: block;
            line-height: 1.3;
        }

        /* Colores espec√≠ficos para las categor√≠as */
        .category-social i { color: #25d366; }
        .category-carta i { color: #e67e22; }
        .category-receta i { color: #27ae60; }
        .category-certificado i { color: #3498db; }
        .category-especializado i { color: #9b59b6; }
        
        /* Estilos para el log de actividad y settings */
        #activity-log-display {
            max-height: 300px;
            overflow-y: scroll;
            border: 1px solid #ddd;
            padding: 10px;
            background-color: #f9f9f9;
            margin-bottom: 25px;
        }
        .log-entry {
            border-bottom: 1px dashed #eee;
            padding: 5px 0;
            font-size: 0.85em;
        }
        .log-entry:last-child {
            border-bottom: none;
        }
        .admin-setting-item {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 15px;
            background-color: #f9f9f9;
        }
        .admin-setting-item img {
            max-width: 100px;
            max-height: 100px;
            border: 1px solid #eee;
            display: block;
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <h1>üìù Generador de Documentos y Solicitudes</h1>

    <div class="disclaimer-notice">
        *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
    </div>

    <div id="app-container">

        <div id="auth-splash" class="form-section active">
            <h2>üë§ Acceso Requerido</h2>
            <p>Inicie sesi√≥n para acceder al men√∫ de servicios, o reg√≠strese si es un usuario nuevo.</p>

            <div id="login-form" class="input-group">
                <h3>Iniciar Sesi√≥n</h3>
                <label for="loginUser">Correo Electr√≥nico:</label>
                <input type="email" id="loginUser" placeholder="Correo electr√≥nico">
                <label for="loginPass">Contrase√±a:</label>
                <input type="password" id="loginPass" placeholder="Ingrese su contrase√±a">
                <button class="btn-action" style="background-color:#2c3e50;" onclick="authenticateUser()">Iniciar Sesi√≥n</button>
            </div>
            
            <div class="input-group">
                <h3>¬øNo tiene cuenta?</h3>
                <p>Reg√≠strese y espere la autorizaci√≥n del administrador.</p>
                <button class="btn-action back-button" style="background-color: #3498db;" onclick="showForm('register')">Reg√≠strarme Ahora</button>
            </div>
        </div>
        <div id="form-register" class="form-section">
            <button class="back-button" onclick="showForm('auth_splash')">‚Üê Volver al Acceso</button>
            <h2>üìù Registro de Nuevo Usuario</h2>
            <p>Complete los datos. Su cuenta quedar√° en estado <strong>PENDIENTE</strong> hasta que el administrador la apruebe.</p>
            <div class="input-group">
                <label for="regName">Nombre Completo:</label>
                <input type="text" id="regName" placeholder="Su nombre completo" required>
                <label for="regUser">Correo Electr√≥nico (Ser√° su Usuario):</label>
                <input type="email" id="regUser" placeholder="Ingrese su email" required>
                <label for="regPass">Contrase√±a:</label>
                <input type="password" id="regPass" placeholder="Cree una contrase√±a" required>
                <button class="btn-action" style="background-color:#27ae60;" onclick="registerUser()">Registrar Solicitud de Cuenta</button>
            </div>
        </div>
        <div id="main-menu">
            
            <h2>üåê Acceso a Grupo y Soporte</h2>
            <div class="icon-grid">
                <div class="menu-card category-social" onclick="showForm('whatsapp_group')">
                    <i class="fab fa-whatsapp"></i>
                    <strong>Unirse a nuestro Grupo de WhatsApp</strong>
                </div>
            </div>
            
            <hr/>
            <h2>‚úâÔ∏è Cartas de Recomendaci√≥n</h2>
            <div class="icon-grid">
                <div class="menu-card category-carta" onclick="showForm('laboral')">
                    <i class="fas fa-briefcase"></i>
                    <strong>Carta LABORAL</strong>
                </div>
                <div class="menu-card category-carta" onclick="showForm('personal')">
                    <i class="fas fa-user-friends"></i>
                    <strong>Carta PERSONAL</strong>
                </div>
            </div>

            <hr/>
            
            <h2>üíä Documentos M√©dicos y Recetas</h2>
            <div class="icon-grid">
                <div class="menu-card category-receta" onclick="showForm('incapacidad_imss')">
                    <i class="fas fa-user-minus"></i>
                    <strong>Incapacidad IMSS</strong>
                </div>
                <div class="menu-card category-receta" onclick="showForm('receta_similares')">
                    <i class="fas fa-prescription-bottle-alt"></i>
                    <strong>Receta SIMILARES</strong>
                </div>
                <div class="menu-card category-receta" onclick="showForm('receta_ahorro')">
                    <i class="fas fa-pills"></i>
                    <strong>Receta DEL AHORRO</strong>
                </div>
                <div class="menu-card category-receta" onclick="showForm('certificado_medico_imss')">
                    <i class="fas fa-notes-medical"></i>
                    <strong>Certificado M√©dico IMSS</strong>
                </div>
            </div>

            <hr/>
            
            <h2>üéì Certificados de Estudios</h2>
            <div class="icon-grid">
                <div class="menu-card category-certificado" onclick="showForm('cert_primaria')">
                    <i class="fas fa-child"></i>
                    <strong>Certificado PRIMARIA</strong>
                </div>
                <div class="menu-card category-certificado" onclick="showForm('cert_secundaria')">
                    <i class="fas fa-graduation-cap"></i>
                    <strong>Certificado SECUNDARIA</strong>
                </div>
                <div class="menu-card category-certificado" onclick="showForm('cert_prepa')">
                    <i class="fas fa-university"></i>
                    <strong>Certificado PREPARATORIA</strong>
                </div>
            </div>

            <hr/>
            
            <h2>‚≠ê Servicios Especializados</h2>
            <div class="icon-grid">
                <div class="menu-card category-especializado" onclick="showForm('metodo_shein')">
                    <i class="fas fa-shopping-bag"></i>
                    <strong>Metodo Shein</strong>
                </div>
                <div class="menu-card category-especializado" onclick="showForm('metodo_cinepolis')">
                    <i class="fas fa-film"></i>
                    <strong>Metodo Cin√©polis</strong>
                </div>
                <div class="menu-card category-especializado" onclick="showForm('metodo_temu')">
                    <i class="fas fa-gift"></i>
                    <strong>Metodo TEMU</strong>
                </div>
                <div class="menu-card category-especializado" onclick="showForm('cv_desde_cero')">
                    <i class="fas fa-file-alt"></i>
                    <strong>CV DESDE CERO</strong>
                </div>
                <div class="menu-card category-especializado" onclick="showForm('sellos_personales')">
                    <i class="fas fa-stamp"></i>
                    <strong>SELLOS PERSONALES</strong>
                </div>
                <div class="menu-card category-especializado" onclick="showForm('formato_solicitud_pdf')">
                    <i class="fas fa-file-pdf"></i>
                    <strong>FORMATO DE SOLICITUD</strong>
                </div>
            </div>
            
            <hr/>

            <button class="btn-action back-button" style="margin-top:10px;" onclick="logOut()">Cerrar Sesi√≥n</button>

        </div>
        <div id="admin-dashboard" class="form-section">
            <button class="back-button" onclick="logOut()">‚Üê Cerrar Sesi√≥n</button>
            <h2>‚öôÔ∏è Panel de Administrador</h2>

            <div id="admin-settings" class="input-group">
                <h3>üñºÔ∏è Configuraci√≥n Global de Im√°genes (Default)</h3>
                <p style="font-size: 0.9em; color: #c0392b; font-weight: bold;">‚ö†Ô∏è Las im√°genes subidas aqu√≠ ser√°n usadas por defecto en los PDF de Certificado M√©dico IMSS y Receta Similares, sobreescribiendo las opciones del cliente.</p>

                <div class="admin-setting-item">
                    <h4>Logo / Membrete por Defecto (IMSS / Similares)</h4>
                    <label for="defaultLogoInput">Subir Nuevo Logo/Membrete (PNG/JPG):</label>
                    <input type="file" id="defaultLogoInput" accept="image/*">
                    <button class="btn-action" style="background-color: #1abc9c; width: auto; padding: 10px 15px;" onclick="uploadDefaultImage('logo')">Guardar Logo por Defecto</button>
                    <p style="margin-top: 10px;">Logo Actual:</p>
                    <img id="defaultLogoPreview" src="" alt="Logo no configurado" style="display: none; max-width: 150px;"/>
                </div>

                <div class="admin-setting-item">
                    <h4>Firma del M√©dico por Defecto (Similares / IMSS)</h4>
                    <label for="defaultSignatureInput">Subir Nueva Firma (PNG/JPG):</label>
                    <input type="file" id="defaultSignatureInput" accept="image/*">
                    <button class="btn-action" style="background-color: #1abc9c; width: auto; padding: 10px 15px;" onclick="uploadDefaultImage('signature')">Guardar Firma por Defecto</button>
                    <p style="margin-top: 10px;">Firma Actual:</p>
                    <img id="defaultSignaturePreview" src="" alt="Firma no configurada" style="display: none; max-width: 150px; height: auto;"/>
                </div>
            </div>

            <h3>Clientes Registrados (Autorizaci√≥n)</h3>
            <div id="client-authorization-list" class="input-group">
                <p id="no-clients-msg">Cargando lista de clientes...</p>
            </div>
            
            <h3>Registro de Actividad del √öltimo Cliente Seleccionado</h3>
            <div id="activity-log-display" class="input-group">
                <p>Seleccione un cliente para ver su actividad detallada.</p>
            </div>

            <h3>Solicitudes de Documentos Pendientes</h3>
            <p>Al autorizar, el cliente ver√° autom√°ticamente el bot√≥n de descarga en su p√°gina de espera.</p>
            <div id="pending-requests-list" class="input-group">
                <p id="no-requests-msg">No hay solicitudes pendientes.</p>
            </div>
        </div>
        
        <div id="form-certificado_medico_imss" class="form-section">
            <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>
            <div class="disclaimer-notice">
                *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
            </div>
            <div class="payment-notice">
                *PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*
            </div>
            <h2>üè• Certificado M√©dico IMSS</h2>
            
            <div class="input-group">
                <h2>üñºÔ∏è Logo / Membrete (Opcional)</h2>
                <p style="font-size: 0.9em; color: #2980b9; font-weight: bold;">*Nota: Se usar√° la imagen por defecto del administrador si est√° configurada, ignorando esta opci√≥n.*</p>
                <label for="certImssLogoInput">Seleccionar Imagen para Logo/Membrete (PNG/JPG):</label>
                <input type="file" id="certImssLogoInput" accept="image/*">
            </div>

            <div class="input-group">
                <h2>üë®‚Äç‚öïÔ∏è Datos del M√©dico</h2>
                <label for="certImssDoctorNombre">Nombre del M√©dico (Ej: DRA. YESSICA MEJ√çA CARRANZA):</label>
                <input type="text" id="certImssDoctorNombre" value="DRA. YESSICA MEJ√çA CARRANZA" required>
                
                <label for="certImssDoctorCedula">C√©dula Profesional (Ej: C.P. 5866652):</label>
                <input type="text" id="certImssDoctorCedula" value="C.P. 5866652" required>

                <label for="certImssDoctorEspecialidad">Especialidad (Ej: Medicina Familiar):</label>
                <input type="text" id="certImssDoctorEspecialidad" value="Medicina Familiar" required>

                <div class="date-container">
                    <div>
                        <label for="certImssUmf">UMF No. (Ej: 67):</label>
                        <input type="text" id="certImssUmf" value="UMF 67" required>
                    </div>
                    <div>
                        <label for="certImssDoctorConsultorio">Consultorio (Ej: 5):</label>
                        <input type="text" id="certImssDoctorConsultorio" value="5" required>
                    </div>
                    <div>
                        <label for="certImssDoctorTurno">Turno (Ej: Vespertino):</label>
                        <input type="text" id="certImssDoctorTurno" value="Vespertino" required>
                    </div>
                </div>
            </div>

            <div class="input-group">
                <h2>üë§ Datos del Paciente</h2>
                <label for="certImssNombre">Nombre Completo del Paciente:</label>
                <input type="text" id="certImssNombre" value="CARMEN MORELOS HERN√ÅNDEZ" required>

                <label for="certImssNss">N√∫mero de Seguridad Social (NSS):</label>
                <input type="text" id="certImssNss" value="1715950626-4" required>

                <div class="date-container">
                    <div>
                        <label for="certImssEdad">Edad (A√±os):</label>
                        <input type="number" id="certImssEdad" value="30" required>
                    </div>
                    <div>
                        <label for="certImssSexo">Sexo:</label>
                        <select id="certImssSexo" required>
                            <option value="Femenino">Femenino</option>
                            <option value="Masculino">Masculino</option>
                        </select>
                    </div>
                </div>

                <div class="date-container">
                    <div>
                        <label for="certImssFechaNac">Fecha de Nacimiento:</label>
                        <input type="date" id="certImssFechaNac" value="1995-01-01" required>
                    </div>
                    <div>
                        <label for="certImssTipoSangre">Tipo de Sangre (Ej: O+):</label>
                        <input type="text" id="certImssTipoSangre" value="O+" required>
                    </div>
                </div>
                
                <label for="certImssDireccion">Direcci√≥n/Localidad (Ej: SANTA CLARA ECATEPEC ESTADO DE M√âXICO):</label>
                <input type="text" id="certImssDireccion" value="SANTA CLARA ECATEPEC ESTADO DE M√âXICO" required>
            </div>

            <div class="input-group">
                <h2>üìà Examen F√≠sico y Conclusi√≥n</h2>
                <div class="date-container">
                    <div>
                        <label for="certImssPeso">Peso (Ej: 90.00kg):</label>
                        <input type="text" id="certImssPeso" value="90.00kg" required>
                    </div>
                    <div>
                        <label for="certImssTalla">Talla (Ej: 1.65 mts):</label>
                        <input type="text" id="certImssTalla" value="1.65 mts" required>
                    </div>
                </div>
                <div class="date-container">
                    <div>
                        <label for="certImssPA">Presi√≥n Arterial (Ej: 110/76 mmHg):</label>
                        <input type="text" id="certImssPA" value="110/76 mmHg" required>
                    </div>
                    <div>
                        <label for="certImssFC">Frecuencia Card√≠aca (Ej: 78 lpm):</label>
                        <input type="text" id="certImssFC" value="78 lpm" required>
                    </div>
                </div>
                <div class="date-container">
                    <div>
                        <label for="certImssFR">Frecuencia Respiratoria (Ej: 16 rpm):</label>
                        <input type="text" id="certImssFR" value="16 rpm" required>
                    </div>
                    <div>
                        <label for="certImssTemp">Temperatura Corporal (Ej: 36.7¬∞C):</label>
                        <input type="text" id="certImssTemp" value="36.7¬∞C" required>
                    </div>
                </div>

                <label for="certImssConclusion">Conclusi√≥n (Recomendaci√≥n de Aptitud):</label>
                <textarea id="certImssConclusion" required>Es apto/apta para realizar actividades f√≠sicas sin restricciones.</textarea>

                <label for="certImssFechaEmision">Fecha de Emisi√≥n del Certificado:</label>
                <input type="date" id="certImssFechaEmision" value="2025-10-06" required>
            </div>

            <button class="btn-action" style="background-color:#2980b9;" onclick="saveSolicitud('certificado_medico_imss')">üíæ Guardar Solicitud (Generar PDF y Esperar Aprobaci√≥n)</button>
        </div>
        <div id="form-receta_similares" class="form-section">
            <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>

            <div class="disclaimer-notice">
                *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
            </div>
            <div class="payment-notice">
                *PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*
            </div>

            <h2>üíä Formulario de Receta M√©dica SIMILARES</h2>
            <div class="input-group">
                <h2>üë®‚Äç‚öïÔ∏è Datos del M√©dico y Emisi√≥n</h2>
                <label for="doctorNombreSimilares">Nombre del M√©dico (Ej: Dr. DUARTE ABDALA MARIO RAFAEL):</label>
                <input type="text" id="doctorNombreSimilares" value="DR. ROGER GUITIERREZ SALAZAR">

                <label for="cedulaSimilares">C√©dula Profesional / Prof. / Especialidad:</label>
                <input type="text" id="cedulaSimilares" value="MEDICO CIRUJANO  CED. PROF. 98569946">

                <label for="direccionSimilares">Direcci√≥n del Consultorio (Ej: AV. PDTE...):</label>
                <input type="text" id="direccionSimilares" value="#30 av. Luis Donaldo Colosio">

                <label for="ciudadSimilares">Ciudad (Ej: CIUDAD DE M√âXICO):</label>
                <input type="text" id="ciudadSimilares" value="CIUDAD DE M√âXICO">

                <label for="fechaEmisionSimilares">Fecha de Emisi√≥n de la Receta:</label>
                <input type="date" id="fechaEmisionSimilares" value="">

                <h2>üñºÔ∏è Logo / Firma (Opcional)</h2>
                <p style="font-size: 0.9em; color: #2980b9; font-weight: bold;">*Nota: Se usar√°n las im√°genes por defecto del administrador si est√°n configuradas.*</p>
                <label for="logoInputSimilares">Insertar Logo de la Instituci√≥n/Receta (Opcional):</label>
                <input type="file" id="logoInputSimilares" accept="image/*">
                <label for="firmaInputSimilares">Firma del M√©dico (Opcional):</label>
                <input type="file" id="firmaInputSimilares" accept="image/*">
            </div>

            <div class="input-group">
                <h2>üë§ Datos del Paciente</h2>
                <label for="nombrePacienteSimilares">Nombre(s) del Paciente:</label>
                <input type="text" id="nombrePacienteSimilares" value="CRISTOPHER ORLANDO RAMIREZ">

                <div class="date-container">
                    <div>
                        <label for="apellidoPSimilares">Apellido Paterno:</label>
                        <input type="text" id="apellidoPSimilares" value="RAMIREZ">
                    </div>
                    <div>
                        <label for="apellidoMSimilares">Apellido Materno:</label>
                        <input type="text" id="apellidoMSimilares" value="">
                    </div>
                </div>

                <div class="date-container">
                    <div>
                        <label for="sexoSimilares">Sexo (Ej: MASCULINO):</label>
                        <input type="text" id="sexoSimilares" value="MASCULINO">
                    </div>
                    <div>
                        <label for="edadSimilares">Edad:</label>
                        <input type="text" id="edadSimilares" value="6 A√ëOS">
                    </div>
                </div>

                <div class="date-container">
                    <div>
                        <label for="fechaNacSimilares">Fecha de Nacimiento (Para la receta):</label>
                        <input type="date" id="fechaNacSimilares" value="2019-07-18">
                    </div>
                    <div>
                        <label for="alergiasSimilares">Alergias (Ej: NEGADAS):</label>
                        <input type="text" id="alergiasSimilares" value="NEGADAS">
                    </div>
                </div>
            </div>

            <div class="input-group">
                <h2>üìà Signos Vitales y Medidas</h2>
                <div class="date-container">
                    <div>
                        <label for="spo2Similares">T.A. (Ej: 100/72MM/Hg):</label>
                        <input type="text" id="spo2Similares" value="100/72MM/Hg">
                    </div>
                    <div>
                        <label for="fcSimilares">TEMP (Ej: 36.5¬∞):</label>
                        <input type="text" id="fcSimilares" value="36.5¬∞">
                    </div>
                </div>
                <div class="date-container">
                    <div>
                        <label for="frSimilares">F.C X MIN:</label>
                        <input type="text" id="frSimilares" value="MIN">
                    </div>
                    <div>
                        <label for="tempSimilares">PESO (Ej: 25KG):</label>
                        <input type="text" id="tempSimilares" value="25KG">
                    </div>
                </div>
                <div class="date-container">
                    <div>
                        <label for="pesoSimilares">F.R X MIN:</label>
                        <input type="text" id="pesoSimilares" value="MIN">
                    </div>
                    <div>
                        <label for="tallaSimilares">TALLA:</label>
                        <input type="text" id="tallaSimilares" value="6">
                    </div>
                </div>
                <label for="dxSimilares">Diagn√≥stico/Motivo de Consulta:</label>
                <input type="text" id="dxSimilares" value="INSOLACI√ìN Y DOLOR ESTOMACAL">
            </div>

            <div class="input-group">
                <h2>üìù Contenido de la Receta</h2>
                <label for="contenidoConsultaSimilares">Contenido de la Consulta (Texto):</label>
                <textarea id="contenidoConsultaSimilares">Paciente acude a consulta m√©dica con dolor abdominal, diarrea con episodios agudos y malestar general. Sin presentar fiebre.</textarea>

                <label for="tratamientoSimilares">TRATAMIENTO (Una l√≠nea por medicamento):</label>
                <textarea id="tratamientoSimilares">1.- AMBROXOL 3.2GR/100ML JARABE 120 ML
1 CD 12 HRS DURANTE 7D ORAL
2.- PARACETAMOL 40MG/1ML SUSPENSION 15 ML
1 CD 12 HRS DURANTE 5D ORAL</textarea>

                <label for="indicacionesGeneralesSimilares">Indicaciones Generales:</label>
                <textarea id="indicacionesGeneralesSimilares">Reposo m√≠nimo de 2-3 d√≠as</textarea>

                <label for="proximaCitaSimilares">Pr√≥xima Cita (Fecha):</label>
                <input type="text" id="proximaCitaSimilares" value="27/03/2021">
            </div>

            <button class="btn-action" onclick="saveSolicitud('receta_similares')">üíæ Guardar Solicitud (Esperar Aprobaci√≥n)</button>
        </div>

        <div id="form-incapacidad_imss" class="form-section">
            <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>
            <div class="disclaimer-notice">*NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO*</div>
            <div class="payment-notice">*PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*</div>
            <h2>üíä Formulario de Incapacidad IMSS</h2>
            <div class="input-group">
                <p>‚ö†Ô∏è **FORMULARIO PENDIENTE:** Agregue los campos espec√≠ficos para la Incapacidad IMSS aqu√≠.</p>
                <label for="placeholder1_incapacidad">Ejemplo de Campo (a borrar):</label>
                <input type="text" id="placeholder1_incapacidad" value="">
            </div>
            <button class="btn-action" onclick="saveSolicitud('incapacidad_imss')">üíæ Guardar Solicitud</button>
        </div>
    </div>

    <div id="status-page" class="status-page" style="display:none;">
        <div class="disclaimer-notice">
            *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
        </div>
    </div>

    <a href="https://wa.me/message/AZLK65CETSPQL1" class="whatsapp-float" target="_blank" title="Soporte WhatsApp">
        <i class="fab fa-whatsapp"></i>
    </a>

    <div class="fixed-payment-info">
        <p>‚ö†Ô∏è **PAGO**</p>
        <p>*PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*</p>
    </div>

    <script>
        const { jsPDF } = window.jspdf;
        const STORAGE_KEY = 'pending_requests_list';
        const APPROVED_KEY = 'approved_requests_list';
        const REGISTERED_USERS_KEY = 'registered_app_users';
        const USER_ACTIVITY_KEY = 'user_activity_log';
        const ADMIN_SETTINGS_KEY = 'admin_default_settings';
        
        // üîë Credenciales de administrador fijas (Solo para el Admin)
        const ADMIN_USER = 'trollgaga999@gmail.com';
        const ADMIN_PASS = 'Johan207';
        
        // üîë CONSTANTES DE SESI√ìN
        const SESSION_KEY = 'user_session_v1';
        const SESSION_EXPIRY_MS = 60 * 60 * 1000; // 1 hora en milisegundos
        
        // üîë Estado de la sesi√≥n
        let statusCheckInterval = null;
        let currentUser = null; 

        function getBaseUrl() {
            return window.location.href.split('#')[0];
        }
        
        // --- FUNCIONES DE ALMACENAMIENTO (HELPERS) ---

        function getPendingRequests() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : [];
        }
        function savePendingRequests(requests) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(requests));
        }
        function getApprovedRequests() {
            const data = localStorage.getItem(APPROVED_KEY);
            return data ? JSON.parse(data) : [];
        }
        function saveApprovedRequests(requests) {
            localStorage.setItem(APPROVED_KEY, JSON.stringify(requests));
        }
        function getRegisteredUsers() {
            const data = localStorage.getItem(REGISTERED_USERS_KEY);
            return data ? JSON.parse(data) : [];
        }
        function saveRegisteredUsers(users) {
            localStorage.setItem(REGISTERED_USERS_KEY, JSON.stringify(users));
        }
        function getActivityLog() {
            const data = localStorage.getItem(USER_ACTIVITY_KEY); 
            return data ? JSON.parse(data) : [];
        }
        function saveActivityLog(log) {
            localStorage.setItem(USER_ACTIVITY_KEY, JSON.stringify(log));
        }
        function logActivity(userIdentifier, action) {
            if (!userIdentifier) userIdentifier = 'ANONIMO';
            
            const log = getActivityLog();
            const newEntry = {
                user: userIdentifier,
                action: action,
                timestamp: new Date().toLocaleString()
            };
            log.push(newEntry);
            saveActivityLog(log);
        }

        // --- FUNCIONES DE SESI√ìN Y AUTENTICACI√ìN ---

        function checkSession() {
            const storedSession = localStorage.getItem(SESSION_KEY);
            if (!storedSession) return false;

            try {
                const sessionData = JSON.parse(storedSession);
                const now = Date.now();
                
                if (now - sessionData.timestamp > SESSION_EXPIRY_MS) {
                    console.log("Session expired. Logging out.");
                    localStorage.removeItem(SESSION_KEY);
                    return false;
                }

                currentUser = sessionData.user;
                if (currentUser.user === ADMIN_USER) {
                    currentUser.isAdmin = true;
                }

                sessionData.timestamp = now;
                localStorage.setItem(SESSION_KEY, JSON.stringify(sessionData));
                
                return true;
            } catch (e) {
                console.error("Error restoring session:", e);
                localStorage.removeItem(SESSION_KEY);
                return false;
            }
        }

        function authenticateUser() {
            const user = document.getElementById('loginUser').value;
            const pass = document.getElementById('loginPass').value;

            if (user === ADMIN_USER && pass === ADMIN_PASS) {
                currentUser = { user: user, name: 'ADMIN', status: 'authorized', isAdmin: true };
                const sessionData = { user: currentUser, timestamp: Date.now() };
                localStorage.setItem(SESSION_KEY, JSON.stringify(sessionData));
                logActivity(user, 'ADMIN_LOGIN_SUCCESS');
                alert("¬°Bienvenido, Administrador! Accediendo al Panel de Control.");
                showForm('admin_dashboard');
                return;
            }

            const registeredUsers = getRegisteredUsers();
            const foundUser = registeredUsers.find(u => u.user === user && u.pass === pass);

            if (foundUser) {
                if (foundUser.status === 'pending') {
                    alert(`Acceso denegado: Su cuenta est√° pendiente de autorizaci√≥n por el administrador.`);
                    logActivity(user, 'LOGIN_FAIL:PENDING');
                    return;
                }
                
                currentUser = foundUser;
                const sessionData = { user: currentUser, timestamp: Date.now() };
                localStorage.setItem(SESSION_KEY, JSON.stringify(sessionData));

                logActivity(user, 'USER_LOGIN_SUCCESS');
                alert(`¬°Bienvenido, ${foundUser.name}! Acceso completado.`);
                showForm('menu');
                return;
            }
            
            logActivity(user, 'LOGIN_FAIL:INVALID_CREDENTIALS');
            alert("Usuario o Contrase√±a incorrectos. Si no tiene cuenta, por favor reg√≠strese.");
        }

        function registerUser() {
            const name = document.getElementById('regName').value;
            const user = document.getElementById('regUser').value;
            const pass = document.getElementById('regPass').value;

            if (!name || !user || !pass) {
                alert("Por favor, complete todos los campos.");
                return;
            }

            let users = getRegisteredUsers();
            if (users.some(u => u.user === user)) {
                alert("Ese correo electr√≥nico ya est√° registrado. Intente iniciar sesi√≥n o use otro correo.");
                return;
            }

            const newUser = { name, user, pass, status: 'pending' };
            users.push(newUser);
            saveRegisteredUsers(users);
            logActivity(user, 'USER_REGISTERED');

            alert("¬°Registro completado! Su cuenta est√° en estado PENDIENTE. Un administrador la autorizar√° pronto.");
            document.getElementById('form-register').reset;
            showForm('auth_splash');
        }

        function logOut() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
                statusCheckInterval = null;
            }
            logActivity(currentUser?.user || 'ANON', 'LOGOUT');
            localStorage.removeItem(SESSION_KEY);
            currentUser = null;
            showForm('auth_splash', false);
        }

        // --- FUNCIONES DE ADMINISTRACI√ìN ---

        function loadAdminDashboard() {
            loadPendingRequests();
            loadRegisteredClients();
            updateAdminSettingsPreview();
            document.getElementById('activity-log-display').innerHTML = '<p>Seleccione un cliente para ver su actividad detallada.</p>';
        }

        function loadRegisteredClients() {
            const list = document.getElementById('client-authorization-list');
            list.innerHTML = '';
            const users = getRegisteredUsers();
            
            if (users.length === 0) {
                list.innerHTML = '<p id="no-clients-msg">No hay clientes registrados.</p>';
                return;
            }

            users.forEach(u => {
                const item = document.createElement('div');
                item.classList.add('client-item');
                let statusText = `<span style="color:#e67e22; font-weight:bold;">PENDIENTE</span>`;
                let actions = `<button class="btn-authorize" onclick="authorizeClient('${u.user}')">Autorizar</button><button class="btn-reject" onclick="rejectClient('${u.user}')">Rechazar</button>`;

                if (u.status === 'authorized') {
                    statusText = `<span style="color:#27ae60; font-weight:bold;">AUTORIZADO</span>`;
                    actions = `<button class="btn-reject" onclick="rejectClient('${u.user}')">Revocar</button>`;
                } else if (u.status === 'rejected') {
                    statusText = `<span style="color:#c0392b; font-weight:bold;">RECHAZADO</span>`;
                    actions = `<button class="btn-authorize" onclick="authorizeClient('${u.user}')">Autorizar</button>`;
                }

                item.innerHTML = `
                    <div style="flex-grow:1;">
                        <strong>${u.name}</strong> (${u.user})
                        <br><small>Estado: ${statusText}</small>
                    </div>
                    <div class="request-actions">
                        <button class="back-button" onclick="viewClientActivity('${u.user}')">Ver Actividad</button>
                        ${actions}
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
        function viewClientActivity(user) {
            const logDisplay = document.getElementById('activity-log-display');
            logDisplay.innerHTML = `<h3>Actividad de ${user}</h3>`;
            const logs = getActivityLog().filter(log => log.user === user);

            if (logs.length === 0) {
                logDisplay.innerHTML += '<p>No se encontr√≥ actividad para este usuario.</p>';
                return;
            }

            logs.reverse().slice(0, 50).forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.classList.add('log-entry');
                entryDiv.textContent = `[${entry.timestamp}] ${entry.action}`;
                logDisplay.appendChild(entryDiv);
            });
            logActivity(ADMIN_USER, `VIEW_USER_ACTIVITY:${user}`);
        }

        function authorizeClient(user) {
            let users = getRegisteredUsers();
            const userIndex = users.findIndex(u => u.user === user);
            if (userIndex !== -1) {
                users[userIndex].status = 'authorized';
                saveRegisteredUsers(users);
                logActivity(ADMIN_USER, `CLIENT_AUTHORIZED:${user}`);
                alert(`Cliente ${user} autorizado.`);
                loadRegisteredClients();
            }
        }

        function rejectClient(user) {
            let users = getRegisteredUsers();
            const userIndex = users.findIndex(u => u.user === user);
            if (userIndex !== -1) {
                users[userIndex].status = 'rejected';
                saveRegisteredUsers(users);
                logActivity(ADMIN_USER, `CLIENT_REJECTED:${user}`);
                alert(`Cliente ${user} rechazado.`);
                loadRegisteredClients();
            }
        }
        
        // --- ADMIN: MANEJO DE SOLICITUDES ---
        
        function loadPendingRequests() {
            const list = document.getElementById('pending-requests-list');
            list.innerHTML = '';
            const requests = getPendingRequests();

            if (requests.length === 0) {
                list.innerHTML = '<p id="no-requests-msg">No hay solicitudes pendientes.</p>';
                return;
            }

            requests.forEach(req => {
                const item = document.createElement('div');
                item.classList.add('request-item');
                item.innerHTML = `
                    <div style="flex-grow:1;">
                        <strong>${req.type.replace(/_/g, ' ').toUpperCase()}</strong> de ${req.user} 
                        <br><small>Guardada: ${req.timestamp} | Hash: ${req.hash}</small>
                    </div>
                    <div class="request-actions">
                        <button class="btn-authorize" onclick="authorizeRequest('${req.hash}')">Autorizar</button>
                        <button class="btn-reject" onclick="rejectRequest('${req.hash}')">Rechazar</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function authorizeRequest(requestHash) {
            let pending = getPendingRequests();
            const index = pending.findIndex(r => r.hash === requestHash);

            if (index !== -1) {
                const [authorizedRequest] = pending.splice(index, 1);
                savePendingRequests(pending);

                let approved = getApprovedRequests();
                approved.push(authorizedRequest);
                saveApprovedRequests(approved);
                
                logActivity(ADMIN_USER, `REQUEST_AUTHORIZED:${authorizedRequest.type}:${requestHash}`);
                alert(`Solicitud ${requestHash} autorizada.`);
                loadPendingRequests();
            }
        }

        function rejectRequest(requestHash) {
            let pending = getPendingRequests();
            const index = pending.findIndex(r => r.hash === requestHash);

            if (index !== -1) {
                pending.splice(index, 1); // Simplemente eliminamos la solicitud pendiente
                savePendingRequests(pending);
                
                logActivity(ADMIN_USER, `REQUEST_REJECTED:${requestHash}`);
                alert(`Solicitud ${requestHash} rechazada/eliminada.`);
                loadPendingRequests();
            }
        }
        
        // --- FUNCI√ìN DE NAVEGACI√ìN INICIAL CR√çTICA (FALTA EN C√ìDIGO ANTERIOR) ---
        function checkURL() {
            const hash = window.location.hash.substring(1);
            
            if (currentUser) {
                if (currentUser.isAdmin && hash !== 'admin_dashboard') {
                    showForm('admin_dashboard', false);
                } else if (currentUser.isAdmin && hash === 'admin_dashboard') {
                    showForm('admin_dashboard', false);
                } else if (!currentUser.isAdmin && hash) {
                    showForm(hash, false);
                } else {
                    showForm('menu', false);
                }
            } else {
                showForm('auth_splash', false);
            }
            
            if (hash && viewIdMap[hash] !== 'auth_splash' && viewIdMap[hash] !== 'form-register' && !currentUser) {
                // Si el usuario no est√° logueado pero intenta acceder a una vista protegida por hash
                window.location.hash = '';
                showForm('auth_splash', false);
            }
        }
        
        window.addEventListener('popstate', (event) => {
            if (event.state && event.state.viewId) {
                showForm(event.state.viewId, false);
            } else {
                checkURL();
            }
        });
        
        // ... (Se mantienen las funciones `showForm` y `getDefaultSettings` como en la respuesta anterior)

        window.addEventListener('load', () => {
            // 1. Intentar restaurar la sesi√≥n desde localStorage
            checkSession(); 
            
            // 2. Continuar con la verificaci√≥n de la URL (AHORA checkURL est√° definida)
            checkURL();
        });
        
        // --- CONTIN√öAN LAS FUNCIONES DE PDF Y L√ìGICA DE NEGOCIO ---
        
        const viewIdMap = {
            'auth_splash': 'auth-splash', 
            'register': 'form-register', 
            'menu': 'main-menu',
            'laboral': 'form-laboral',
            'personal': 'form-personal',
            'admin_dashboard': 'admin-dashboard',
            'incapacidad_imss': 'form-incapacidad_imss',
            'receta_similares': 'form-receta_similares',
            'receta_ahorro': 'form-receta_ahorro',
            'receta_imss': 'form-receta_imss',
            'certificado_medico_imss': 'form-certificado_medico_imss',
            'cert_primaria': 'form-cert_primaria',
            'cert_secundaria': 'form-cert_secundaria',
            'cert_prepa': 'form-cert_prepa',
            'metodo_shein': 'form-metodo_shein',
            'metodo_cinepolis': 'form-metodo_cinepolis',
            'metodo_temu': 'form-metodo_temu',
            'cv_desde_cero': 'form-cv_desde_cero',
            'sellos_personales': 'form-sellos_personales',
            'formato_solicitud_pdf': 'formato_solicitud_pdf'
        };

        function refreshSessionTimestamp() {
            if (currentUser) {
                const storedSession = localStorage.getItem(SESSION_KEY);
                if (storedSession) {
                    try {
                        const sessionData = JSON.parse(storedSession);
                        if (sessionData.user.user === currentUser.user) {
                            sessionData.timestamp = Date.now();
                            localStorage.setItem(SESSION_KEY, JSON.stringify(sessionData));
                        }
                    } catch (e) {
                        console.error("Error al refrescar la sesi√≥n:", e);
                    }
                }
            }
        }

        function showForm(viewId, pushHistory = true) {
            const requiresAuth = !['auth_splash', 'register', 'status', 'whatsapp_group'].includes(viewId);
            const isMenuOrService = viewId === 'menu' || viewIdMap[viewId]?.startsWith('form-');
            const isDashboard = viewId === 'admin_dashboard';
            
            if (currentUser) {
                refreshSessionTimestamp();
            }

            if (requiresAuth && !currentUser) {
                alert("Debe iniciar sesi√≥n para acceder a este contenido.");
                viewId = 'auth_splash';
            } else if (isDashboard && (!currentUser || currentUser.user !== ADMIN_USER)) {
                alert("Acceso denegado. Solo el administrador puede ver el panel.");
                viewId = 'menu';
            }

            const targetId = viewIdMap[viewId] || viewId;
            const targetElement = document.getElementById(targetId);
            
            if (viewId === 'whatsapp_group') {
                window.open('https://chat.whatsapp.com/GbkvIbPwCRX1JacpJJOS9D', '_blank');
                logActivity(currentUser?.user || 'anon', 'VIEW_WHATSAPP_GROUP');
                return;
            }

            const currentActive = document.querySelector('.form-section.active, #main-menu.active');

            const transitionToNext = () => {
                const sections = Object.values(viewIdMap);
                sections.forEach(id => {
                    const el = document.getElementById(id);
                    if (el && el !== targetElement) {
                        el.classList.remove('active');
                    }
                });

                if (targetElement) {
                    targetElement.classList.add('active'); 
                    
                    window.scrollTo(0, 0);
                    if (pushHistory) {
                        let url = getBaseUrl();
                        let state = { viewId: viewId };
                        if (viewId !== 'menu') { url += `#${viewId}`; } else { url = getBaseUrl(); }
                        history.pushState(state, '', url);
                    }
                    
                    if (isMenuOrService && currentUser) {
                        logActivity(currentUser.user, viewId === 'menu' ? 'ACCESS_MENU' : `VIEW_FORM:${viewId}`);
                    }
                    if (isDashboard && currentUser) {
                        logActivity(currentUser.user, 'ACCESS_ADMIN_DASHBOARD');
                        loadAdminDashboard(); // Asegura que las configuraciones se carguen al entrar
                    }
                }
            }

            if (currentActive && currentActive !== targetElement) {
                currentActive.classList.remove('active');
                setTimeout(transitionToNext, 300); 
            } else {
                transitionToNext();
            }
        }
        
        // üîë CONFIGURACI√ìN GLOBAL DE ADMIN
        function getDefaultSettings() {
            const data = localStorage.getItem(ADMIN_SETTINGS_KEY);
            return data ? JSON.parse(data) : { logoBase64: null, signatureBase64: null };
        }
        function saveDefaultSettings(settings) {
            localStorage.setItem(ADMIN_SETTINGS_KEY, JSON.stringify(settings));
        }

        async function uploadDefaultImage(type) {
            const inputId = type === 'logo' ? 'defaultLogoInput' : 'defaultSignatureInput';
            const fileInput = document.getElementById(inputId);
            const file = fileInput.files[0];

            if (!file) {
                alert(`Por favor, seleccione un archivo para el ${type}.`);
                return;
            }

            const base64Data = await fileToBase64(file);
            if (!base64Data) {
                alert("Error al convertir el archivo a Base64.");
                return;
            }

            const settings = getDefaultSettings();
            if (type === 'logo') {
                settings.logoBase64 = base64Data;
                alert("Logo por defecto guardado exitosamente. Se aplicar√° a los PDFs.");
            } else {
                settings.signatureBase64 = base64Data;
                alert("Firma por defecto guardada exitosamente. Se aplicar√° a los PDFs.");
            }
            
            saveDefaultSettings(settings);
            logActivity(ADMIN_USER, `UPDATE_DEFAULT_IMAGE:${type.toUpperCase()}`);
            
            // Actualizar la vista previa y limpiar input
            loadAdminDashboard(); 
            fileInput.value = '';
        }

        function updateAdminSettingsPreview() {
            const settings = getDefaultSettings();
            
            const logoPreview = document.getElementById('defaultLogoPreview');
            if (settings.logoBase64) {
                logoPreview.src = settings.logoBase64;
                logoPreview.style.display = 'block';
                logoPreview.alt = 'Logo configurado';
            } else {
                logoPreview.style.display = 'none';
                logoPreview.alt = 'Logo no configurado';
            }

            const signaturePreview = document.getElementById('defaultSignaturePreview');
            if (settings.signatureBase64) {
                signaturePreview.src = settings.signatureBase64;
                signaturePreview.style.display = 'block';
                signaturePreview.alt = 'Firma configurada';
            } else {
                signaturePreview.style.display = 'none';
                signaturePreview.alt = 'Firma no configurada';
            }
        }
        
        // --- FUNCIONES DE PDF ---

        const fileToBase64 = (file) => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => resolve(null);
        });

        const IMSS_LOGO_SVG = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                <rect width="100" height="100" fill="white"/>
                <path d="M50 0 C75 0 95 20 95 45 C95 70 50 100 50 100 C50 100 5 70 5 45 C5 20 25 0 50 0 Z" fill="#006c59"/>
                <path d="M50 6 L88 45 C88 64 50 90 50 90 C50 90 12 64 12 45 L50 6 Z" fill="#008c7c"/>
                <path d="M50 15 C69 15 84 30 84 49 C84 64 50 82 50 82 C50 82 16 64 16 49 C16 30 31 15 50 15 Z" fill="#ffffff"/>
                <path d="M50 25 C60 25 70 30 70 40 C70 50 50 65 50 65 C50 65 30 50 30 40 C30 30 40 25 50 25 Z" fill="#006c59"/>
                <text x="50" y="98" font-family="Arial, sans-serif" font-size="14" font-weight="bold" fill="#006c59" text-anchor="middle">IMSS</text>
            </svg>
        `;
        const IMSS_LOGO_DATAURL = 'data:image/svg+xml;base64,' + btoa(IMSS_LOGO_SVG);
        
        const DEFAULT_SIMILARES_LOGO = 'data:image/svg+xml;base64,' + btoa(
            `<svg xmlns="http://www.w3.org/2000/svg" width="200" height="80" viewBox="0 0 200 80">
                <rect width="200" height="80" fill="white"/>
                <g transform="translate(10,8)">
                  <circle cx="24" cy="24" r="24" fill="#0a6ebd"/>
                  <path d="M18 24 C18 14 36 12 36 24 C36 36 18 34 18 24 Z" fill="white"/>
                  <text x="62" y="36" font-family="Arial" font-size="14" fill="#0a6ebd" font-weight="bold">FARMACIAS</text>
                  <text x="62" y="53" font-family="Arial" font-size="14" fill="#0a6ebd" font-weight="bold">SIMILARES</text>
                </g>
            </svg>`
        );

        function getImageType(base64Data) {
            if (base64Data.includes('svg')) return 'SVG';
            const match = base64Data.match(/^data:image\/(\w+);base64/);
            return match ? match[1].toUpperCase() : 'JPEG'; 
        }

        function addImageToPdf(doc, base64Data, x, y, w, h) {
            if (!base64Data) return;
            const format = getImageType(base64Data);
            try {
                if (format === 'SVG') {
                    doc.addImage(base64Data, 'SVG', x, y, w, h);
                } else if (format === 'PNG') {
                    doc.addImage(base64Data, 'PNG', x, y, w, h, '', 'FAST');
                } else {
                    doc.addImage(base64Data, 'JPEG', x, y, w, h, '', 'FAST');
                }
            } catch (e) {
                console.error("Error al a√±adir imagen al PDF:", format, e);
            }
        }

        function drawJustifiedText(doc, text, x, y, maxWidth, lineHeight) {
            let currentY = y;
            const splitText = doc.splitTextToSize(text, maxWidth);
            splitText.forEach((line) => {
                doc.text(line, x, currentY);
                currentY += lineHeight;
            });
            return currentY;
        }

        async function generarPDFCertificadoIMSS(descargar = true) {
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 20;
            let y = 15;
            const lineHeight = 5;
            
            const adminSettings = getDefaultSettings();
            const logoFile = document.getElementById('certImssLogoInput').files[0];
            const logoBase64 = adminSettings.logoBase64 || (logoFile ? await fileToBase64(logoFile) : IMSS_LOGO_DATAURL);
            const signatureBase64 = adminSettings.signatureBase64; 

            const doctorNombre = (document.getElementById('certImssDoctorNombre').value || 'M√âDICO EN TURNO').toUpperCase();
            const doctorCedula = (document.getElementById('certImssDoctorCedula').value || 'C.P. XXXXXXX').toUpperCase();
            const doctorEspecialidad = (document.getElementById('certImssDoctorEspecialidad').value || 'MEDICINA GENERAL').toUpperCase();
            const doctorConsultorio = document.getElementById('certImssDoctorConsultorio').value || 'N/A';
            const doctorTurno = document.getElementById('certImssDoctorTurno').value || 'N/A';
            const umf = (document.getElementById('certImssUmf').value || 'UMF N/A').toUpperCase();

            const nombreP = (document.getElementById('certImssNombre').value || 'PACIENTE').toUpperCase();
            const nss = document.getElementById('certImssNss').value || 'N/A';
            const edad = document.getElementById('certImssEdad').value || 'N/A';
            const sexo = document.getElementById('certImssSexo').value || 'N/A';
            const fechaNacVal = document.getElementById('certImssFechaNac').value;
            const fechaNac = fechaNacVal ? new Date(fechaNacVal + 'T12:00:00').toLocaleDateString('es-MX') : 'N/A';
            const tipoSangre = document.getElementById('certImssTipoSangre').value || 'N/A';
            const direccion = (document.getElementById('certImssDireccion').value || 'ESTADO DE M√âXICO').toUpperCase();

            const peso = document.getElementById('certImssPeso').value || 'N/A';
            const talla = document.getElementById('certImssTalla').value || 'N/A';
            const pa = document.getElementById('certImssPA').value || 'N/A';
            const fc = document.getElementById('certImssFC').value || 'N/A';
            const fr = document.getElementById('certImssFR').value || 'N/A';
            const temp = document.getElementById('certImssTemp').value || 'N/A';
            const conclusion = document.getElementById('certImssConclusion').value || '';

            const fechaEmisionVal = document.getElementById('certImssFechaEmision').value;
            if (!fechaEmisionVal) {
                alert("Por favor, ingrese la fecha de emisi√≥n.");
                return null;
            }
            const fecha = new Date(fechaEmisionVal + 'T12:00:00');
            const fechaLarga = fecha.toLocaleDateString('es-MX', { day: 'numeric', month: 'long', year: 'numeric' });
            
            // --- INICIO DE DISE√ëO DEL PDF ---

            const logoW = 20; 
            const logoH = 20; 
            addImageToPdf(doc, logoBase64, margin, y, logoW, logoH);

            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.text('INSTITUTO MEXICANO DEL SEGURO SOCIAL', pageWidth - margin, y + 2, { align: 'right' });
            y += 7;
            doc.setFontSize(12);
            doc.text('DIRECCI√ìN DE PRESTACIONES M√âDICAS', pageWidth - margin, y, { align: 'right' });
            y += 6;
            doc.setFontSize(11);
            doc.text(`${umf} - ${direccion}`, pageWidth - margin, y, { align: 'right' });
            y += 10;
            
            doc.setFontSize(18);
            doc.setDrawColor(0, 108, 89);
            doc.setLineWidth(0.8);
            doc.line(margin, y, pageWidth - margin, y);
            y += 5;

            doc.text('CERTIFICADO M√âDICO DE APTITUD F√çSICA', pageWidth / 2, y, { align: 'center' });
            y += 5;
            doc.line(margin, y, pageWidth - margin, y);
            y += 10;
            
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');

            const introText = `El Dr./Dra. ${doctorNombre}, con C√©dula Profesional ${doctorCedula} y Especialidad en ${doctorEspecialidad}, adscrito(a) a la ${umf}, del turno ${doctorTurno} y con domicilio laboral en ${direccion}, CERTIFICA QUE:`;
            y = drawJustifiedText(doc, introText, margin, y, pageWidth - 2 * margin, lineHeight);
            y += 8;

            doc.setFontSize(10);
            const dataTableY = y;
            const column1X = margin;
            const column3X = margin + 100;

            doc.setFillColor(230);
            doc.rect(column1X - 2, dataTableY - 0.5, pageWidth - 2 * margin + 4, 30, 'F');
            doc.setDrawColor(0);
            doc.rect(column1X - 2, dataTableY - 0.5, pageWidth - 2 * margin + 4, 30, 'S');

            y = dataTableY + 4;
            doc.setFont('helvetica', 'bold');
            doc.text('NOMBRE COMPLETO:', column1X, y);
            doc.setFont('helvetica', 'normal');
            doc.text(nombreP, column1X + 40, y);
            
            doc.setFont('helvetica', 'bold');
            doc.text('NSS:', column3X, y);
            doc.setFont('helvetica', 'normal');
            doc.text(nss, column3X + 15, y);
            y += 6;
            
            doc.setFont('helvetica', 'bold');
            doc.text('FECHA DE NACIMIENTO:', column1X, y);
            doc.setFont('helvetica', 'normal');
            doc.text(fechaNac, column1X + 45, y);
            
            doc.setFont('helvetica', 'bold');
            doc.text('EDAD:', column3X, y);
            doc.setFont('helvetica', 'normal');
            doc.text(`${edad} a√±os`, column3X + 15, y);
            y += 6;

            doc.setFont('helvetica', 'bold');
            doc.text('SEXO:', column1X, y);
            doc.setFont('helvetica', 'normal');
            doc.text(sexo, column1X + 15, y);

            doc.setFont('helvetica', 'bold');
            doc.text('TIPO DE SANGRE:', column3X, y);
            doc.setFont('helvetica', 'normal');
            doc.text(tipoSangre, column3X + 35, y);
            y = dataTableY + 32;

            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.text('SIGNOS VITALES Y SOMATOMETR√çA:', margin, y);
            y += 6;
            
            doc.setFont('helvetica', 'normal');
            doc.text(`Peso: ${peso}`, margin, y);
            doc.text(`Talla: ${talla}`, margin + 40, y);
            doc.text(`T.A.: ${pa}`, margin + 80, y);
            doc.text(`F.C.: ${fc}`, margin + 120, y);
            y += 5;
            
            doc.text(`F.R.: ${fr}`, margin, y);
            doc.text(`Temperatura: ${temp}`, margin + 40, y);
            y += 8;

            doc.setFont('helvetica', 'bold');
            doc.text('CONCLUSI√ìN Y APTITUD:', margin, y);
            y += 6;

            doc.setFont('helvetica', 'normal');
            const conclusionText = `Despu√©s de realizar el examen f√≠sico, se concluye que el paciente ${nombreP} ${conclusion}`;
            y = drawJustifiedText(doc, conclusionText, margin, y, pageWidth - 2 * margin, lineHeight);
            y += 15;
            
            doc.setFont('helvetica', 'normal');
            doc.text('Se extiende el presente Certificado M√©dico en:', margin, y);
            doc.setFont('helvetica', 'bold');
            doc.text(direccion, margin + 70, y);
            y += 5;

            doc.setFont('helvetica', 'normal');
            doc.text('a los', pageWidth/2 - 50, y);
            doc.setFont('helvetica', 'bold');
            doc.text(fechaLarga, pageWidth/2, y, { align: 'center' });
            y += 20;

            const firmaX = pageWidth / 2;
            doc.setLineWidth(0.4);
            doc.line(firmaX - 35, y, firmaX + 35, y);
            y += 4;
            
            if (signatureBase64) {
                const firmaW = 40; 
                const firmaH = 15; 
                addImageToPdf(doc, signatureBase64, firmaX - firmaW / 2, y - firmaH - 4, firmaW, firmaH);
            }
            
            doc.setFont('helvetica', 'bold');
            doc.text(doctorNombre, firmaX, y, { align: 'center' });
            y += 4;
            doc.setFontSize(9);
            doc.text(doctorCedula, firmaX, y, { align: 'center' });
            y += 4;
            doc.text(`${doctorEspecialidad}. CONSULTORIO ${doctorConsultorio}`, firmaX, y, { align: 'center' });

            if (descargar) {
                const safeName = (nombreP || 'PACIENTE').replace(/\s+/g, '_');
                doc.save(`Certificado_IMSS_${safeName}.pdf`);
                return true;
            } else {
                return doc.output('datauristring').split(',')[1];
            }
        }
        
        // Funci√≥n placeholder para generar un hash o ID
        function generarHash() {
            return Math.random().toString(36).substring(2, 9) + Date.now().toString(36);
        }

        // Funci√≥n saveSolicitud (Actualizada para usar currentUser)
        async function saveSolicitud(type) {
            if (!currentUser) {
                alert("Debe iniciar sesi√≥n para guardar una solicitud.");
                return;
            }
            
            let pdfData;
            const hash = generarHash();

            // 1. Generar el PDF y obtener el base64
            if (type === 'certificado_medico_imss') {
                pdfData = await generarPDFCertificadoIMSS(false); 
            } else if (type === 'receta_similares') {
                pdfData = await generarPDFRecetaSimilares(false);
            } else {
                alert(`Funci√≥n para generar PDF de ${type} no implementada.`);
                return;
            }
            
            if (!pdfData) {
                alert("Error al generar el documento. Por favor, revise los campos.");
                return;
            }

            // 2. Crear y guardar la solicitud
            const solicitud = {
                user: currentUser.user,
                type: type,
                hash: hash,
                timestamp: new Date().toLocaleString(),
                pdfBase64: pdfData,
            };

            let pending = getPendingRequests();
            pending.push(solicitud);
            savePendingRequests(pending);
            logActivity(currentUser.user, `REQUEST_SAVED:${type}:${hash}`);

            alert("Solicitud guardada. Ahora debe esperar la autorizaci√≥n del administrador. Su ID de seguimiento es: " + hash);
            
            // 3. Redirigir a la p√°gina de estado/espera
            showStatusPage(hash);
        }
        
        function showStatusPage(hash) {
            // L√≥gica para mostrar el estado y la opci√≥n de descarga si est√° autorizada
            const appContainer = document.getElementById('app-container');
            const statusPage = document.getElementById('status-page');
            const statusContent = document.getElementById('status-page');
            
            // Ocultar todas las formas
            appContainer.style.display = 'none';

            // Mostrar p√°gina de estado
            statusPage.style.display = 'flex';
            statusContent.innerHTML = `
                <div class="disclaimer-notice">
                    *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
                </div>
                <h2>‚è≥ Estatus de su Solicitud</h2>
                <p>Su solicitud ha sido enviada para revisi√≥n y aprobaci√≥n.</p>
                <p style="font-weight:bold;">ID de Seguimiento: <span style="color:#2980b9;">${hash}</span></p>
                <div id="status-spinner" class="spinner"></div>
                <p id="status-message">Estado: PENDIENTE DE AUTORIZACI√ìN.</p>
                <div id="download-area" style="display:none;">
                    <p style="color:#27ae60; font-weight:bold;">¬°Solicitud Aprobada! Ya puede descargar su documento.</p>
                    <button class="btn-action btn-download-now" onclick="downloadDocument('${hash}')">‚¨áÔ∏è Descargar Ahora</button>
                    <div class="download-link-box">
                        Si el bot√≥n falla, use este enlace: <a id="download-link-${hash}" href="#" target="_blank">Descargar PDF</a>
                    </div>
                </div>
                <button class="btn-action back-button" style="width: auto; margin-top: 30px;" onclick="showForm('menu')">Volver al Men√∫</button>
            `;
            
            // Iniciar verificaci√≥n de estado
            if (statusCheckInterval) clearInterval(statusCheckInterval);
            statusCheckInterval = setInterval(() => checkRequestStatus(hash), 5000); 
        }

        function checkRequestStatus(hash) {
            const approvedRequests = getApprovedRequests();
            const approvedRequest = approvedRequests.find(r => r.hash === hash);

            if (approvedRequest) {
                if (statusCheckInterval) clearInterval(statusCheckInterval);
                document.getElementById('status-spinner').style.display = 'none';
                document.getElementById('status-message').textContent = 'Estado: ¬°APROBADO!';
                document.getElementById('download-area').style.display = 'block';

                const link = document.getElementById(`download-link-${hash}`);
                if (link) {
                    link.href = 'data:application/pdf;base64,' + approvedRequest.pdfBase64;
                    link.download = `${approvedRequest.type}_${hash}.pdf`;
                }
            }
        }

        function downloadDocument(hash) {
            const approvedRequests = getApprovedRequests();
            const approvedRequest = approvedRequests.find(r => r.hash === hash);
            if (approvedRequest) {
                const link = document.createElement('a');
                link.href = 'data:application/pdf;base64,' + approvedRequest.pdfBase64;
                link.download = `${approvedRequest.type}_${hash}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                logActivity(currentUser.user, `REQUEST_DOWNLOADED:${approvedRequest.type}:${hash}`);
            } else {
                alert("El documento a√∫n no est√° autorizado o no se encontr√≥.");
            }
        }


        async function generarPDFRecetaSimilares(descargar = true) {
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 10;
            let y = 10;
            const lineHeight = 5;
            
            const adminSettings = getDefaultSettings();
            
            const logoFile = document.getElementById('logoInputSimilares').files[0];
            const firmaFile = document.getElementById('firmaInputSimilares').files[0];

            const logoBase64 = adminSettings.logoBase64 || (logoFile ? await fileToBase64(logoFile) : DEFAULT_SIMILARES_LOGO);
            const signatureBase64 = adminSettings.signatureBase64 || (firmaFile ? await fileToBase64(firmaFile) : null);

            const nombreDoc = (document.getElementById('doctorNombreSimilares').value || '').toUpperCase();
            const cedula = (document.getElementById('cedulaSimilares').value || '').toUpperCase();
            const direccion = (document.getElementById('direccionSimilares').value || '').toUpperCase();
            const ciudad = (document.getElementById('ciudadSimilares').value || '').toUpperCase();
            const fechaEmisionVal = document.getElementById('fechaEmisionSimilares').value;
            
            const hoy = new Date();
            const fechaHora = `${fechaEmisionVal ? new Date(fechaEmisionVal + 'T12:00:00').toLocaleDateString('es-MX', { day: '2-digit', month: '2-digit', year: 'numeric' }) : new Date().toLocaleDateString('es-MX', { day: '2-digit', month: '2-digit', year: 'numeric' })} ${String(hoy.getHours()).padStart(2, '0')}:${String(hoy.getMinutes()).padStart(2, '0')}`;
            
            const nombreP = (document.getElementById('nombrePacienteSimilares').value || '').toUpperCase();
            const apellidoP = (document.getElementById('apellidoPSimilares').value || '').toUpperCase();
            const apellidoM = (document.getElementById('apellidoMSimilares').value || '').toUpperCase();
            const sexo = (document.getElementById('sexoSimilares').value || '').toUpperCase();
            const edad = (document.getElementById('edadSimilares').value || '').toUpperCase();
            const fechaNacVal = document.getElementById('fechaNacSimilares').value;
            const fechaNac = fechaNacVal ? new Date(fechaNacVal + 'T12:00:00').toLocaleDateString('es-MX', { day: '2-digit', month: '2-digit', year: 'numeric' }) : '';
            const alergias = (document.getElementById('alergiasSimilares').value || '').toUpperCase();

            const ta = (document.getElementById('spo2Similares').value || '').toUpperCase();
            const temp = (document.getElementById('fcSimilares').value || '').toUpperCase();
            const fc = (document.getElementById('frSimilares').value || '').toUpperCase();
            const peso = (document.getElementById('tempSimilares').value || '').toUpperCase();
            const fr = (document.getElementById('pesoSimilares').value || '').toUpperCase();
            const talla = (document.getElementById('tallaSimilares').value || '').toUpperCase();
            const dx = (document.getElementById('dxSimilares').value || '').toUpperCase();

            const contenido = document.getElementById('contenidoConsultaSimilares').value || '';
            const tratamiento = document.getElementById('tratamientoSimilares').value || '';
            const indicaciones = document.getElementById('indicacionesGeneralesSimilares').value || '';
            const proxima = document.getElementById('proximaCitaSimilares').value || '';
            
            const barcodeNumber = Math.floor(Math.random() * 900000000) + 100000000;

            // --- ENCABEZADO ---
            const logoW = 34;
            const logoH = 20;
            addImageToPdf(doc, logoBase64, margin, y, logoW, logoH);

            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text(nombreDoc, pageWidth/2, y + 8, { align: 'center' });
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(cedula, pageWidth/2, y + 13, { align: 'center' });
            doc.text('UNIVERSIDAD NACIONAL AUTONOMA DE MEXICO', pageWidth/2, y + 18, { align: 'center' });

            y += Math.max(logoH, 22) + 2;

            doc.setDrawColor(0);
            doc.setLineWidth(0.4);
            doc.line(margin, y, pageWidth - margin, y);
            y += 6;

            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.text(direccion, margin, y);
            doc.text(`FECHA Y HORA DE ELABORACION: ${fechaHora}`, pageWidth - margin, y, { align: 'right' });
            y += 6;

            doc.setLineWidth(0.3);
            doc.line(margin, y, pageWidth - margin, y);
            y += 6;

            // --- DATOS DEL PACIENTE ---
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('PACIENTE:', margin, y);
            doc.setFont(undefined, 'normal');
            doc.text(`${nombreP} ${apellidoP} ${apellidoM}`, margin + 25, y);

            doc.setFont(undefined, 'bold');
            doc.text('SEXO:', margin + 100, y);
            doc.setFont(undefined, 'normal');
            doc.text(sexo, margin + 115, y);

            doc.setFont(undefined, 'bold');
            doc.text('EDAD:', margin + 140, y);
            doc.setFont(undefined, 'normal');
            doc.text(edad, margin + 155, y);
            y += 5;

            doc.setFont(undefined, 'bold');
            doc.text('F. NAC:', margin, y);
            doc.setFont(undefined, 'normal');
            doc.text(fechaNac, margin + 20, y);

            doc.setFont(undefined, 'bold');
            doc.text('ALERGIAS:', margin + 70, y);
            doc.setFont(undefined, 'normal');
            doc.text(alergias, margin + 95, y);
            y += 5;

            doc.setLineWidth(0.3);
            doc.line(margin, y, pageWidth - margin, y);
            y += 5;

            // --- SIGNOS VITALES / DX ---
            doc.setFont(undefined, 'bold');
            doc.text('T.A:', margin, y);
            doc.setFont(undefined, 'normal');
            doc.text(ta, margin + 15, y);

            doc.setFont(undefined, 'bold');
            doc.text('TEMP:', margin + 50, y);
            doc.setFont(undefined, 'normal');
            doc.text(temp, margin + 70, y);

            doc.setFont(undefined, 'bold');
            doc.text('F.C:', margin + 100, y);
            doc.setFont(undefined, 'normal');
            doc.text(fc, margin + 115, y);

            doc.setFont(undefined, 'bold');
            doc.text('PESO:', margin + 150, y);
            doc.setFont(undefined, 'normal');
            doc.text(peso, margin + 165, y);
            y += 5;

            doc.setFont(undefined, 'bold');
            doc.text('F.R:', margin, y);
            doc.setFont(undefined, 'normal');
            doc.text(fr, margin + 15, y);

            doc.setFont(undefined, 'bold');
            doc.text('TALLA:', margin + 50, y);
            doc.setFont(undefined, 'normal');
            doc.text(talla, margin + 70, y);
            y += 5;

            doc.setFont(undefined, 'bold');
            doc.text('DX:', margin, y);
            doc.setFont(undefined, 'normal');
            doc.text(dx, margin + 15, y);
            y += 5;

            doc.setLineWidth(0.3);
            doc.line(margin, y, pageWidth - margin, y);
            y += 5;

            // --- CONTENIDO DE LA CONSULTA Y TRATAMIENTO ---
            doc.setFont(undefined, 'bold');
            doc.text('CONTENIDO DE LA CONSULTA:', margin, y);
            y += 5;
            doc.setFont(undefined, 'normal');
            y = drawJustifiedText(doc, contenido, margin, y, pageWidth - 2 * margin, 4);
            y += 5;

            doc.setFont(undefined, 'bold');
            doc.text('TRATAMIENTO:', margin, y);
            y += 5;
            doc.setFont(undefined, 'normal');
            const tratamientos = tratamiento.split('\n');
            tratamientos.forEach(line => {
                doc.text(line, margin + 5, y);
                y += 5;
            });
            y += 5;

            doc.setFont(undefined, 'bold');
            doc.text('INDICACIONES GENERALES:', margin, y);
            y += 5;
            doc.setFont(undefined, 'normal');
            y = drawJustifiedText(doc, indicaciones, margin, y, pageWidth - 2 * margin, 4);
            y += 5;

            doc.setFont(undefined, 'bold');
            doc.text('PR√ìXIMA CITA:', margin, y);
            doc.setFont(undefined, 'normal');
            doc.text(proxima, margin + 30, y);
            y += 12;

            // L√≠nea para firma (al final)
            const firmaY = y;
            const firmaX = pageWidth - margin - 60;
            doc.setLineWidth(0.4);
            doc.line(firmaX, firmaY, firmaX + 50, firmaY);
            
            if (signatureBase64) {
                const firmaW = 40; 
                const firmaH = 15; 
                addImageToPdf(doc, signatureBase64, firmaX + 5, firmaY - firmaH, firmaW, firmaH);
            }
            
            doc.setFont(undefined, 'normal');
            doc.text('COPIA', firmaX - 30, firmaY);
            doc.setFont(undefined, 'bold');
            doc.text('FIRMA:', firmaX, firmaY + 4);
            y = firmaY + 18;

            if (descargar) {
                const safeName = (nombreP || 'PACIENTE').replace(/\s+/g, '_');
                doc.save(`Receta_Similares_${safeName}.pdf`);
                return true;
            } else {
                return doc.output('datauristring').split(',')[1];
