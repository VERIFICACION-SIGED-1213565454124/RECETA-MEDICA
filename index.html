<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Generador de Documentos - Estatus de Solicitud</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>

    <style>
        /* Estilos Base Existentes */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 850px;
            margin: 0 auto;
            padding: 25px;
            background-color: #f4f4f9;
            position: relative;
            padding-bottom: 100px;
        }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 25px; }
        .input-group, .form-section { background-color: #ffffff; padding: 20px; margin-bottom: 25px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h2 { color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-bottom: 15px; }
        label { display: block; margin-top: 10px; margin-bottom: 5px; font-weight: 600; color: #34495e; }
        input[type="text"], input[type="date"], textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }
        textarea { resize: vertical; min-height: 80px; }
        .date-container { display: flex; gap: 15px; }
        .date-container > div { flex: 1; }
        .btn-action {
            background-color: #2ecc71;
            color: white;
            padding: 15px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            width: 100%;
            margin-top: 20px;
            transition: background-color 0.3s;
        }
        .btn-action:hover { background-color: #27ae60; }
        .back-button {
            background: none;
            color: #3498db;
            border: none;
            padding: 0;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        .form-section { display: none; }
        #menu-section { display: block; }
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .menu-card {
            background-color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .menu-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .menu-card i {
            font-size: 36px;
            color: #3498db;
            margin-bottom: 10px;
        }
        .menu-card strong {
            display: block;
            font-size: 16px;
            color: #2c3e50;
        }
        .disclaimer-notice, .payment-notice {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }
        .disclaimer-notice {
            background-color: #f9e3e3;
            color: #c0392b;
            border: 1px solid #e74c3c;
        }
        .payment-notice {
            background-color: #d1f7d1;
            color: #27ae60;
            border: 1px solid #2ecc71;
        }

        /* Estilos del estatus de solicitud */
        #status-section {
            display: none;
            background-color: #ffffff;
            padding: 20px;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #status-section h2 { border-bottom: none; }
        .status-item {
            padding: 10px 0;
            border-bottom: 1px dashed #ecf0f1;
        }
        .status-item:last-child { border-bottom: none; }
        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }
        .status-header strong { font-size: 1.1em; }
        .status-details {
            margin-top: 10px;
            padding-left: 15px;
            border-left: 3px solid #3498db;
            display: none;
        }
        .status-details button { margin-top: 10px; }
        .status-badge {
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.8em;
        }
        .status-pendiente { background-color: #f1c40f; color: #2c3e50; }
        .status-aprobado { background-color: #2ecc71; color: white; }
        .status-rechazado { background-color: #e74c3c; color: white; }
        
        /* Contenido del footer */
        #footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 850px;
            background-color: #3498db;
            color: white;
            padding: 15px 25px;
            box-sizing: border-box;
            text-align: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #footer button {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        #footer button:hover { background-color: #c0392b; }
        .whatsapp-link {
            display: inline-flex;
            align-items: center;
            background-color: #25d366;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            text-decoration: none;
            font-weight: bold;
        }
        .whatsapp-link i { margin-right: 8px; font-size: 18px; }

    </style>
</head>
<body>

    <div id="app-container">
        <h1>Generador de Documentos M√©dicos</h1>

        <div id="menu-section">
            <h2>Selecciona el tipo de documento:</h2>
            <div class="menu-grid">
                <div class="menu-card category-receta" onclick="showForm('receta_similares')">
                    <i class="fas fa-prescription-bottle-alt"></i>
                    <strong>Receta M√©dica Similares</strong>
                </div>
                <div class="menu-card category-certificado" onclick="showForm('certificado_medico_imss')">
                    <i class="fas fa-notes-medical"></i>
                    <strong>Certificado M√©dico IMSS</strong>
                </div>
                </div>
            
            <div class="input-group" style="margin-top: 30px;">
                <h2>Estatus de Solicitudes</h2>
                <p>Haz clic en el bot√≥n para ver el estado de tus documentos guardados.</p>
                <button class="btn-action" onclick="showForm('status')">Ver Estatus de Solicitudes</button>
            </div>
        </div>

        <div id="form-receta_similares" class="form-section">
            <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>
            <div class="disclaimer-notice">
                *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
            </div>
            <div class="payment-notice">
                *PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*
            </div>
            <h2>üíä Receta M√©dica Similares</h2>
            <div class="input-group">
                <h2>üë§ Datos del Paciente</h2>
                <label for="nombrePacienteSimilares">Nombre del Paciente:</label>
                <input type="text" id="nombrePacienteSimilares" placeholder="Nombre completo del paciente" required>
            </div>
            <div class="input-group">
                <h2>üìù Datos de la Receta</h2>
                <label for="fechaRecetaSimilares">Fecha de la Receta:</label>
                <input type="date" id="fechaRecetaSimilares" required>
                
                <label for="diagnosticoRecetaSimilares">Diagn√≥stico (Ej: Rinitis Al√©rgica):</label>
                <input type="text" id="diagnosticoRecetaSimilares" placeholder="Diagn√≥stico m√©dico" required>

                <label for="medicamentoSimilares">Medicamento, Dosis y V√≠a de Administraci√≥n:</label>
                <textarea id="medicamentoSimilares" placeholder="Ej: Fexofenadina 180mg - Tomar 1 tableta cada 24 horas por 10 d√≠as." required></textarea>
                
                <label for="indicacionesRecetaSimilares">Indicaciones Adicionales:</label>
                <textarea id="indicacionesRecetaSimilares" placeholder="Ej: Acudir a cita de revisi√≥n en 15 d√≠as." required></textarea>

                <label for="proximaCitaSimilares">Pr√≥xima Cita (Ej: 2024-10-30):</label>
                <input type="date" id="proximaCitaSimilares">
            </div>
            <button class="btn-action" onclick="saveSolicitud('receta_similares')">üíæ Guardar Solicitud (Esperar Aprobaci√≥n)</button>
        </div>

        <div id="form-certificado_medico_imss" class="form-section">
            <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>
            <div class="disclaimer-notice">
                *NO SE GARANTIZA NI SE RESPALDA EL DOCUMENTO, TODO ES BAJO SU PROPIA RESPONSABILIDAD*
            </div>
            <div class="payment-notice">
                *PARA CONTINUAR CON EL PAGO ENVIA MENSAJE AL WHATSAPP*
            </div>
            <h2>ü©∫ Certificado M√©dico IMSS</h2>
            <div class="input-group">
                <h2>üë§ Datos del Paciente</h2>
                <label for="cmiNombrePaciente">‚úÖ Nombre del paciente:</label>
                <input type="text" id="cmiNombrePaciente" placeholder="CARMEN MORELOS HERNANDEZ" required>
                
                <div class="date-container">
                    <div>
                        <label for="cmiNss">‚úÖ NSS (o NSS IMSS):</label>
                        <input type="text" id="cmiNss" placeholder="1715990626-4" required>
                    </div>
                    <div>
                        <label for="cmiEdad">‚úÖ Edad:</label>
                        <input type="text" id="cmiEdad" placeholder="30 a√±os" required>
                    </div>
                </div>
                
                <label for="cmiFechaNac">‚úÖ Fecha de nacimiento:</label>
                <input type="date" id="cmiFechaNac" required>

                <div class="date-container">
                    <div>
                        <label for="cmiPeso">‚úÖ Peso (Ej: 90 kg):</label>
                        <input type="text" id="cmiPeso" placeholder="90 kg" required>
                    </div>
                    <div>
                        <label for="cmiTalla">‚úÖ Talla (Ej: 1.65 mts):</label>
                        <input type="text" id="cmiTalla" placeholder="1.65 mts" required>
                    </div>
                </div>
                
                <label for="cmiDireccion">‚úÖ Direcci√≥n:</label>
                <input type="text" id="cmiDireccion" placeholder="Direcci√≥n completa del paciente" required>
            </div>

            <div class="input-group">
                <h2>üè• Datos de la Unidad M√©dica</h2>
                <div class="date-container">
                    <div>
                        <label for="cmiUmfNo">‚úÖ UMF no.:</label>
                        <input type="text" id="cmiUmfNo" placeholder="No. 99" required>
                    </div>
                    <div>
                        <label for="cmiFechaEmision">‚úÖ Fecha de emisi√≥n:</label>
                        <input type="date" id="cmiFechaEmision" required>
                    </div>
                </div>
                
                <label for="cmiDoctor">M√©dico que Certifica (Ej: Dr. Yessica Mejia Carranza C.P. 5866652):</label>
                <input type="text" id="cmiDoctor" placeholder="M√©dico Yessica Mejia Carranza C.P. 5866652" required>
                
                <label for="cmiConclusion">Conclusi√≥n M√©dica (Apto/No apto):</label>
                <textarea id="cmiConclusion">El paciente se encuentra en buenas condiciones de salud general, sin signos de enfermedades infecciosas o cuadro agudo que comprometan su bienestar en la actualidad. Es apta para realizar actividades f√≠sicas sin restricciones.</textarea>
            </div>

            <button class="btn-action" onclick="saveSolicitud('certificado_medico_imss')">üíæ Guardar Solicitud (Esperar Aprobaci√≥n)</button>
        </div>
        <div id="status-section" class="form-section">
            <button class="back-button" onclick="showForm('menu')">‚Üê Volver al Men√∫</button>
            <h2>Estatus de Solicitudes</h2>
            <div id="solicitud-list">
                </div>
            <p id="no-solicitudes" style="text-align: center; color: #7f8c8d; margin-top: 20px;">No hay solicitudes guardadas.</p>
        </div>
    </div>

    <div id="footer">
        <span>¬© 2024 Generador de Documentos.</span>
        <a href="https://wa.me/XXXXXXXXXX" target="_blank" class="whatsapp-link">
            <i class="fab fa-whatsapp"></i> Contactar
        </a>
    </div>

    <script>
        const { jsPDF } = window.jspdf;
        const solicitudesKey = 'documentSolicitudes';
        const currentUser = { id: 'user_temp_001', name: 'Usuario Invitado' }; // Usuario temporal para almacenamiento local

        const viewIdMap = {
            'menu': 'menu-section',
            'receta_similares': 'form-receta_similares',
            'certificado_medico_imss': 'form-certificado_medico_imss',
            'status': 'status-section'
        };

        function showForm(viewName) {
            // Oculta todas las secciones
            document.querySelectorAll('#app-container > div').forEach(section => {
                section.style.display = 'none';
            });
            // Muestra la secci√≥n solicitada
            const sectionId = viewIdMap[viewName];
            if (sectionId) {
                document.getElementById(sectionId).style.display = 'block';
                if (viewName === 'status') {
                    loadSolicitudes();
                }
            }
        }

        // --- FUNCION AUXILIAR PARA TEXTO JUSTIFICADO ---
        // Funci√≥n auxiliar para texto justificado y multil√≠nea
        function drawJustifiedText(doc, text, x, y, maxWidth, lineHeight) {
            const lines = doc.splitTextToSize(text, maxWidth);
            for (let i = 0; i < lines.length; i++) {
                doc.text(lines[i], x, y);
                y += lineHeight;
            }
            return y;
        }


        // --- FUNCION GENERAR PDF RECETA SIMILARES ---
        async function generarPDFRecetaSimilares(descargar = true) {
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 15;
            let y = 15;
            const lineHeight = 5;

            // Recuperar datos
            const nombreP = (document.getElementById('nombrePacienteSimilares').value || 'PACIENTE').toUpperCase();
            const fechaReceta = document.getElementById('fechaRecetaSimilares').value;
            const diagnostico = document.getElementById('diagnosticoRecetaSimilares').value || 'SIN DIAGN√ìSTICO';
            const medicamento = document.getElementById('medicamentoSimilares').value || 'SIN MEDICAMENTO';
            const indicaciones = document.getElementById('indicacionesRecetaSimilares').value || 'SIN INDICACIONES ADICIONALES';
            const proxima = document.getElementById('proximaCitaSimilares').value || 'NO APLICA';
            
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text('RECETA M√âDICA - FARMACIAS SIMILARES', pageWidth / 2, y, { align: 'center' });
            y += 10;
            
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Fecha: ${fechaReceta}`, pageWidth - margin, y, { align: 'right' });
            y += 5;
            
            // Datos del Paciente
            doc.setDrawColor(52, 73, 94);
            doc.setLineWidth(0.5);
            doc.line(margin, y, pageWidth - margin, y);
            y += 4;
            doc.setFont(undefined, 'bold');
            doc.text('PACIENTE:', margin, y);
            doc.setFont(undefined, 'normal');
            doc.text(nombreP, margin + 25, y);
            y += 5;

            // Diagn√≥stico
            doc.setFont(undefined, 'bold');
            doc.text('DIAGN√ìSTICO:', margin, y);
            doc.setFont(undefined, 'normal');
            doc.text(diagnostico.toUpperCase(), margin + 30, y);
            y += 8;

            // Medicamento/Indicaciones
            doc.setLineWidth(0.5);
            doc.line(margin, y, pageWidth - margin, y);
            y += 4;
            doc.setFont(undefined, 'bold');
            doc.text('Rx. (Prescripci√≥n)', margin, y);
            y += 5;

            doc.setFont(undefined, 'normal');
            y = drawJustifiedText(doc, medicamento, margin, y, pageWidth - margin * 2, lineHeight);
            y += 8;

            // Indicaciones
            doc.setLineWidth(0.5);
            doc.line(margin, y, pageWidth - margin, y);
            y += 4;
            doc.setFont(undefined, 'bold');
            doc.text('INDICACIONES ADICIONALES:', margin, y);
            y += 5;

            doc.setFont(undefined, 'normal');
            y = drawJustifiedText(doc, indicaciones, margin, y, pageWidth - margin * 2, lineHeight);
            y += 8;


            // Pr√≥xima Cita y Firma
            doc.setLineWidth(0.5);
            doc.line(margin, y, pageWidth - margin, y);
            y += 4;
            doc.setFont(undefined, 'bold');
            doc.text('PR√ìXIMA CITA:', margin, y);
            doc.setFont(undefined, 'normal');
            doc.text(proxima, margin + 30, y);
            y += 12;

            // L√≠nea para firma
            const firmaX = pageWidth - margin - 60;
            doc.setLineWidth(0.4);
            doc.line(firmaX, y, firmaX + 50, y);
            doc.setFont(undefined, 'normal');
            doc.text('COPIA', firmaX - 30, y);
            doc.setFont(undefined, 'bold');
            doc.text('FIRMA:', firmaX, y + 4);

            y += 18;

            // L√≠nea punteada inferior (para corte)
            const dashY = doc.internal.pageSize.getHeight() - 28;
            const dashStartX = margin;
            const dashEndX = pageWidth - margin;
            const dashLen = 3;
            const gapLen = 3;
            let cursor = dashStartX;
            doc.setDrawColor(0);
            doc.setLineWidth(0.4);
            while (cursor < dashEndX) {
                doc.line(cursor, dashY, Math.min(cursor + dashLen, dashEndX), dashY);
                cursor += dashLen + gapLen;
            }

            if (descargar) {
                const safeName = (nombreP || 'PACIENTE').replace(/\s+/g, '_');
                doc.save(`Receta_Similares_${safeName}.pdf`);
                return true;
            } else {
                return doc.output('datauristring').split(',')[1];
            }
        }
        
        
        // --- FUNCION GENERAR PDF CERTIFICADO MEDICO IMSS (NUEVA) ---
        async function generarPDFCertificadoIMSS(descargar = true) {
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 15;
            let y = 15;
            const lineHeight = 5;

            // Recuperar datos del formulario
            const nombreP = (document.getElementById('cmiNombrePaciente').value || '').toUpperCase();
            const nss = (document.getElementById('cmiNss').value || '');
            const edad = (document.getElementById('cmiEdad').value || '');
            const fechaNacVal = document.getElementById('cmiFechaNac').value;
            const fechaNac = fechaNacVal ? new Date(fechaNacVal + 'T12:00:00').toLocaleDateString('es-MX', { day: '2-digit', month: '2-digit', year: 'numeric' }) : 'N/A';
            const peso = (document.getElementById('cmiPeso').value || '').toUpperCase();
            const talla = (document.getElementById('cmiTalla').value || '').toUpperCase();
            const direccion = (document.getElementById('cmiDireccion').value || '').toUpperCase();
            const umfNo = (document.getElementById('cmiUmfNo').value || '').toUpperCase();
            const fechaEmisionVal = document.getElementById('cmiFechaEmision').value;
            const fechaEmision = fechaEmisionVal ? new Date(fechaEmisionVal).toLocaleDateString('es-MX', { day: '2-digit', month: 'long', year: 'numeric' }) : 'N/A';
            const doctor = (document.getElementById('cmiDoctor').value || 'M√âDICO EN TURNO').toUpperCase();
            const conclusion = document.getElementById('cmiConclusion').value || 'Sin conclusi√≥n.';

            // --- ENCABEZADO IMSS ---
            // (Colocar Logo IMSS aqu√≠ si se tiene el dataURL)
            doc.setFontSize(24);
            doc.setFont(undefined, 'bold');
            doc.text('IMSS', margin + 35, y + 10);
            y += 20;

            // 2. T√≠tulos
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text('INSTITUTO MEXICANO DEL SEGURO SOCIAL', pageWidth / 2, y, { align: 'center' });
            y += 4;
            doc.text('DIRECCI√ìN DE PRESTACIONES M√âDICAS', pageWidth / 2, y, { align: 'center' });
            y += 4;
            doc.text('UNIDAD MEDICA FAMILIAR NO. ' + umfNo, pageWidth / 2, y, { align: 'center' });
            y += 4;
            doc.text('DELEGACI√ìN ESTADO DE M√âXICO', pageWidth / 2, y, { align: 'center' });
            y += 8;

            // 3. T√≠tulo del Documento
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('CERTIFICADO M√âDICO', pageWidth / 2, y, { align: 'center' });
            y += 10;

            // 4. Asunto y N√∫mero de Certificado
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('ASUNTO: CERTIFICADO MEDICO', pageWidth - margin, y, { align: 'right' });
            y += 4;
            doc.setFont(undefined, 'normal');
            // N√∫mero simulado
            doc.text(`I.Num.09.86.29/3409/171/F-009`, pageWidth - margin, y, { align: 'right' });
            y += 8;

            // 5. Cuerpo del Certificado
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            const cuerpoTexto = `Por medio del presente el que M√©dico ${doctor} con n√∫mero de seguro social: ${nss} hago constar que el paciente
${nombreP} de ${edad} de edad:`;
            y = drawJustifiedText(doc, cuerpoTexto, margin, y, pageWidth - margin * 2, lineHeight);
            y += 8;

            // 6. Antecedentes M√©dicos (Simulado, basado en el formato IMSS)
            doc.setFont(undefined, 'bold');
            doc.text('Antecedentes M√©dicos:', margin, y);
            y += lineHeight;
            doc.setFont(undefined, 'normal');
            doc.text('- Alergias: No presenta alergias de ning√∫n tipo.', margin, y);
            y += lineHeight;
            doc.text('- Cirug√≠as: No ha sido sometida a intervenciones quir√∫rgicas.', margin, y);
            y += lineHeight;
            doc.text('- Enfermedades Cr√≥nicas: Ninguna.', margin, y);
            y += lineHeight;
            doc.text('- Vacunas: Esquema de vacunaci√≥n al d√≠a conforme a las normativas vigentes.', margin, y);
            y += 8;

            // 7. Examen F√≠sico General
            doc.setFont(undefined, 'bold');
            doc.text('Examen F√≠sico General:', margin, y);
            y += lineHeight;
            doc.setFont(undefined, 'normal');
            
            const examFields = [
                `‚Ä¢ Peso: ${peso}`,
                `‚Ä¢ Frecuencia Cardiaca: 75 lpm`,
                `‚Ä¢ Frecuencia Respiratoria: 16 rpm`,
                `‚Ä¢ Tipo de sangre: O+`,
                `‚Ä¢ Talla: ${talla}`,
                `‚Ä¢ Tensi√≥n Arterial: 110/75 mmHg`,
                `‚Ä¢ Temperatura corporal: 36.7 ¬∞C`,
            ];
            
            // Organizar en dos columnas
            const colWidth = (pageWidth - margin * 2) / 2;
            let yExam = y;
            for (let i = 0; i < examFields.length; i++) {
                const xPos = margin + (i % 2) * colWidth;
                doc.text(examFields[i], xPos, yExam);
                if (i % 2 !== 0 || i === examFields.length - 1) {
                    yExam += lineHeight;
                }
            }
            y = yExam + 4;


            // 8. Sistemas (Simulado)
            doc.setFont(undefined, 'bold');
            doc.text('Sistema Respiratorio:', margin, y);
            y += lineHeight;
            doc.setFont(undefined, 'normal');
            doc.text('- Pulmones: Sin murmullo vesicular presente, sin ruidos agregados.', margin, y);
            y += lineHeight + 2;

            doc.setFont(undefined, 'bold');
            doc.text('Sistema Cardiovascular:', margin, y);
            y += lineHeight;
            doc.setFont(undefined, 'normal');
            doc.text('- Coraz√≥n: R√≠tmico, sin soplos ni ruidos patol√≥gicos.', margin, y);
            y += lineHeight + 2;

            doc.setFont(undefined, 'bold');
            doc.text('Sistema Digestivo:', margin, y);
            y += lineHeight;
            doc.setFont(undefined, 'normal');
            doc.text('- Abdomen: Blando, depresible, sin dolor a la palpaci√≥n.', margin, y);
            y += lineHeight + 2;

            doc.setFont(undefined, 'bold');
            doc.text('Sistema Neurol√≥gico:', margin, y);
            y += lineHeight;
            doc.setFont(undefined, 'normal');
            doc.text('- Reflejos: Conservados.', margin, y);
            y += lineHeight;
            doc.text('- Conciencia: Orientada en tiempo, espacio y persona.', margin, y);
            y += lineHeight + 2;

            doc.setFont(undefined, 'bold');
            doc.text('Sistema Osteomuscular:', margin, y);
            y += lineHeight;
            doc.setFont(undefined, 'normal');
            doc.text('- Columna: Sin desviaciones, postura adecuada.', margin, y);
            y += lineHeight;
            doc.text('- Extremidades: Con mucha fuerza y movilidad.', margin, y);
            y += lineHeight + 2;

            doc.setFont(undefined, 'bold');
            doc.text('Examen de la Vista:', margin, y);
            y += lineHeight;
            doc.setFont(undefined, 'normal');
            doc.text('- Agudeza Visual: 20/20 en ambos ojos sin correcci√≥n.', margin, y);
            y += lineHeight;
            doc.text('- Visi√≥n de Colores: Normal, sin evidencia de daltonismo.', margin, y);
            y += lineHeight;
            doc.text('- Campo Visual: Conservado en ambos ojos.', margin, y);
            y += lineHeight;
            doc.text('- Reflejo Pupilar: Reactivo a la luz, sin anormalidades.', margin, y);
            y += lineHeight + 4;

            // 9. Conclusi√≥n
            doc.setFont(undefined, 'bold');
            doc.text('Conclusi√≥n:', margin, y);
            y += lineHeight;
            doc.setFont(undefined, 'normal');
            y = drawJustifiedText(doc, conclusion, margin, y, pageWidth - margin * 2, lineHeight);
            y += 15;

            // 10. Firma del M√©dico (Simulado)
            const firmaX = margin;
            doc.setLineWidth(0.4);
            doc.line(firmaX, y, firmaX + 80, y);
            y += 4;
            doc.setFontSize(8);
            doc.setFont(undefined, 'bold');
            doc.text('DR. (A) YESSICA MEJIA CARRANZA CP. 5866652', firmaX, y);
            y += 3;
            doc.text('Medicina Familiar. Consultorio: 6 Turno: Vespertino.', firmaX, y);
            y += 3;
            doc.setFont(undefined, 'normal');
            
            // Formatear fecha de emisi√≥n para el pie de p√°gina
            let dateParts = fechaEmision.split(' de ');
            let day = dateParts[0];
            let month = dateParts[1];
            let year = dateParts[2];
            
            doc.text(`A ${day} d√≠as del mes de ${month} del a√±o ${year}.`, pageWidth - margin, y, { align: 'right' });


            if (descargar) {
                const safeName = (nombreP || 'PACIENTE').replace(/\s+/g, '_');
                doc.save(`Certificado_IMSS_${safeName}.pdf`);
                return true;
            } else {
                return doc.output('datauristring').split(',')[1];
            }
        }
        // --- FIN FUNCION GENERAR PDF CERTIFICADO MEDICO IMSS ---

        // --- MANEJO DE SOLICITUDES ---

        function getSolicitudes() {
            const stored = localStorage.getItem(solicitudesKey);
            return stored ? JSON.parse(stored) : [];
        }

        function setSolicitudes(solicitudes) {
            localStorage.setItem(solicitudesKey, JSON.stringify(solicitudes));
        }

        async function saveSolicitud(tipoCarta) {
            let nombreSolicitante = '';
            let pdfBase64 = '';
            let nombreAsunto = '';

            if (tipoCarta === 'receta_similares') {
                nombreSolicitante = document.getElementById('nombrePacienteSimilares').value || 'Paciente';
                nombreAsunto = nombreSolicitante;
                pdfBase64 = await generarPDFRecetaSimilares(false);
            } else if (tipoCarta === 'certificado_medico_imss') { // <--- CASO A√ëADIDO
                nombreSolicitante = document.getElementById('cmiNombrePaciente').value || 'Paciente IMSS';
                nombreAsunto = `CERTIFICADO MEDICO - ${nombreSolicitante}`;
                pdfBase64 = await generarPDFCertificadoIMSS(false);
            } else {
                nombreSolicitante = currentUser.name;
                nombreAsunto = 'Documento Desconocido';
                // Puedes a√±adir un placeholder PDF para otros tipos
            }

            const nuevaSolicitud = {
                id: Date.now().toString(),
                userId: currentUser.id,
                tipo: tipoCarta,
                asunto: nombreAsunto,
                fecha: new Date().toLocaleDateString('es-MX'),
                estatus: 'Pendiente', // 'Pendiente', 'Aprobado', 'Rechazado'
                pdfBase64: pdfBase64
            };

            const solicitudes = getSolicitudes();
            solicitudes.push(nuevaSolicitud);
            setSolicitudes(solicitudes);

            alert(`Solicitud para "${nombreAsunto}" guardada exitosamente. Por favor, contacta por WhatsApp para la aprobaci√≥n.`);
            showForm('menu');
        }

        function loadSolicitudes() {
            const lista = document.getElementById('solicitud-list');
            const noSolicitudes = document.getElementById('no-solicitudes');
            lista.innerHTML = '';
            
            // Filtra solo las solicitudes del usuario actual (en este caso, 'user_temp_001')
            const solicitudes = getSolicitudes().filter(s => s.userId === currentUser.id);

            if (solicitudes.length === 0) {
                noSolicitudes.style.display = 'block';
                return;
            }
            noSolicitudes.style.display = 'none';

            solicitudes.forEach(solicitud => {
                const estatusClass = `status-${solicitud.estatus.toLowerCase()}`;
                
                const item = document.createElement('div');
                item.className = 'status-item';
                item.innerHTML = `
                    <div class="status-header" onclick="toggleDetails(this)">
                        <strong>${solicitud.asunto}</strong>
                        <span class="status-badge ${estatusClass}">${solicitud.estatus}</span>
                    </div>
                    <div class="status-details">
                        <p><strong>Tipo:</strong> ${solicitud.tipo.replace('_', ' ').toUpperCase()}</p>
                        <p><strong>Fecha:</strong> ${solicitud.fecha}</p>
                        <p><strong>Detalles:</strong> ${solicitud.estatus === 'Pendiente' ? 'Esperando aprobaci√≥n. Contactar por WhatsApp.' : solicitud.estatus === 'Rechazado' ? 'Rechazado. Contactar por WhatsApp para detalles.' : 'Documento aprobado. Puede descargarlo.'}</p>
                        <button class="btn-action" style="background-color: #3498db; width: auto;" onclick="downloadPDF('${solicitud.id}', '${solicitud.tipo}')" ${solicitud.estatus !== 'Aprobado' ? 'disabled' : ''}>
                            <i class="fas fa-download"></i> Descargar ${solicitud.estatus !== 'Aprobado' ? '(No Aprobado)' : ''}
                        </button>
                    </div>
                `;
                lista.appendChild(item);
            });
        }

        function toggleDetails(element) {
            const details = element.nextElementSibling;
            if (details.style.display === 'block') {
                details.style.display = 'none';
            } else {
                details.style.display = 'block';
            }
        }

        function downloadPDF(id, tipo) {
            const solicitudes = getSolicitudes();
            const solicitud = solicitudes.find(s => s.id === id);

            if (solicitud && solicitud.estatus === 'Aprobado') {
                const link = document.createElement('a');
                link.href = `data:application/pdf;base64,${solicitud.pdfBase64}`;
                link.download = `${solicitud.asunto.replace(/\s/g, '_')}_${id}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else if (solicitud) {
                alert(`El documento ${solicitud.asunto} no ha sido aprobado. Por favor, contacta al administrador.`);
            } else {
                alert('Documento no encontrado.');
            }
        }

        // Inicializar la vista
        document.addEventListener('DOMContentLoaded', () => {
            showForm('menu');
        });
    </script>
</body>
</html>
